<!DOCTYPE html>
<html lang="en">

<head>
    <style>a {
  color: #fff;
  padding: 5px;
  transition: all .5s;

  &:hover {
    color: #d0ff00;
    text-decoration: underline;
  }
}

#canvas {
  z-index: 10;
  pointer-events: none;
  width: 100%;
  height: 100%;
  position: fixed;
  top: 0;
  left: 0;
}

#soulImage {
  z-index: 10;
  pointer-events: none;
  user-select: none;
  width: 20px;
  height: 20px;
  image-rendering: pixelated;
  transition: transform 10ms linear;
  position: absolute;
  top: 0;
  left: 0;
}

.button {
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%)translateY(-50%);

  &[style*="opacity: 0"] {
    pointer-events: none !important;
  }
}

.backButton {
  &[style*="opacity: 0"] {
    pointer-events: none !important;
  }
}

.container {
  z-index: 1;
  background-image: url("/t/gh8sted.be/./imgs/coolbggrid.png");
  background-position: 0 0;
  background-repeat: repeat;
  background-size: 200px 200px;
  width: 250px;
  height: 250px;
  transition: transform 5s linear;
  animation: 4s linear infinite moveGrid;
  position: absolute !important;
}

.containerHueRotate {
  filter: hue-rotate(90deg);
  transition: filter 2s !important;
}

.soulHueRotate {
  filter: hue-rotate(180deg);
  transition: filter 2s !important;
}
</style>
    <style>:root {
  background-color: #111;
}

.tile-body {
  background-color: #111;
  margin: 0;
  padding: 0;
}

@font-face {
  font-family: DeterminationMono;
  src: url("/t/gh8sted.be/font/DTM-MONO.OTF") format("opentype");
}

* {
  color: #fff;
  font-family: DeterminationMono, sans-serif;
  text-decoration: none;
}

.text {
  font-size: 15px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-70%, -35%);
}

.greytext {
  color: #272727;
  font-size: 7px;
  position: absolute;
}

.container {
  z-index: 1;
  background-image: url("/t/gh8sted.be/./imgs/coolbggrid.png");
  background-position: 0 0;
  background-repeat: repeat;
  background-size: 200px 200px;
  width: 250px;
  height: 250px;
  animation: 4s linear infinite moveGrid;
  position: absolute !important;
}

.buttons {
  flex-direction: column;
  justify-content: center;
  align-self: flex-end;
  align-items: flex-end;
  gap: 10px;
  display: flex;
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(10%)translateY(-30%);
}

.button {
  color: #fff;
  background-color: #000;
  border: 2px solid #fff;
  padding: 5px 10px;
  transition: all .5s;

  &:hover {
    cursor: pointer;
    color: #d0ff00;
    border: 2px solid #d0ff00;

    & a {
      color: #d0ff00;
      transition: all .5s;
    }
  }
}

@keyframes moveGrid {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 200px 200px;
  }
}

img {
  image-rendering: auto;
  max-width: 100%;
  height: 100%;
  margin: 0 auto;
  display: block;
}
</style>
</head>

<body id="body">
    <div class="container">
        <a href="/t/gh8sted.be/index.html" class="backButton">Back</a>
        <canvas id="canvas"></canvas>
        <img id="soulImage" src="/t/gh8sted.be/fightPage/imgs/RedSoul.png">

        <button class="button">Start</button>
    </div>

    <div id="audio">
        <div class="bossMusic1">
            <audio src="/t/gh8sted.be/fightPage/music/Shadow Weapon1.mp3" class="BossMusic" preload="metadata"></audio>
        </div>
        <div class="bossMusic2">
            <audio src="/t/gh8sted.be/fightPage/music/Shadow Weapon2.mp3" class="BossMusic" preload="metadata"></audio>
        </div>
        <div class="bossMusic3">
            <audio src="/t/gh8sted.be/fightPage/music/Shadow Weapon3.mp3" class="BossMusic" preload="metadata"></audio>
        </div>
    </div>

    <div id="sfx">
        <audio src="/t/gh8sted.be/sfx/riff.ogg" class="riff" preload="metadata"></audio>
        <audio src="/t/gh8sted.be/sfx/normalSelect.mp3" class="normalSelect" preload="metadata"></audio>
        <audio src="/t/gh8sted.be/sfx/moveSelect.mp3" class="moveSelect" preload="metadata"></audio>
    </div>
    
    <script type="text/tilescript">var fightStarted = false;

var body = document.querySelector('body') || document.querySelector('div .container').parentElement;
var soulImage = document.getElementById('soulImage');
var container = document.querySelector('.container');

var button = document.querySelector('.button');
var backButton = document.querySelector('.backButton');

// Constants for optimization (container is always 250x250, soul is 20px)
var CONTAINER_WIDTH = 250;
var CONTAINER_HEIGHT = 250;
var SOUL_OFFSET = 10; // Half of 20px soul size

// Get all audio elements (they're already preloaded)
var bossMusicElements = document.querySelectorAll('audio');
var bossMusic1 = bossMusicElements[0];
var bossMusic2 = bossMusicElements[1];
var bossMusic3 = bossMusicElements[2];

// Array of all audio elements
var musicTracks = [bossMusic1, bossMusic2, bossMusic3];
var currentTrackIndex = -1;
var currentTrack = null;
var transitionTime = 0.25; // Start next track 0.15 seconds before current ends


function playNextTrack() {
    var nextIndex;
    if (currentTrackIndex >= musicTracks.length - 1) {
        nextIndex = 0; // Loop back to start
    } else {
        nextIndex = currentTrackIndex + 1;
    }
    
    var nextTrack = musicTracks[nextIndex];
    
    // If there's a current track, stop it and remove its timeupdate listener
    if (currentTrack) {
        currentTrack.removeEventListener('timeupdate', checkTimeUpdate);
        currentTrack.pause();
        currentTrack.currentTime = 0;
    }
    
    // Start the next track
    nextTrack.currentTime = 0;
    nextTrack.play();
    
    // Set up timeupdate listener for seamless transition
    nextTrack.addEventListener('timeupdate', checkTimeUpdate);
    
    currentTrack = nextTrack;
    currentTrackIndex = nextIndex;
}

function checkTimeUpdate() {
    if (!currentTrack) return;
    
    // Check if we're within transitionTime seconds of the end
    var timeRemaining = currentTrack.duration - currentTrack.currentTime;
    
    if (timeRemaining <= transitionTime && timeRemaining > 0) {
        // Remove this listener to prevent multiple triggers
        currentTrack.removeEventListener('timeupdate', checkTimeUpdate);
        
        // Start the next track immediately for seamless transition
        playNextTrack();
    }
}

body.addEventListener('mousemove', function(event) {
    // This transform calculation ensures the soul image follows the mouse cursor accurately regardless of browser zoom level or CSS scale() transforms applied by the parent plot div.
    // The calculation works by: (1) Getting the container's bounding rect which accounts for all transforms and zoom applied to it,
    // (2) Calculating the scale factor by dividing the rendered width/height by the actual CSS dimensions (250x250), which tells us
    // how much the container has been scaled (e.g., if rendered width is 500px and CSS width is 250px, scale is 2.0),
    // (3) Taking the mouse position in viewport coordinates (event.clientX/clientY) and subtracting the container's position in viewport
    // space (rect.left/rect.top) to get the mouse position relative to the container's top-left corner in viewport/scaled space,
    // (4) Dividing by the scale factor to convert from viewport/scaled coordinates to the container's local/unscaled coordinate system
    // (where the container is always 250x250 regardless of how it's rendered), and (5) Subtracting the soul offset (10px, which is half
    // of the 20px soul image size) to center the soul on the cursor. The result is applied as a CSS transform in the container's
    // coordinate system, which ensures the soul follows the mouse perfectly even when the plot div scales the entire tile or the browser
    // zooms in/out, because we're always working in the container's consistent 250x250 coordinate space and converting mouse coordinates
    // from the variable viewport space to that consistent local space.
    soulImage.style.transform = 'translateX(' + (((event.clientX - container.getBoundingClientRect().left) / (container.getBoundingClientRect().width / CONTAINER_WIDTH)) - SOUL_OFFSET) + 'px) translateY(' + (((event.clientY - container.getBoundingClientRect().top) / (container.getBoundingClientRect().height / CONTAINER_HEIGHT)) - SOUL_OFFSET) + 'px)';
});

button.addEventListener('click', function() {
    if (fightStarted) return;
    fightStarted = true;
    
    console.warn(function() {return console.log(container)}.native);
    console.log(soulImage);
    container.classList.toggle("containerHueRotate");
    soulImage.classList.toggle("soulHueRotate");

    
    button.style.opacity = 0;
    backButton.style.opacity = 0;

    // Start playing the first track
    playNextTrack();

   // button.style.display = 'none';
});</script>
    <script type="text/tilescript">var body = document.querySelector('body') || document.querySelector('div .container').parentElement;

var audio = document.querySelector('.riff');
var normalSelect = document.querySelector('.normalSelect');
var moveSelect = document.querySelector('.moveSelect');

var buttons = document.querySelectorAll('.button');
var anchor = document.querySelector('.backButton');


buttons.forEach(function (button) {
    var anchor = button.querySelector('a');
    var targetHref = anchor ? anchor.href : null;
    
    // Handle button clicks (includes clicks on anchor due to bubbling)
    button.addEventListener('click', function (e) {
        e.preventDefault();
        
        if (targetHref !== null) {
            normalSelect.play();
            normalSelect.currentTime = 0.2;

            setTimeout(function () {
                window.location.href = targetHref;
            }, 400);
        }
    });
    
    // Also prevent default on anchor clicks directly (in case bubbling doesn't work)
    if (anchor) {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
        });
    }
    
    button.addEventListener('mouseenter', function () {
        moveSelect.currentTime = 0;
        moveSelect.play();
    });
});

if (anchor) {
    anchor.addEventListener('mouseenter', function () {
        moveSelect.currentTime = 0;
        moveSelect.play();
    });

    anchor.addEventListener('click', function (e) {
        e.preventDefault();

        normalSelect.play();
        normalSelect.currentTime = 0.2;

        setTimeout(function () {
            window.location.href = anchor.href;
        }, 400);
    });
}


audio.volume = 0;
//audio.play();

//console.log(body);

body.addEventListener('mouseenter', function (event) {
    /*console.log(event);
    console.log("entered");*/
    audio.currentTime = 0;
    //audio.play();
});

/*body.addEventListener('mouseleave', function (event) {
    console.log(event);
    console.log("left");
    //audio.pause();
});*/</script>
</body>

</html>