<!DOCTYPE html>
<html lang="en">
<head>
    <style>@font-face {
  font-family: Inter;
  src: url("assets/InterVariable.woff2") format("woff2");
  font-weight: 100 900;
  font-display: swap;
}

@font-face {
  font-family: Material Symbols;
  src: url("assets/MaterialSymbols.woff2") format("woff2");
  font-display: block;
}

* {
  box-sizing: border-box;
  overflow-wrap: anywhere;
  max-width: 100%;
  margin: 0;
  padding: 0;
  font-family: Inter, system-ui, -apple-system, sans-serif;
}

.tile-body {
  & > * {
    z-index: 5;
    position: relative;
  }

  & #bg {
    z-index: 0;
    opacity: .15;
    width: 100%;
    height: 100%;
    position: fixed;
    inset: 0;
  }

  &:has(#loadingScreen.hideLayout) #bg {
    opacity: .07;
  }
}

input, textarea, button, select, #loginLayout #content #accountType {
  background: #d9d9d9;
  border: none;
  width: 100%;
  margin-block: 6px;
  padding: 6px;
}

#loadingScreen {
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100%;
  display: flex;

  & > * {
    text-align: center;
    z-index: 3;
  }

  & img {
    width: 200px;
  }

  & .bottom {
    font-size: .8em;
    position: fixed;
    bottom: 0;
  }
}

.emojiImage {
  height: 1em;
}

#mainLayout, #loginLayout, #postLayout, #createLayout, #userProfileLayout, #aboutLayout, #searchLayout {
  & #content {
    height: 220px;
    overflow-y: auto;
  }

  & #topBar {
    background: #d9d9d9;
    justify-content: space-between;
    padding: 6px;
    display: flex;
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
  }

  & #content:not(:has(.contentItem)):not(:has(.notification)) {
    padding: 6px;
  }

  & #content:has(.contentItem), & #content:has(.notification) {
    flex-direction: column;
    gap: 6px;
    padding-block: 6px;
    display: flex;
  }
}

#createLayout #content .topBar {
  display: flex;

  & .actionButtons {
    flex-grow: 1;
    justify-content: space-between;
    display: flex;
  }
}

#createLayout :where(input, textarea) {
  margin-block: 0;
}

#postLayout .notification {
  background: #ededed;
  padding: 6px;
}

#postLayout .childrenPosts {
  flex-direction: column;
  gap: 6px;
  display: flex;
}

#postLayout:has(.instInfo) #content > div {
  flex-direction: column;
  gap: 6px;
  padding: 0;
  display: flex;

  & .instInfo, & .wafTilesInfo {
    background: #ededed;
    padding: 6px;

    & p {
      margin-block: 3px;
    }
  }
}

#postLayout .userProfileInfo .displayName {
  align-items: center;
  gap: 5px;
  display: flex;

  & img {
    aspect-ratio: 1;
    width: 30%;
    max-width: 50px;
    height: 30%;
  }
}

#mainLayout #content .contentItem, #postLayout #content .contentItem, #userProfileLayout #content .contentItem, #createLayout .replyingTo .contentItem {
  background: #ededed;
  padding: 6px;

  & > * {
    margin-block: 4px;
  }

  & .medias:not(:has(small)), & .medias:has(small) > small {
    gap: 5px;
    display: flex;
    overflow-x: scroll;
    flex-direction: row !important;

    & > a {
      flex-shrink: 0;
      position: relative;

      &:has(img[alt][data-media-url][src]) {
        &:before {
          content: "ALT";
          background-color: #ededed;
          padding: 2px 5px;
          position: absolute;
          top: 5px;
          left: 5px;
        }

        &:hover {
          &:before {
            opacity: .5 !important;
          }
        }
      }
    }
  }

  & .userRewoot, & .userInfo, & .wootInfo {
    justify-content: space-between;
    display: flex;
  }

  & .userRewoot, & .userInfo {
    & * {
      text-align: left;
      color: #00f;
      background: none;
      width: fit-content;
      margin: 0;
      padding: 0;
      font-size: 1em;
      text-decoration: underline;
      overflow-wrap: normal !important;

      &:hover {
        color: #483d8b;
      }
    }
  }

  & .wootContent {
    margin-block: 9px;
  }

  & .quotedPost {
    background: #dfd8d8;
    padding: 6px;

    & > .wootContent {
      margin-bottom: 0;
    }
  }
}

#createLayout #content {
  flex-direction: column;
  gap: 6px;
  padding-block: 6px;
  display: flex;
}

#postLayout:has(.userProfileInfo) #content .userProfileInfo {
  padding-inline: 6px;
}

#postLayout:has(.userProfileInfo) #content .extUser {
  background: #d9d9d9;
  margin-block: 6px;
  padding: 6px;
}

#postLayout:has(.userProfileInfo) #content .stats {
  justify-content: space-between;
  display: flex;
}

select, .actionButtons button {
  background: none;
  width: fit-content;
  margin: 0;
  padding: 0;
}

.actionButtons {
  & button, & a {
    margin: 0;
    padding: 0;
    font-size: 1.2em;
    text-decoration: none;
    color: inherit !important;
    font-family: Material Symbols !important;

    &:not(.active):not(:hover) {
      filter: grayscale();
    }
  }
}

.navBtnContainer {
  gap: 6px;
  display: flex;

  & > * {
    flex-grow: 1;
  }
}

.hideLayout {
  display: none !important;
}

button:where([data-user-info], [data-post-info]) {
  text-align: left;
  color: #00f;
  background: none;
  width: fit-content;
  margin: 0;
  padding: 0;
  font-size: 1em;
  text-decoration: underline;
  overflow-wrap: normal !important;

  &:hover {
    color: #483d8b;
  }
}

.postDate {
  overflow-wrap: normal !important;
}

.contentItem :where(.userRewoot, .userInfo) :where(p:first-child button, button:first-child) {
  text-overflow: ellipsis;
  max-width: 170px;
  overflow: hidden;
}
</style>
</head>
<body>
    <img id="bg" src="assets/bgCenter.png">
    <div id="loadingScreen">
        <img src="assets/waftiles.png" alt="WafTiles logo">
        <div id="loadingMessage">
        	To initialize, click the tile.
        </div>
        <p class="bottom">
            using WafTiles v1.0.0a1 - Neofox by Volpeon
        </p>
    </div>
    <div id="loginLayout" class="hideLayout">
        <div id="topBar">
            <p>
                WafTiles
            </p>
            <p>
                
            </p>
        </div>
        <div id="content">
            <p>
                Login to WafTiles
            </p>
            <form id="loginForm" target="_blank" action="#forbidden">
                <select id="accountType">
                    <option value="wafrn">WAFRN account</option>
                    <option value="bluesky">Bluesky/ATProto account (WIP)</option>
                </select>
                <input type="text" id="instance" placeholder="Instance" value="waf.moe" autocomplete="off">
                <input type="text" id="username" placeholder="Email" autocomplete="off">
                <input type="password" id="password" placeholder="Password" autocomplete="off">
                <p id="additionalInfo">
                    
                </p>
                <button type="button" id="loginFormSubmit">
                    Log in
                </button>
            </form>
            <p id="loginError">
                
            </p>
        </div>
    </div>
    <div id="mainLayout" class="hideLayout">
        <div id="topBar">
            <select id="dashboardLevel">
                <option value="1">Dashboard</option>
                <option value="2">Explore WAFRN</option>
                <option value="0">WAFRN &amp; Friends</option>
                <option value="10">Direct Messages</option>
                <option value="20">Search</option>
                <option value="25">Create new woot</option>
            </select>
            <select id="userLevel">
                <option value="1" selected class="userName">jb (waf.moe)</option>
                <option value="5">Notifications</option>
                <option value="2">Log out</option>
                <option value="3">About</option>
                <option value="4">Query ID</option>
            </select>
        </div>
        <div id="content">
            <p id="loading">
                Loading posts...
            </p>
        </div>
    </div>
    <div id="searchLayout" class="hideLayout">
        <div id="topBar">
            <select id="dashboardLevel">
                <option value="1">Dashboard</option>
                <option value="2">Explore WAFRN</option>
                <option value="0">WAFRN &amp; Friends</option>
                <option value="10">Direct Messages</option>
                <option value="20" selected>Search</option>
                <option value="25">Create new woot</option>
            </select>
            <select id="userLevel">
                <option value="1" selected class="userName">jb (waf.moe)</option>
                <option value="5">Notifications</option>
                <option value="2">Log out</option>
                <option value="3">About</option>
                <option value="4">Query ID</option>
            </select>
        </div>
        <div id="content">
            <div class="searchInput">
                <input type="text" id="search" placeholder="Search..." autocomplete="off">
                <button id="searchSubmit">
                    Search
                </button>
            </div>
            <div class="searchResults">
                
            </div>
        </div>
    </div>
    <div id="createLayout" class="hideLayout">
        <div id="topBar">
            <select id="dashboardLevel">
                <option value="1">Dashboard</option>
                <option value="2">Explore WAFRN</option>
                <option value="0">WAFRN &amp; Friends</option>
                <option value="10">Direct Messages</option>
                <option value="20">Search</option>
                <option value="25" selected>Create new woot</option>
            </select>
            <select id="userLevel">
                <option value="1" selected class="userName">jb (waf.moe)</option>
                <option value="5">Notifications</option>
                <option value="2">Log out</option>
                <option value="3">About</option>
                <option value="4">Query ID</option>
            </select>
        </div>
        <div id="content">
            <div class="topBar">
                <select id="postType">
                    <option value="0">Public</option>
                    <option value="3">Unlisted</option>
                    <option value="1">Followers only</option>
                    <option value="2">Instance only</option>
                    <option value="10">DM</option>
                </select>
                <div class="actionButtons">
                    <div>
                        
                    </div>
                    <button id="send">
                        send
                    </button>
                </div>
            </div>
            <input type="text" placeholder="Content Warning (optional)" id="cw" autocomplete="off">
            <textarea placeholder="Woot content" id="textContent" autocomplete="off"></textarea>
            <input type="text" placeholder="Tags (optional, comma seperated)" id="tags" autocomplete="off">
            <div class="replyingTo">
                
            </div>
            <p>
               	Uploading files not supported (for now)
            </p>
            <p>
                Doubts on how to format the text or how to start? Check <a target="_blank" href="https://wafrn.net/faq/user">the guide!</a>
            </p>
        </div>
    </div>
    <div id="postLayout" class="hideLayout">
        <div id="topBar">
            <p>
                &lt; Back
            </p>
            <select id="userLevel">
                <option value="1" selected class="userName">jb (waf.moe)</option>
                <option value="5">Notifications</option>
                <option value="2">Log out</option>
                <option value="3">About</option>
                <option value="4">Query ID</option>
            </select>
        </div>
        <div id="content">
        </div>
    </div>
    <script type="text/tilescript">var loadingScreen = document.getElementById('loadingScreen')
var loginLayout = document.getElementById('loginLayout')
var mainLayout = document.getElementById('mainLayout')
var createLayout = document.getElementById('createLayout')
var postLayout = document.getElementById('postLayout')
var searchLayout = document.getElementById('searchLayout')
var loadingMessage = document.getElementById('loadingMessage')
loadingMessage.textContent = 'Initalizing...'
var userNames = document.querySelectorAll('.userName')
var userNotifs = document.querySelectorAll('.userNotif')
var userName = '@jb@waf.moe'
var userLevels = document.querySelectorAll('#userLevel')
var sessionData = JSON.parse(localStorage.getItem('wafTilesSession') || '{}')
var dashboardCurrentPage
var dashboardLastPostTime
var dashboardNextPostTime
var lastDashboardLevel
var lastNotificationCount = 0
init()

var isModern = !!window.blur

console.log('on modern env?', isModern)

var audio = document.createElement('audio')
audio.style = "display: none;"
document.body.appendChild(audio)
function playSound(soundId) {
    audio.src = '/assets/' + soundId + '.ogg'
    audio.load()
    audio.play()
}

function init() {
    try {
        if (!sessionData.loginData) {
            console.log(sessionData)
            if (!sessionData.instance) {
                sessionData.instance = 'waf.moe'
                fetchXhr(getApiUrl(sessionData.instance) + '/environment', 'GET', function (e, r) {
                    sessionData.instanceEnv = r
                    saveSessionData()
                }, function () { })
            }
            showDashboardLoggedOut()
        } else {
            if (!sessionData.instance) {
                sessionData.instance = 'waf.moe'
            }
            showDashboard()
            setInterval(function () {
                getNotificationCount()
            }, 10000)
        }
    } catch (e) {
        fatalError(e)
    }
}
function fatalError(e) {
    loadingScreen.className = ''
    loginLayout.className = 'hideLayout'
    createLayout.className = 'hideLayout'
    mainLayout.className = 'hideLayout'
    postLayout.className = 'hideLayout'
    loadingMessage.textContent = e ? 'An error occurred. Attempting to reload... (' + e + ')' : 'Reloading...'
    console.error(e)
    setTimeout(function () { location.reload() }, e ? 2500 : 1000)
}
function getNotificationCount() {
    fetchXhr(getApiUrl(sessionData.instance) + '/v2/notificationsCount', 'GET', function (e, r) {
        if (r.notifications > 0) {
            if (lastNotificationCount !== r.notifications) playSound(4)
            userNames.forEach(function (e) {
                e.textContent = userName + ' [' + r.notifications + ']'
            })
            userNotifs.forEach(function (e) {
                e.textContent = 'Notifications [' + r.notifications + ']'
            })
        } else {
            userNames.forEach(function (e) {
                e.textContent = userName
            })
            userNotifs.forEach(function (e) {
                e.textContent = 'Notifications'
            })
        }
        lastNotificationCount = r.notifications
    }, function (e) { }, sessionData.loginData ? sessionData.loginData.token : undefined)
}
function showDashboardLoggedOut() {
    loadingScreen.className = 'hideLayout'
    loginLayout.className = 'hideLayout'
    createLayout.className = 'hideLayout'
    mainLayout.className = ''
    userLevels.forEach(function (e) {
        var p = e.parentElement
        e.remove()
        p.textContent = ''
        var wafTilesThing = document.createElement('p')
        wafTilesThing.textContent = 'WafTiles - waf.moe'
        p.appendChild(wafTilesThing)
        var loginBtn = document.createElement('p')
        loginBtn.textContent = 'Login'
        loginBtn.addEventListener('click', function (e) {
            showLoginForm()
        })
        p.appendChild(loginBtn)
    })
    loadPosts(2)
}
function showLoginForm() {
    loadingScreen.className = 'hideLayout'
    loginLayout.className = ''
    var accountType = document.getElementById('accountType')
    var additionalInfo = document.getElementById('additionalInfo')
    accountType.addEventListener('input', function (f) {
        switch (accountType.value) {
            case 'wafrn': {
                document.getElementById('instance').value = "waf.moe"
                document.getElementById('instance').placeholder = "Instance"
                document.getElementById('username').placeholder = "Email"
                document.getElementById('password').placeholder = "Password"
                additionalInfo.textContent = ''
                break
            }
            case 'bluesky': {
                document.getElementById('instance').value = "bsky.social"
                document.getElementById('instance').placeholder = "PDS Host"
                document.getElementById('username').placeholder = "Handle or DID"
                document.getElementById('password').placeholder = "App Password"
                additionalInfo.textContent = 'Notes: This uses a proxy to load things for you. Due to Webtiles\' limitations, only app passwords are supported. You can get one by going to Bluesky > Settings > Privacy and Security > App Passwords and creating one.'
                break
            }
        }
    })
    var loginFormSubmit = document.getElementById('loginFormSubmit')
    loginFormSubmit.addEventListener('click', function (f) {
        f.preventDefault()
        loginFormSubmit.textContent = 'Logging in...'
        loginFormSubmit.disabled = true
        var instance = document.getElementById('instance').value
        var username = document.getElementById('username').value
        var password = document.getElementById('password').value
        var loginError = document.getElementById('loginError')
        if (!instance || !username || !password) {
            loginError.textContent = 'instance, username, password required'
            loginFormSubmit.textContent = 'Log in'
            loginFormSubmit.disabled = false
            return
        }
        instance = instance.replace('https://', '').replace('/', '')
        sessionData.instance = instance
        switch (accountType.value) {
            case 'wafrn': {
        		loginToWafrn(instance, username, password)
                break
            }
            case 'bluesky': {
                alert('wip')
                break
            }   
        }
    })
}
function loginToWafrn(instance, username, password) {
    fetchXhr(getApiUrl(instance) + '/environment', 'GET', function (e, r) {
            fetchXhr('https://' + instance + '/.well-known/nodeinfo/2.0', 'GET', function (e, r) {
                sessionData.instanceNodeinfo = r
                saveSessionData()
            }, function (e) { })
            sessionData.instanceEnv = r
            saveSessionData()
            fetchXhr(getApiUrl(instance) + '/login', 'POST', function (e, r) {
                if (r.token) {
                    var loginData = decodeToken(r.token)
                    loginData.token = r.token
                    if (r.mfaRequired) {
                        var mfaRendererContainer = document.querySelector('#loginLayout #content')
                        mfaRendererContainer.textContent = ''
                        var template = '<h2>MFA Required</h2><p>Please put here the code given to you via your authenticator app:</p><input type="number" id="mfaCode" min="6" max="6" placeholder="Your authenticator code" ><button id="submitMfa">Log in</button>'
                        appendHtml(template, mfaRendererContainer)
                        loginFormSubmit = document.querySelector('#loginLayout #content #submitMfa')
                        loginFormSubmit.addEventListener('click', function (e) {
                            var code = document.querySelector('#loginLayout #content #mfaCode').value
                            loginFormSubmit.textContent = 'Logging in...'
                            loginFormSubmit.disabled = true
                            fetchXhr(getApiUrl(instance) + '/login/mfa', 'POST', function (e, r) {
                                if (r.token) {
                                    var loginData = decodeToken(r.token)
                                    loginData.token = r.token
                                    sessionData.loginData = loginData
                                    fetchXhr(getApiUrl(instance) + '/user?id=' + loginData.url, 'GET', function (e, r) {
                                        sessionData.currentUser = r
                                        saveSessionData()
                                        location.reload()
                                    }, function (e) {
                                        console.log(e)
                                        loginError.textContent = e
                                        loginFormSubmit.textContent = 'Log in'
                                        loginFormSubmit.disabled = false
                                    }, loginData.token)
                                } else {
                                    loginError.textContent = r.message || 'Login failed'
                                    loginFormSubmit.textContent = 'Log in'
                                    loginFormSubmit.disabled = false
                                }
                            }, function (e) {
                                console.log(e)
                                loginError.textContent = e
                                loginFormSubmit.textContent = 'Log in'
                                loginFormSubmit.disabled = false
                            }, {
                                token: code
                            }, loginData.token)
                        })
                    } else {
                        sessionData.loginData = loginData
                        fetchXhr(getApiUrl(instance) + '/user?id=' + loginData.url, 'GET', function (e, r) {
                            sessionData.currentUser = r
                            saveSessionData()
                            location.reload()
                        }, function (e) {
                            console.log(e)
                            loginError.textContent = e
                            loginFormSubmit.textContent = 'Log in'
                            loginFormSubmit.disabled = false
                        }, loginData.token)
                    }
                } else {
                    loginError.textContent = r.message || 'Login failed'
                    loginFormSubmit.textContent = 'Log in'
                    loginFormSubmit.disabled = false
                }
            }, function (e) {
                console.log(e)
                loginError.textContent = e
                loginFormSubmit.textContent = 'Log in'
                loginFormSubmit.disabled = false
            }, {
                email: username, password: password
            })
        }, function (e) {
            loginError.textContent = "can't login. internet issue or not a wafrn instance or smth, " + e
            loginFormSubmit.textContent = 'Log in'
            loginFormSubmit.disabled = false
        })
}
function queryAndLoadPost(id) {
    document.querySelector('#postLayout #content').textContent = 'Loading unloaded post ' + id + '...'

    fetchXhr(getApiUrl(sessionData.instance) + '/v2/post/' + id, 'GET', function (e, feed) {
        var medias = feed.medias
        var users = feed.users
        var tags = feed.tags
        var quotes = feed.quotes
        var quotedPosts = feed.quotedPosts
        var mentions = feed.mentions
        var asks = feed.asks
        var emojiRelations = feed.emojiRelations
        var posts = feed.posts.sort(function (a, b) {
            return new Date(b.createdAt) - new Date(a.createdAt)
        })
        posts = posts.map(function (x) {
            var y = x
            y.user = users.filter(function (z) {
                return z.id === x.userId
            })[0]
            y.tags = tags.filter(function (z) {
                return z.postId === x.id
            })
            y.medias = medias.filter(function (z) {
                return z.postId === x.id
            })
            y.mentions = mentions.filter(function (z) {
                return z.post === x.id
            }).map(function (m) {
                var n = m
                n.user = users.filter(function (z) {
                    return z.id === m.userMentioned
                })[0]
                return n
            })
            y.quote = quotes.filter(function (n) {
                return n.quoterPostId === x.id
            }).map(function (q) {
                return quotedPosts.filter(function (x) {
                    return q.quotedPostId === x.id
                })[0]
            }).map(function (a) {
                var b = a
                b.user = users.filter(function (z) {
                    return z.id === b.userId
                })[0]
                b.tags = tags.filter(function (z) {
                    return z.postId === b.id
                })
                b.medias = medias.filter(function (z) {
                    return z.postId === b.id
                })
                b.mentions = mentions.filter(function (z) {
                    return z.post === b.id
                }).map(function (m) {
                    var n = m
                    n.user = users.filter(function (z) {
                        return z.id === m.userMentioned
                    })[0]
                    return n
                })
                b.ancestors = []
                b.emojiRelations = emojiRelations.postEmojiReactions.filter(function (z) {
                    return z.postId === b.id
                })
                if (asks) b.ask = asks.filter(function (z) {
                    return z.postId === b.id
                }).map(function (a) {
                    var c = a
                    c.asked = users.filter(function (z) {
                        return z.id === a.userAsked
                    })[0]
                    c.asker = users.filter(function (z) {
                        return z.id === a.userAsker
                    })[0]
                    return c
                })[0]
                return b
            })[0]
            y.emojiRelations = emojiRelations.postEmojiReactions.filter(function (z) {
                return z.postId === x.id
            }).map(function (e) {
                return emojiRelations.emojis.filter(function (f) {
                    return e.emojiId === f.id
                })[0]
            })
            y.emojis = emojiRelations.postEmojiRelation.filter(function (z) {
                return z.postId === x.id
            }).map(function (e) {
                return emojiRelations.emojis.filter(function (f) {
                    return e.emojiId === f.id
                })[0]
            })
            if (asks) y.ask = asks.filter(function (z) {
                return z.postId === x.id
            }).map(function (a) {
                var b = a
                b.asked = users.filter(function (z) {
                    return z.id === a.userAsked
                })[0]
                b.asker = users.filter(function (z) {
                    return z.id === a.userAsker
                })[0]
                return b
            })[0]
            if (y.ancestors) y.ancestors = y.ancestors.sort(function (a, b) {
                return new Date(b.createdAt) - new Date(a.createdAt)
            }).map(function (a) {
                var b = a
                b.user = users.filter(function (z) {
                    return z.id === b.userId
                })[0]
                b.tags = tags.filter(function (z) {
                    return z.postId === b.id
                })
                b.medias = medias.filter(function (z) {
                    return z.postId === b.id
                })
                b.mentions = mentions.filter(function (z) {
                    return z.post === b.id
                }).map(function (m) {
                    var n = m
                    n.user = users.filter(function (z) {
                        return z.id === m.userMentioned
                    })[0]
                    return n
                })
                b.ancestors = []
                b.emojiRelations = emojiRelations.postEmojiReactions.filter(function (z) {
                    return z.postId === b.id
                }).map(function (e) {
                    return emojiRelations.emojis.filter(function (f) {
                        return e.emojiId === f.id
                    })[0]
                })
                b.emojis = emojiRelations.postEmojiRelation.filter(function (z) {
                    return z.postId === b.id
                }).map(function (e) {
                    return emojiRelations.emojis.filter(function (f) {
                        return e.emojiId === f.id
                    })[0]
                })
                if (asks) b.ask = asks.filter(function (z) {
                    return z.postId === b.id
                }).map(function (a) {
                    var c = a
                    c.asked = users.filter(function (z) {
                        return z.id === a.userAsked
                    })[0]
                    c.asker = users.filter(function (z) {
                        return z.id === a.userAsker
                    })[0]
                    return c
                })[0]
                return b
            })
            else y.ancestors = []
            return y
        })
        showPostThread(posts[0])
    }, function (e) { }, sessionData.loginData ? sessionData.loginData.token : undefined)
}
function showNotifications() {
    mainLayout.textContent = ''

    var notifsLayout = document.querySelector('#postLayout #content')
    notifsLayout.textContent = 'Loading notifications...'

    mainLayout.className = 'hideLayout'
    loginLayout.className = 'hideLayout'
    createLayout.className = 'hideLayout'
    searchLayout.className = 'hideLayout'
    postLayout.className = ''

    document.querySelector('#postLayout #topBar p:first-child').addEventListener('click', function () {
        location.reload()
    })

    fetchXhr(getApiUrl(sessionData.instance) + '/v3/notificationsScroll?page=0&date=' + new Date().getTime(), 'GET', function (e, r) {
        console.log(r)

        notifsLayout.textContent = ''

        var notifs = r.notifications.map(function (n) {
            var m = n
            if (m.emojiReactionId) m.emojiReaction = r.emojiRelations.postEmojiReactions.filter(function (e) {

                return m.emojiReactionId === e.id
            })[0]
            if (m.notificationType === 'QUOTE') {
                m.quote = r.quotes.map(function (q) {
                    var s = q
                    s.post = r.posts.filter(function (p) {
                        return p.id === q.quoterPostId
                    })[0]
                    console.log(s, r.posts)
                    return s
                })

                m.quote = m.quote.filter(function (e) {
                    console.log("quote info", m, e)
                    return e.post.userId === m.userId
                })[0]
            }

            return m
        }).forEach(function (n) {
            console.log(n)
            var notifTypeStr = "liked your woot"
            switch (n.notificationType) {
                case "FOLLOW":
                case "MENTION":
                case "USERBITE":
                    notifTypeStr = (n.notificationType === 'FOLLOW' ? 'followed' : n.notificationType === 'MENTION' ? 'mentioned' : 'bit') + " you" + (n.notificationType === 'MENTION' ? ' on their <button data-post-info="' + n.postId + '">woot</button>' : '')
                    break
                case "REWOOT":
                case "POSTBITE":
                case "QUOTE":
                    console.log(n.quote)
                    notifTypeStr = (n.notificationType === 'POSTBITE' ? 'bit' : n.notificationType === 'QUOTE' ? 'quoted' : 'rewooted') + ' your <button data-post-info="' + n.postId + '">woot</button>' + (n.notificationType === 'QUOTE' ? ' with their <button data-post-info="' + n.quote.post.id + '">woot</button>' : '')
                    break
                case "EMOJIREACT":
                    notifTypeStr = 'reacted ' + (n.emojiReaction && n.emojiReaction.properties ? n.emojiReaction.properties.content : 'something') + ' on your <button data-post-info="' + n.postId + '">woot</button>'
                    break
                case "LIKE":
                    notifTypeStr = 'liked your <button data-post-info="' + n.postId + '">woot</button>'
                    break
            }

            var template = '<div class="notification"><button data-user-info="' + n.user.id + '">' + n.user.url + '</button> ' + notifTypeStr + '</div>'

            appendHtml(template, notifsLayout)
        })

        r.posts.forEach(function (p) {
            var postElms = document.querySelectorAll('[data-post-info="' + p.id + '"]')
            postElms.forEach(function (e) {
                e.href = ''
                e.addEventListener('click', function (ev) {
                    ev.preventDefault()
                    console.log('post notif', p)
                    queryAndLoadPost(p.id)
                })
            })
            if (p.ancestors) p.ancestors.forEach(function (aPost) {
                var postElms = document.querySelectorAll('[data-post-info="' + aPost.id + '"]')
                postElms.forEach(function (e) {
                    e.href = ''
                    e.addEventListener('click', function (ev) {
                        ev.preventDefault()
                        queryAndLoadPost(aPost.id)
                    })
                })
            })
        })
        r.users.forEach(function (u) {
            var userElms = document.querySelectorAll('[data-user-info="' + u.id + '"]')
            userElms.forEach(function (e) {
                e.href = ''
                e.addEventListener('click', function (ev) {
                    ev.preventDefault()
                    showUserInfo(u)
                })
            })
        })

        getNotificationCount()
    }, function (e) { }, sessionData.loginData ? sessionData.loginData.token : undefined)
}
function showIdQuery() {
    var queryId = prompt('(Advanced) Put "post" or "user" then space then ' + sessionData.instance + ' ID of the post or user username')
    if (queryId) {
        var query = queryId.split(' ')
        switch (query[0].toLowerCase()) {
            case 'post': {
                queryAndLoadPost(query[1])
                break;
            }
            case 'user': {
                showUserInfo({ url: query[1] })
            }
        }
    }
}
function showSearch() {
    mainLayout.className = 'hideLayout'
    loginLayout.className = 'hideLayout'
    createLayout.className = 'hideLayout'
    searchLayout.className = ''
    var searchSubmit = document.querySelector('#searchLayout #content #searchSubmit')
    searchSubmit.addEventListener('click', function (e) {
        var searchQuery = document.querySelector('#searchLayout #content #search').value
        searchSubmit.disabled = true
        fetchXhr(getApiUrl(sessionData.instance) + '/v2/search?term=' + encodeURIComponent(searchQuery) + '&page=0&startScroll=' + new Date().getTime(), 'GET', function (e, r) {
            if (r.foundUsers[0]) {
                showUserInfo(r.foundUsers[0])
            } else if (r.posts.posts[0]) {
                queryAndLoadPost(r.posts.posts[0].id)
            } else {
            }
        }, function (e) { }, sessionData.loginData ? sessionData.loginData.token : undefined)
    })
}
function showDashboard(value) {
    loadingScreen.className = 'hideLayout'
    loginLayout.className = 'hideLayout'
    createLayout.className = 'hideLayout'
    mainLayout.className = ''
    userName = '@' + sessionData.loginData.url + '@' + sessionData.instanceEnv.frontUrl.replace('https://', '').replace('/', '')
    userNames.forEach(function (e) {
        e.textContent = userName
    })
    userLevels.forEach(function (e) {
        e.addEventListener('input', function (f) {
            if (e.value === '2') {
                localStorage.clear()
                location.reload()
            } else if (e.value === '3') {
                showAbout()
            } else if (e.value === '4') {
                showIdQuery()
                e.value = '1'
            } else if (e.value === '5') {
                showNotifications()
                e.value = '1'
            }
        })
    })
    var dashboardLevel = document.querySelector('#mainLayout #dashboardLevel')
    dashboardLevel.addEventListener('input', function (e) {
        if (dashboardLevel.value !== '25' && dashboardLevel.value !== '20') {
            loadPosts(dashboardLevel.value)
        } else if (dashboardLevel.value === '20') {
            showSearch()
        } else {
            showCreateWoot()
        }
    })
    if (value) {
        document.querySelector('#mainLayout #dashboardLevel').value = value
    }
    loadPosts(value || dashboardLevel.value)
}
function showPostThread(leadingPost) {
    console.log(leadingPost)
    mainLayout.textContent = ''
    loadingScreen.className = 'hideLayout'
    loginLayout.className = 'hideLayout'
    createLayout.className = 'hideLayout'
    mainLayout.className = 'hideLayout'
    postLayout.className = 'hideLayout'
    searchLayout.className = 'hideLayout'
    postLayout.className = ''
    document.querySelector('#postLayout #topBar p:first-child').addEventListener('click', function () {
        location.reload()
    })
    var postLayoutContent = document.querySelector('#postLayout #content')
    postLayoutContent.textContent = ''
    renderPost(leadingPost, postLayoutContent, true)
    var postThreadChildrenView = document.querySelector('#postLayout #content .childrenPosts')
    loadPosts(0, false, leadingPost.id, true)
}
function showAbout() {
    mainLayout.textContent = ''

    document.querySelector('#postLayout #content').textContent = ''
    loadingScreen.className = 'hideLayout'
    loginLayout.className = 'hideLayout'
    createLayout.className = 'hideLayout'
    mainLayout.className = 'hideLayout'
    postLayout.className = ''
    document.querySelector('#postLayout #topBar p:first-child').addEventListener('click', function () {
        location.reload()
    })
    var aboutContent = document.querySelector('#postLayout #content')
    var v = "<div class=\"instInfo\"><small>About ".concat(sessionData.instance, "</small><img class=\"instanceLogo\" data-media-url=\"").concat(sessionData.instanceEnv.frontUrl, "/assets/logo.avif\"><h2>").concat(sessionData.instanceNodeinfo.metadata.nodeName, "</h2><p>").concat(sessionData.instanceNodeinfo.metadata.nodeDescription, "</p><p>using Wafrn ").concat(sessionData.instanceNodeinfo.software.version, "</p></div><div class=\"wafTilesInfo\"><small>About WafTiles</small><img src=\"/assets/waftiles.png\" alt=\"WafTiles logo\" ><p>WafTiles is a client for the <a href=\"https://wafrn.net\">WAFRN social network</a> in Kicya.net's WebTiles.</p><p>using WafTiles v1.0.0a1</p><p>emojis on WafTiles' logo is <a href=\"https://volpeon.ink/emojis/neofox/\">Neofox</a> by <a href=\"https://volpeon.ink></a>Volpeon, licensed under CC-BY-NC-SA-4.0.</p></div>");
    appendHtml(v, aboutContent)
    var aboutInstanceLogo = document.querySelector('#postLayout .instanceLogo')
    renderImage(aboutInstanceLogo)
}
function showCreateWoot(reply, isQuote) {
    mainLayout.className = 'hideLayout'
    loginLayout.className = 'hideLayout'
    createLayout.className = ''
    var dashboardLevel = document.querySelector('#createLayout #dashboardLevel')
    if (reply) {
        if (reply.content_warning) document.querySelector('#createLayout #cw').value = reply.content_warning
        var replyingTo = document.querySelector('#createLayout .replyingTo')
        replyingTo.textContent = isQuote ? 'Quoting...' : 'Replying to...'
        renderPost(reply, replyingTo)
    }
    dashboardLevel.addEventListener('input', function (e) {
        if (dashboardLevel.value !== '25') {
            showDashboard(dashboardLevel.value)
        } else {
            showCreateWoot()
        }
    })
    var sendElm = document.querySelector('#createLayout #send')
    sendElm.addEventListener('click', function (e) {
        sendElm.textContent = 'refresh'
        var content = document.querySelector('#createLayout #textContent').value
        var cw = document.querySelector('#createLayout #cw').value
        var tags = document.querySelector('#createLayout #tags').value
        var type = document.querySelector('#createLayout #postType').value
        var wootReq = {
            content: content,
            content_warning: cw,
            medias: [],
            mentionedUsers: [],
            privacy: parseInt(type),
            tags: tags
        }
        if (reply && !isQuote) {
            wootReq.mentionedUsers = reply.mentions.map(function (m) { return m.userMentioned })
            wootReq.mentionedUsers.push(reply.userId)
            wootReq.parent = reply.id
        } else if (reply && isQuote) {
            wootReq.postToQuote = reply.id
        }
        console.log(content, cw, tags, type)
        fetchXhr(getApiUrl(sessionData.instance) + '/v3/createPost', 'POST', function (e, r) {
            playSound(2)
            fatalError(undefined)
        }, function (e) { }, wootReq, sessionData.loginData ? sessionData.loginData.token : undefined)
    })
}
function loadPosts(dashboardLvl, down, userUrl, isThread) {
    console.log('loading posts,', dashboardLvl, dashboardCurrentPage, dashboardLastPostTime, dashboardNextPostTime, lastDashboardLevel, down, userUrl)
    console.log('load thing', down)
    if (dashboardLvl !== lastDashboardLevel || lastDashboardLevel === undefined) {
        console.log('load aaaa', dashboardLvl, lastDashboardLevel)
        dashboardCurrentPage = 0
        dashboardLastPostTime = new Date().getTime()
        dashboardNextPostTime = new Date().getTime()
        lastDashboardLevel = dashboardLvl || 1
    }

    if (!sessionData.loginData) lastDashboardLevel = 2
    var contentEl = !userUrl ? document.querySelector('#mainLayout #content') : isThread ? document.querySelector('#postLayout #content .childrenPosts') : document.querySelector('#postLayout #content')
    if (!userUrl || isThread) contentEl.textContent = ''
    else {
        document.querySelectorAll('#postLayout #content :where(.contentItem, .navBtnContainer)').forEach(function (e) {
            e.remove()
        })
    }
    addLoadingString(contentEl)
    fetchXhr(getApiUrl(sessionData.instance) + (isThread ? '/' : '/v2/') + (userUrl ? (!isThread ? 'blog?id=' + userUrl + '&' : 'forum/' + userUrl) : 'dashboard?level=' + dashboardLvl + '&') + (isThread ? '' : 'page=' + ((dashboardCurrentPage > 0 || (userUrl && !isThread)) ? dashboardCurrentPage : -1) + '&startScroll=' + (down ? dashboardLastPostTime : dashboardNextPostTime)), 'GET', function (e, feed) {
        var medias = feed.medias
        var users = feed.users
        var tags = feed.tags
        var quotes = feed.quotes
        var quotedPosts = feed.quotedPosts
        var mentions = feed.mentions
        var asks = feed.asks
        var emojiRelations = feed.emojiRelations
        var posts = feed.posts.sort(function (a, b) {
            return new Date(b.createdAt) - new Date(a.createdAt)
        })
        console.log(posts)
        posts = posts.map(function (x) {
            var y = x
            y.user = users.filter(function (z) {
                return z.id === x.userId
            })[0]
            y.tags = tags.filter(function (z) {
                return z.postId === x.id
            })
            y.medias = medias.filter(function (z) {
                return z.postId === x.id
            })
            y.mentions = mentions.filter(function (z) {
                return z.post === x.id
            }).map(function (m) {
                var n = m
                n.user = users.filter(function (z) {
                    return z.id === m.userMentioned
                })[0]
                return n
            })
            y.quote = quotes.filter(function (n) {
                return n.quoterPostId === x.id
            }).map(function (q) {
                return quotedPosts.filter(function (x) {
                    return q.quotedPostId === x.id
                })[0]
            }).map(function (a) {
                var b = a
                b.user = users.filter(function (z) {
                    return z.id === b.userId
                })[0]
                b.tags = tags.filter(function (z) {
                    return z.postId === b.id
                })
                b.medias = medias.filter(function (z) {
                    return z.postId === b.id
                })
                b.mentions = mentions.filter(function (z) {
                    return z.post === b.id
                }).map(function (m) {
                    var n = m
                    n.user = users.filter(function (z) {
                        return z.id === m.userMentioned
                    })[0]
                    return n
                })
                b.ancestors = []
                b.emojiRelations = emojiRelations.postEmojiReactions.filter(function (z) {
                    return z.postId === b.id
                })
                if (asks) b.ask = asks.filter(function (z) {
                    return z.postId === b.id
                }).map(function (a) {
                    var c = a
                    c.asked = users.filter(function (z) {
                        return z.id === a.userAsked
                    })[0]
                    c.asker = users.filter(function (z) {
                        return z.id === a.userAsker
                    })[0]
                    return c
                })[0]
                return b
            })[0]
            y.emojiRelations = emojiRelations.postEmojiReactions.filter(function (z) {
                return z.postId === x.id
            }).map(function (e) {
                return emojiRelations.emojis.filter(function (f) {
                    return e.emojiId === f.id
                })[0]
            })
            y.emojis = emojiRelations.postEmojiRelation.filter(function (z) {
                return z.postId === x.id
            }).map(function (e) {
                return emojiRelations.emojis.filter(function (f) {
                    return e.emojiId === f.id
                })[0]
            })
            if (asks) y.ask = asks.filter(function (z) {
                return z.postId === x.id
            }).map(function (a) {
                var b = a
                b.asked = users.filter(function (z) {
                    return z.id === a.userAsked
                })[0]
                b.asker = users.filter(function (z) {
                    return z.id === a.userAsker
                })[0]
                return b
            })[0]
            if (y.ancestors) y.ancestors = y.ancestors.sort(function (a, b) {
                return new Date(b.createdAt) - new Date(a.createdAt)
            }).map(function (a) {
                var b = a
                b.user = users.filter(function (z) {
                    return z.id === b.userId
                })[0]
                b.tags = tags.filter(function (z) {
                    return z.postId === b.id
                })
                b.medias = medias.filter(function (z) {
                    return z.postId === b.id
                })
                b.mentions = mentions.filter(function (z) {
                    return z.post === b.id
                }).map(function (m) {
                    var n = m
                    n.user = users.filter(function (z) {
                        return z.id === m.userMentioned
                    })[0]
                    return n
                })
                b.ancestors = []
                b.emojiRelations = emojiRelations.postEmojiReactions.filter(function (z) {
                    return z.postId === b.id
                }).map(function (e) {
                    return emojiRelations.emojis.filter(function (f) {
                        return e.emojiId === f.id
                    })[0]
                })
                b.emojis = emojiRelations.postEmojiRelation.filter(function (z) {
                    return z.postId === b.id
                }).map(function (e) {
                    return emojiRelations.emojis.filter(function (f) {
                        return e.emojiId === f.id
                    })[0]
                })
                if (asks) b.ask = asks.filter(function (z) {
                    return z.postId === b.id
                }).map(function (a) {
                    var c = a
                    c.asked = users.filter(function (z) {
                        return z.id === a.userAsked
                    })[0]
                    c.asker = users.filter(function (z) {
                        return z.id === a.userAsker
                    })[0]
                    return c
                })[0]
                return b
            })
            else y.ancestors = []
            return y
        }).slice(0, 7)

        if (isThread) posts = posts.reverse()
        if (posts.length > 0) {
            console.log('load post length', posts.length, posts)
            dashboardLastPostTime = dashboardNextPostTime
            dashboardNextPostTime = new Date(posts[posts.length - 1].createdAt).getTime()
        }
        console.log(posts)
        var clickEventPosts = []
        posts.forEach(function (p) {
            renderPost(p, contentEl, isThread)
        })
        document.querySelectorAll('button[data-post-info]').forEach(function (e) {
            var inThere = false
            clickEventPosts.forEach(function (c) {
                inThere = c === e.dataset.postInfo
            })
            if (!inThere) {
                e.addEventListener('click', function (ev) {
                    queryAndLoadPost(e.dataset.postInfo)
                })
            }
        })
        document.querySelectorAll('div[data-post-id]').forEach(function (d) {
            var poId = d.dataset.postId
            var post = posts.filter(function (p) {
                return p.id === poId
            })[0]
            var createWootBtn = document.querySelector(['[data-post-id="', poId, '"] button#reply'].join(''))
            if (createWootBtn) createWootBtn.addEventListener('click', function (e) {
                showCreateWoot(post)
            })
            var quoteWootBtn = document.querySelector(['[data-post-id="', poId, '"] button#quote'].join(''))
            if (quoteWootBtn) quoteWootBtn.addEventListener('click', function (e) {
                showCreateWoot(post, true)
            })
            var rewootBtn = document.querySelector(['[data-post-id="', poId, '"] button#rewoot'].join(''))
            if (rewootBtn) rewootBtn.addEventListener('click', function (e) {
                if (rewootBtn.textContent === 'repeat') {
                    rewootBtn.textContent = 'refresh'
                    fetchXhr(getApiUrl(sessionData.instance) + '/v3/createPost', 'POST', function (e, r) {
                        playSound(2)
                        rewootBtn.textContent = 'close'
                    }, function (e) { }, {
                        content: "",
                        content_warning: "",
                        medias: [],
                        mentionedUserIds: [],
                        parent: poId
                    }, sessionData.loginData ? sessionData.loginData.token : undefined)
                } else {
                }
            })
            var likeBtn = document.querySelector(['[data-post-id="', poId, '"] button#like'].join(''))
            if (likeBtn) likeBtn.addEventListener('click', function (e) {
                if (likeBtn.textContent === 'favorite') {
                    likeBtn.textContent = 'refresh'
                    fetchXhr(getApiUrl(sessionData.instance) + '/like', 'POST', function (e, r) {
                        playSound(1)
                        likeBtn.textContent = 'close'
                    }, function (e) { }, {
                        postId: poId
                    }, sessionData.loginData ? sessionData.loginData.token : undefined)
                } else {
                    likeBtn.textContent = 'refresh'
                    fetchXhr(getApiUrl(sessionData.instance) + '/unlike', 'POST', function (e, r) {
                        likeBtn.textContent = 'favorite'
                    }, function (e) { }, {
                        postId: poId
                    }, sessionData.loginData ? sessionData.loginData.token : undefined)
                }
            })
        })
        users.forEach(function (u) {
            var userElms = document.querySelectorAll('[data-user-info="' + u.id + '"]')
            userElms.forEach(function (e) {
                e.href = ''
                e.addEventListener('click', function (ev) {
                    ev.preventDefault()
                    showUserInfo(u)
                })
            })
        })
        if (posts.length > 0) {
            if (!isThread) renderButtons(contentEl, dashboardCurrentPage, userUrl)
        } else {
            addLoadingString(contentEl, 'No replies found')
        }
        if (down) {
            dashboardCurrentPage = dashboardCurrentPage - 1
            console.log('load minus')
        } else {
            dashboardCurrentPage = dashboardCurrentPage + 1
            console.log('load add')
        }
        if (!isModern) {
            setTimeout(function () {
                var imageEs = document.querySelectorAll('img[data-media-url]:not([data-loaded])')
                function renderAllImages(imgElms) {
                    var i = 0;
                    function next() {
                        if (i >= imgElms.length) return;
                        var image = imgElms[i];
                        i++;
                        renderImage(image, function() {
                            next();
                        });
                    }
                    next();
                }
                renderAllImages(imageEs)
            }, 500)
        } else {
            document.querySelectorAll('img[data-media-url]:not([data-loaded])').forEach(function (e) {
                renderImage(e)
            })
        }
        console.log('loading posts,', dashboardLvl, dashboardCurrentPage, dashboardLastPostTime, dashboardNextPostTime, lastDashboardLevel, down, userUrl)
        var mL = document.querySelector('#mainLayout #loading')
        if (mL) mL.remove()
        var uL = document.querySelector('#postLayout #loading')
        if (uL) uL.remove()
        var pL = document.querySelector('#postLayout #loading')
        if (pL) pL.remove()
    }, function (e) { }, sessionData.loginData ? sessionData.loginData.token : undefined)
}
function renderImage(img, func) {
    var mediaUrl = img.dataset.mediaUrl
    var xhr = new XMLHttpRequest();
    console.log('has image', img)
    xhr.open('GET', 'https://waftiles.waf.moe/' + mediaUrl, true);
    xhr.onload = function() {
        try {
            var obj = JSON.parse(xhr.responseText);
            var width = obj.width;
            var height = obj.height;
            var dataUri = obj.dataUri;

            img.width = width;
            img.height = height;
            img.src = dataUri;

            img.setAttribute('data-loaded', 'true')

            if (func) func()
        } catch (e) {
            img.alt = img.alt + ' (' + mediaUrl + ')'
            console.error(e)
            if (func) func()
        }
    };
    xhr.send();
}
function showUserInfo(u) {
    mainLayout.textContent = ''
    console.log(u)
    loadingScreen.className = 'hideLayout'
    loginLayout.className = 'hideLayout'
    createLayout.className = 'hideLayout'
    mainLayout.className = 'hideLayout'
    searchLayout.className = 'hideLayout'
    postLayout.className = ''
    document.querySelector('#postLayout #topBar p:first-child').addEventListener('click', function () {
        location.reload()
    })
    var contentEl = document.querySelector('#postLayout #content')
    contentEl.textContent = 'Loading...'
    fetchXhr(getApiUrl(sessionData.instance) + '/user?id=' + u.url, 'GET', function (e, user) {
        var desc = user.description
        var name = user.name
        user.emojis.forEach(function (e) {
            var emojiId = e.name.replace(':', '').replace(':', '')
            desc = desc.split(':').map(function (d) {
                if (d === emojiId) {
                    var emojiUrl = e.url
                    if (emojiUrl[0] === '/') emojiUrl = (sessionData.instanceEnv.baseMediaUrl) + e.url
                    return '<img class="emojiImage" data-media-url="' + emojiUrl + '" alt="' + e.name + '">'
                } else {
                    return d
                }
            }).join(':').replace(':<', '<').replace('>:', '>')
            name = name.split(':').map(function (d) {
                if (d === emojiId) {
                    var emojiUrl = e.url
                    if (emojiUrl[0] === '/') emojiUrl = (sessionData.instanceEnv.baseMediaUrl) + e.url
                    return '<img class="emojiImage" data-media-url="' + emojiUrl + '" alt="' + e.name + '">'
                } else {
                    return d
                }
            }).join(':').replace(':<', '<').replace('>:', '>')
        })
        var userAvatar = user.avatar
        if (userAvatar[0] === '?' || userAvatar[0] === '/') userAvatar = (sessionData.instanceEnv.cacheDomain + '/api/v2/cache/avatar/' + user.id)
        var v = "<div class=\"userProfileInfo\"><div class='displayName'><img data-media-url=\"".concat(userAvatar, "\"</img><div><h2>").concat(name, "</h2><p>").concat(user.url, "</p></div></div><div class=\"userDescription\">").concat(desc, "</div>").concat(user.url[0] === '@' ? "<p class=\"extUser\">This user is an external user. <a href=\"".concat((user.isBskyPrimary ? "https://bsky.app/profile/".concat(user.bskyDid) : user.displayUrl), "\">View on original instance</a></p>") : '', "<div class=\"stats\"><p>").concat(user.postCount, " posts</p><p>").concat(user.followed, " following</p><p>").concat(user.followers, " followers</p></div></div><div class=\"userPosts\"></div>");
        contentEl.textContent = ''
        console.log(userAvatar)
        appendHtml(v, contentEl)
        loadPosts(0, false, u.url)
    }, function (e) { }, sessionData.loginData ? sessionData.loginData.token : undefined)
}
function renderButtons(element, curPage, userUrl) {
    var btnContainer = document.createElement('div')
    btnContainer.className = 'navBtnContainer';
    if (curPage > 0) {
        var prevBtn = document.createElement('button')
        prevBtn.textContent = 'Prev'
        prevBtn.addEventListener('click', function (e) {
            try {
                var dashboardLevel = document.querySelector('#mainLayout #dashboardLevel')
                loadPosts(dashboardLevel ? dashboardLevel.value : (!sessionData.loginData ? 2 : 0), true, userUrl)
            } catch (e) {
                fatalError(e)
            }
        })
        btnContainer.appendChild(prevBtn)
    }
    var nextBtn = document.createElement('button')
    nextBtn.textContent = 'Next'
    nextBtn.addEventListener('click', function (e) {
        try {
            var dashboardLevel = document.querySelector('#mainLayout #dashboardLevel')
            loadPosts(dashboardLevel ? dashboardLevel.value : (!sessionData.loginData ? 2 : 0), false, userUrl)
        } catch (e) {
            fatalError(e)
        }
    })
    btnContainer.appendChild(nextBtn)
    element.appendChild(btnContainer)
}
function renderAsk(post) {
    if (!post.ask) return ''
    console.log('asker:', post.ask.asker, post.ask)
    return '<div class="askContent"><small>' + (post.ask.asker ? '<button data-user-info="' + post.ask.asker.id + '">' + post.ask.asker.url + '</button>' : 'Someone') + ' asked</small><p>' + post.ask.question + '</p></div>'
}
function renderReblogHeader(post) {
    if (!post.isReblog) {
        return '';
    }
    return '<div class="userRewoot"><p><button data-user-info="' + post.user.id + '">' + post.user.url + '</button> rewooted</p><p class="postDate">' + new Date(post.createdAt).toLocaleDateString() + '</p></div>';
}
function renderUserInfo(post) {
    var actualPost = getActualPost(post);
    return '<div class="userInfo"><button data-user-info="' + actualPost.user.id + '">' + actualPost.user.url + '</button><p><button class="postDate" data-post-info="' + actualPost.id + '">' + new Date(actualPost.createdAt).toLocaleDateString() + '</button></p></div>';
}
function renderContentWithWarning(post) {
    var actualPost = getActualPost(post);

    console.log('post', actualPost, actualPost.tags)
    
    var postContent = actualPost.content
    if (post.emojis) post.emojis.forEach(function (e) {
        var emojiId = e.name.replace(':', '').replace(':', '')
        postContent = postContent.split(':').map(function (d) {
            if (d === emojiId) {
                var emojiUrl = e.url
                if (emojiUrl[0] === '/') emojiUrl = (sessionData.instanceEnv.baseMediaUrl) + e.url
                return '<img class="emojiImage" data-media-url="' + emojiUrl + '" alt="' + e.name + '">'
            } else {
                return d
            }
        }).join(':').replace(':<', '<').replace('>:', '>')
    })

    var warningStart = actualPost.content_warning ? '<details><summary>' + actualPost.content_warning + '</summary>' : '';
    var warningEnd = actualPost.content_warning ? '</details>' : '';
    var mentions = post.mentions.length > 0 ? '<small>' + post.mentions.map(function (m) { return m.user.url; }).join(', ') + '</small>' : '';
    var replyContext = (post.ancestors && post.ancestors.length > 0 && !post.isReblog) ? '<p><small>replying to ' + post.ancestors[0].user.url + "'s <button data-post-info='" + post.ancestors[0].id + "'>post</button></small></p>" : (post.parentId && !post.isReblog) ? '<p><small class="replyInfo">replying to <button data-post-info="' + post.parentId + '">unloaded post</button></small></p>' : '';
    var content = '<div class="wootContent">' + postContent + '</div>';
    var medias = actualPost.medias.length > 0 ? '<div class="medias">' + actualPost.medias.map(function (m, i) { return '<a href="' + (sessionData.instanceEnv.cacheDomain + '/api/v2/cache/media/' + m.id) + '"><img' + (m.description ? ' alt="' + m.description + '" title="' + m.description + '"' : '') + ' data-media-url="' + (sessionData.instanceEnv.cacheDomain + '/api/v2/cache/media/' + m.id) + '"></a>'; }).join('') + '</div>' : '';
    var tags = actualPost.tags.length > 0 ? ('<p><small>' + actualPost.tags.map(function (t) {
        return '#' + t.tagName
    }).join(', ') + '</small></p>') : ''
    return warningStart + mentions + replyContext + renderAsk(actualPost) + content + medias + tags + warningEnd;
}
function renderWootInfo(post, inPostThreadView) {
    var stats = '<p>' + post.ancestors.length + ' notes, ' + post.emojiRelations.length + ' reactions</p>';
    var actions = '';
    if ((!post.isReblog && inPostThreadView) || !inPostThreadView) {
        var actualPost = getActualPost(post);
        var remoteLink = '<a href="' + sessionData.instanceEnv.frontUrl + '/fediverse/post/' + post.id + '">open_in_new</a>';
        actions = sessionData.loginData ? '<div class="actionButtons"><button id="reply">reply</button><button id="quote">format_quote</button><button id="rewoot">repeat</button><button id="like">favorite</button>' + remoteLink + '</div>' : '<div class="actionButtons">' + remoteLink + '</div>';
    } else {
        actions = '<div></div>';
    }
    return '<div class="wootInfo">' + stats + actions + '</div>';
}
function renderPostTemplate(post, inPostThreadView) {
    var mainContent = '';
    console.log('reblog info', post.isReblog, inPostThreadView, post)
    if ((!post.isReblog && inPostThreadView) || !inPostThreadView) {
        mainContent = renderUserInfo(post) + renderContentWithWarning(post) +
            (post.quote ?
                '<div class="quotedPost">' +
                renderUserInfo(post.quote) + renderContentWithWarning(post.quote) +
                '</div>' : '') + renderWootInfo(post, inPostThreadView);
    }
    var childrenContainer = inPostThreadView ? '<div class="childrenPosts"></div>' : '';
    return '<div class="contentItem" data-post-id="' + getActualPost(post).id + '">' +
        renderReblogHeader(post) +
        mainContent +
        '</div>' +
        childrenContainer;
}
function renderPost(post, element, inPostThreadView) {
    console.log(post, post.quote)
    var template = renderPostTemplate(post, inPostThreadView)
    var postContent = appendHtml(template, element)
    console.log(post)
    return postContent
}
function appendHtml(html, element) {
    var nodes = parseHTML(html)
    element.appendChild(nodes)
    return nodes
}
function fetchXhr(url, method, callback, errorCallback, data, auth) {
    try {
        var xhr = new XMLHttpRequest()
        xhr.open(method, url)
        xhr.onload = function (e) {
            try {
                callback(e, JSON.parse(xhr.responseText))
            } catch (err) {
                console.error(err)
                fatalError(err)
            }
        }
        xhr.errorCallback = function (e) {
            errorCallback(e)
        }
        if (method === 'POST') {
            xhr.setRequestHeader('Content-Type', 'application/json')
            if (auth) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + auth)
            }
            xhr.send(JSON.stringify(data))
        } else {
            if (data) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + data)
            }
            xhr.send()
        }
    } catch (e) {
        console.error(e)
        fatalError(e)
    }
}
function addLoadingString(element, customStr) {
    var loadThing = document.createElement('p')
    loadThing.id = 'loading'
    loadThing.textContent = customStr || 'Loading...'
    element.appendChild(loadThing)
}
function saveSessionData() {
    localStorage.setItem('wafTilesSession', JSON.stringify(sessionData))
}
function getApiUrl(instanceDomain) {
    return 'https://' + instanceDomain + '/api'
}
function getActualPost(post) {
    return (post.isReblog && post.ancestors.length > 0) ? post.ancestors[0] : post
}
function parseHTML(html) {
    var parser = new DOMParser();
    var doc = parser.parseFromString(html, 'text/html');
    if (isModern) {
        return doc.body.cloneNode(true)
    }
    var body = doc.body;
    if (!body) return null;
    var preserveAttrs = ['id', 'class', 'data-post-info', 'data-media-url', 'data-user-info', 'data-post-id', 'src', 'href', 'alt', "title"];
    function cloneNode(node) {
        if (!node) return null;
        if (node.nodeType === 3) {
            var txt = node.nodeValue || '';
            if (txt.trim() === '') return null;
            return document.createTextNode(txt);
        }
        if (node.nodeType === 1) {
            var el = document.createElement(node.tagName.toLowerCase());
            for (var i = 0; i < preserveAttrs.length; i++) {
                var val = node.getAttribute && node.getAttribute(preserveAttrs[i]);
                if (val !== null && val !== undefined) {
            		if (preserveAttrs[i] === 'src' && val.replace('https://', '').split('/')[0] === sessionData.instanceEnv.cacheDomain.replace('https://', '').split('/')[0]) {
                        el.setAttribute('data-media-url', val);
                    } else {
                        el.setAttribute(preserveAttrs[i], val);
                    }
                    
                }
            }
            if (node.childNodes) {
                for (var j = 0; j < node.childNodes.length; j++) {
                    var child = cloneNode(node.childNodes[j]);
                    if (child) el.appendChild(child);
                }
            }
            return el;
        }
        return null;
    }
    var wrapper = document.createElement('div');
    for (var k = 0; k < body.childNodes.length; k++) {
        var cloned = cloneNode(body.childNodes[k]);
        if (cloned) wrapper.appendChild(cloned);
    }
    if (wrapper.childNodes.length === 1) return wrapper.firstChild;
    return wrapper;
}
function decodeToken(token) {
    var jwtData = token.split('.')[1];
    return JSON.parse(window.atob(jwtData));
}</script>
</body>
</html>