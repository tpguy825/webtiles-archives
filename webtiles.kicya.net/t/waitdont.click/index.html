<!DOCTYPE html>
<html lang="en">
<head>
  <style>html, .tile-body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

.tile-body {
  background: #000;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#title {
  color: #fff;
  z-index: 1;
  background: #0009;
  padding: 2px;
  font-family: Verdana, sans-serif;
  font-size: 8px;
  position: absolute;
  top: 0;
  left: 0;
}

#world {
  width: 100%;
  height: 100%;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
  display: block;
}
</style>
</head>
<body class="tile-body">
  <div id="title">Conways Game of Life - Loading...</div>
  <canvas id="world" width="128" height="128"></canvas>
  <script type="text/tilescript">(function () {
  'use strict';

  var G = 16;
  var C = 8;
  var W = G * C;
  var N = G * G;

  var curr = [];
  var next = [];
  var steps = 0;

  // For detecting stagnation - store hash of last 3 states
  var hash1 = 0;
  var hash2 = 0;
  var hash3 = 0;

  var canvas, ctx, titleEl;

  function init() {
    var i;
    for (i = 0; i < N; i++) {
      curr[i] = 0;
      next[i] = 0;
    }
  }

  // Simple hash of current state
  function hashState() {
    var h = 0;
    var i;
    for (i = 0; i < N; i++) {
      if (curr[i] === 1) {
        h = h + i * 31;
      }
    }
    return h;
  }

  function seed() {
    var i;
    // Use time-based randomness
    var t = Date.now() % 10000;
    for (i = 0; i < t; i++) {
      Math.random();
    }

    for (i = 0; i < N; i++) {
      curr[i] = (Math.random() < 0.35) ? 1 : 0;
    }
    steps = 0;
    hash1 = 0;
    hash2 = 0;
    hash3 = 0;
  }

  function step() {
    var x, y, i, n;
    var xm, xp, ym, yp;

    for (y = 0; y < G; y++) {
      ym = (y === 0) ? G - 1 : y - 1;
      yp = (y === G - 1) ? 0 : y + 1;

      for (x = 0; x < G; x++) {
        xm = (x === 0) ? G - 1 : x - 1;
        xp = (x === G - 1) ? 0 : x + 1;

        i = y * G + x;

        n = curr[ym * G + xm] +
            curr[ym * G + x] +
            curr[ym * G + xp] +
            curr[y * G + xm] +
            curr[y * G + xp] +
            curr[yp * G + xm] +
            curr[yp * G + x] +
            curr[yp * G + xp];

        if (curr[i] === 1) {
          next[i] = (n === 2 || n === 3) ? 1 : 0;
        } else {
          next[i] = (n === 3) ? 1 : 0;
        }
      }
    }

    var t = curr;
    curr = next;
    next = t;
    steps++;
  }

  function render() {
    var x, y, i;

    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, W, W);

    ctx.fillStyle = '#eee';
    for (y = 0; y < G; y++) {
      for (x = 0; x < G; x++) {
        i = y * G + x;
        if (curr[i] === 1) {
          ctx.fillRect(x * C, y * C, C, C);
        }
      }
    }
  }

  function tick() {
    step();

    // Check for stagnation (3 identical states in a row)
    var h = hashState();
    if (h === hash1 && h === hash2 && h === hash3 && steps > 3) {
      seed();
    }
    hash3 = hash2;
    hash2 = hash1;
    hash1 = h;

    render();

    if (titleEl) {
      titleEl.textContent = 'Conways Game of Life - Steps:' + steps;
    }
  }

  function start() {
    canvas = document.getElementById('world');
    titleEl = document.getElementById('title');
    if (!canvas) return;

    canvas.width = W;
    canvas.height = W;
    ctx = canvas.getContext('2d');
    if (!ctx) return;

    init();
    seed();
    render();

    canvas.addEventListener('dblclick', function () {
      seed();
      render();
    });

    setInterval(tick, 100);
  }

  function boot() {
    if (document.getElementById('world')) {
      start();
    } else {
      setTimeout(boot, 100);
    }
  }
  boot();
})();
</script>
</body>
</html>
