<!DOCTYPE html>
<html lang="en">
<head>
    <style>.tile-body {
  background-color: #fff;

  &:after {
    content: "";
    z-index: 15;
    pointer-events: none;
    background: #00000014;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }
}

.tile {
  text-align: center;
  color: #111;
  backface-visibility: hidden;
  width: 100%;
  height: 100%;
  transform-origin: center center -1px;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  font-family: sans-serif;
  display: flex;
  position: absolute;
  top: 0;
  left: 0;

  &:before {
    font-size: 1.5rem;
  }

  &:after {
    white-space: pre;
  }

  &.tile--frontside {
    transform: rotate3d(0, 1, 0, 0);

    &:before {
      content: "OwO";
      font-size: 2rem;
    }

    &:after {
      content: "What's behind this tile?";
    }

    &.tile--flipped {
      transform: rotate3d(0, 1, 0, 180deg);
    }
  }

  &.tile--backside {
    background-color: #ffe1b9;
    transform: rotate3d(0, 1, 0, 180deg);

    &:before {
      content: "Oh, neko?";
    }

    &:after {
      content: "Cute! She follows your mouse.";
    }

    &.neko-has-breached-confinement {
      &:before {
        content: "Uh oh";
      }

      &:after {
        content: "Oneko got out.";
      }
    }

    &.tile--flipped {
      transform: rotate3d(0, 1, 0, 360deg);
    }
  }

  &.tile--flipped {
    transition: transform 1s linear;
  }
}

.tile-body:not(.active) .tile--backside.neko-has-breached-confinement {
  &:before {
    content: "";
  }

  &:after {
    content: "(click back here to move oneko around)";
    opacity: .8;
    font-size: 90%;
  }
}
</style>
    
    <style id="let-me-out">
</style>
    <script type="text/tilescript">
        // Thanks Lyra Rebane for the tip!
        document.querySelector('#let-me-out').textContent = '\
        :host { \
            contain: initial !important; \
            overflow: initial !important; \
        } \
		';
    </script>
    
    <style>#oneko-container {
  position: absolute;
}
</style>
</head>
<body>
    <div class="tile tile--frontside"></div>
    <div class="tile tile--backside">
        <div id="oneko-container">
            
            <a class="oneko" href="https://sleepie.dev/oneko" target="_blank">
                <style>.oneko {
  cursor: default;
  background-image: url("oneko.gif");
  display: none;
}
</style>

                
                <div class="oneko__inactive oneko__inactive--frame-1"></div>
                <div class="oneko__inactive oneko__inactive--frame-2"></div>
                <div class="oneko__inactive oneko__inactive--sleeping-loop"></div>
                <style>.oneko {
  overflow-y: hidden;

  & .oneko__inactive {
    opacity: 1;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: -100%;
  }
}

.tile-body:not(.active) .oneko {
  opacity: .5;
  background-image: none !important;

  & .oneko__inactive {
    background-image: url("oneko.gif");
    left: 0;

    &.oneko__inactive--frame-1 {
      opacity: 0;
      background-position: -96px -96px;
      transition: opacity 0s linear 8s;
    }

    &.oneko__inactive--frame-2 {
      opacity: 0;
      background-position: -96px -64px;
      transition: left 0s linear 8s, opacity 0s linear 10s;
    }

    &.oneko__inactive--sleeping-loop {
      background-image: url("oneko-sleeping.gif");
      transition: left 0s linear 10s;
    }
  }
}
</style>
                

                <script type="text/tilescript">/**
 * Port of https://sleepie.dev/oneko for https://webtiles.kicya.net/ !
 * See https://gist.github.com/netux/bb51d659aaca5cd823244f4dfc7095bc for instructions
 */

function initTileOneko(options) {
    var nekoEl = document.querySelector('.oneko');
    var nekoStyleEl = nekoEl.querySelector('style');
    var NEKO_BACKGROUND_POSITION_CLASS_PREFIX = 'oneko--bg-pos_';
    
    var neko = {
        posX: 32,
        posY: 32,
        speed: 10
    };
    var nekoZIndex = 2147483647;
    
    if (options != null) {
        if (options.nekoPosX != null) {
            neko.posX = options.nekoPosX;
        }

        if (options.nekoPosY != null) {
            neko.posY = options.nekoPosY;
        }

        if (options.nekoSpeed != null) {
        	neko.speed = options.nekoSpeed;            
        }
        
        if (options.nekoZIndex != null) {
        	nekoZIndex = options.nekoZIndex;            
        }
    }

    var mousePosX = neko.posX;
    var mousePosY = neko.posY;

    var frameCount = 0;
    var idleTime = 0;
    var idleAnimation = null;
    var idleAnimationFrame = 0;
    
    var spriteSets = {
        idle: [[-3, -3]],
        alert: [[-7, -3]],
        scratchSelf: [
            [-5, 0],
            [-6, 0],
            [-7, 0],
        ],
        scratchWallN: [
            [0, 0],
            [0, -1],
        ],
        scratchWallS: [
            [-7, -1],
            [-6, -2],
        ],
        scratchWallE: [
            [-2, -2],
            [-2, -3],
        ],
        scratchWallW: [
            [-4, 0],
            [-4, -1],
        ],
        tired: [[-3, -2]],
        sleeping: [
            [-2, 0],
            [-2, -1],
        ],
        N: [
            [-1, -2],
            [-1, -3],
        ],
        NE: [
            [0, -2],
            [0, -3],
        ],
        E: [
            [-3, 0],
            [-3, -1],
        ],
        SE: [
            [-5, -1],
            [-5, -2],
        ],
        S: [
            [-6, -3],
            [-7, -2],
        ],
        SW: [
            [-5, -3],
            [-6, -1],
        ],
        W: [
            [-4, -2],
            [-4, -3],
        ],
        NW: [
            [-1, 0],
            [-1, -1],
        ],
    };

    function arrayFindIndex(arr, cb) {
        for (var i = 0; i < arr.length; i++) {
            if (cb(arr[i], i, arr)) {
                return i;
            }
        }

        return -1;
    }

    function requestAnimationFrame(cb) {
        setTimeout(function () {
            cb(Date.now());
        }, 1000 / 120);
    }

    function init() {
        nekoEl.ariaHidden = true;
        nekoEl.style.width = '32px';
        nekoEl.style.height = '32px';
        nekoEl.style.position = 'absolute';
        nekoEl.style.imageRendering = 'pixelated';
        nekoEl.style.left = (neko.posX - 16).toString() + 'px';
        nekoEl.style.top = (neko.posY - 16).toString() + 'px';
        nekoEl.style.zIndex = nekoZIndex;
        nekoEl.style.display = 'initial';

        for (var x = -8; x < 8; x++) {
            for (var y = -4; y < 4; y++) {
                var selector = '.' + NEKO_BACKGROUND_POSITION_CLASS_PREFIX + x.toString() + '_' + y.toString();
                nekoStyleEl.textContent += '\n' + selector + ' { background-position: ' + (x * 32).toString() + 'px ' + (y * 32).toString() + 'px; }';
            }
        }
        nekoEl.appendChild(nekoStyleEl);

        nekoEl.parentElement.addEventListener('mousemove', function(event) {
            mousePosX = event.offsetX;
            mousePosY = event.offsetY;
        });

        setSprite('idle', 0);
        requestAnimationFrame(onAnimationFrame);
    }

    var lastFrameTimestamp;

    function onAnimationFrame(timestamp) {
        if (!lastFrameTimestamp) {
            lastFrameTimestamp = timestamp;
        }
        if (timestamp - lastFrameTimestamp > 100) {
            lastFrameTimestamp = timestamp
            frame()
        }
        if (options != null && options.onAnimationFrame != null) {
            options.onAnimationFrame.apply(neko, arguments);
        }
        requestAnimationFrame(onAnimationFrame);
    }

    function setSprite(name, frame) {
        var sprite = spriteSets[name][frame % spriteSets[name].length];

        var nekoClasses = nekoEl.className.split(' ');
        var backgroundPosClassIdx = arrayFindIndex(nekoClasses, function(className) {
            return className.indexOf(NEKO_BACKGROUND_POSITION_CLASS_PREFIX) === 0;
        });
        if (backgroundPosClassIdx >= 0) {
            nekoClasses.splice(backgroundPosClassIdx, 1);
        }
        nekoClasses.push(NEKO_BACKGROUND_POSITION_CLASS_PREFIX + sprite[0].toString() + '_' + sprite[1].toString());
        nekoEl.className = nekoClasses.join(' ');
    }

    function resetIdleAnimation() {
        idleAnimation = null;
        idleAnimationFrame = 0;
    }

    function idle() {
        idleTime += 1;

        // every ~ 20 seconds
        if (
            idleTime > 10 &&
            Math.floor(Math.random() * 200) == 0 &&
            idleAnimation == null
        ) {
            var avalibleIdleAnimations = ['sleeping', 'scratchSelf'];
            if (neko.posX < 32) {
                avalibleIdleAnimations.push('scratchWallW');
            }
            if (neko.posY < 32) {
                avalibleIdleAnimations.push('scratchWallN');
            }
            if (neko.posX > nekoEl.parentElement.clientWidth - 32) {
                avalibleIdleAnimations.push('scratchWallE');
            }
            if (neko.posY > nekoEl.parentElement.clientHeight - 32) {
                avalibleIdleAnimations.push('scratchWallS');
            }
            idleAnimation =
                avalibleIdleAnimations[
                Math.floor(Math.random() * avalibleIdleAnimations.length)
                ];
        }

        switch (idleAnimation) {
            case 'sleeping':
                if (idleAnimationFrame < 8) {
                    setSprite('tired', 0);
                    break;
                }
                setSprite('sleeping', Math.floor(idleAnimationFrame / 4));
                if (idleAnimationFrame > 192) {
                    resetIdleAnimation();
                }
                break;
            case 'scratchWallN':
            case 'scratchWallS':
            case 'scratchWallE':
            case 'scratchWallW':
            case 'scratchSelf':
                setSprite(idleAnimation, idleAnimationFrame);
                if (idleAnimationFrame > 9) {
                    resetIdleAnimation();
                }
                break;
            default:
                setSprite('idle', 0);
                return;
        }
        idleAnimationFrame += 1;
    }

    function frame() {
        frameCount += 1;
        var diffX = neko.posX - mousePosX;
        var diffY = neko.posY - mousePosY;
        var distance = Math.sqrt(Math.pow(diffX, 2) + Math.pow(diffY, 2));

        if (distance < neko.speed || distance < 48) {
            idle();
            return;
        }

        idleAnimation = null;
        idleAnimationFrame = 0;

        if (idleTime > 1) {
            setSprite('alert', 0);
            idleTime = Math.min(idleTime, 7);
            idleTime -= 1;
            return;
        }

        var direction;
        direction = diffY / distance > 0.5 ? 'N' : '';
        direction += diffY / distance < -0.5 ? 'S' : '';
        direction += diffX / distance > 0.5 ? 'W' : '';
        direction += diffX / distance < -0.5 ? 'E' : '';
        setSprite(direction, frameCount);

        neko.posX -= (diffX / distance) * neko.speed;
        neko.posY -= (diffY / distance) * neko.speed;

        neko.posX = Math.min(Math.max(16, neko.posX), nekoEl.parentElement.clientWidth - 16);
        neko.posY = Math.min(Math.max(16, neko.posY), nekoEl.parentElement.clientHeight - 16);

        nekoEl.style.left = (neko.posX - 16).toString() + 'px';
        nekoEl.style.top = (neko.posY - 16).toString() + 'px';
    }

    init();

    return neko;
}</script>
            </a>
        </div>
    </div>
    <script type="text/tilescript">        
        var tiles = document.querySelectorAll('.tile');
        for (var i = 0; i < tiles.length; i++) {
            tiles[i].className += ' tile--flipped';
        }
        
        var TILE_SIZE_PX = document.body.clientWidth;
        var CONTAINER_SPAN_TILES = 50;
        
        var onekoContainerEl = document.querySelector('#oneko-container');
        onekoContainerEl.style.width = (TILE_SIZE_PX * CONTAINER_SPAN_TILES).toString() + 'px';
        onekoContainerEl.style.height = (TILE_SIZE_PX * CONTAINER_SPAN_TILES).toString() + 'px';
        onekoContainerEl.style.top = (TILE_SIZE_PX * Math.floor(CONTAINER_SPAN_TILES / 2) * -1).toString() + 'px';
        onekoContainerEl.style.left = (TILE_SIZE_PX * Math.floor(CONTAINER_SPAN_TILES / 2) * -1).toString() + 'px';
        
        var thisTileBounds = {
            x1: TILE_SIZE_PX * Math.floor(CONTAINER_SPAN_TILES / 2),
            y1: TILE_SIZE_PX * Math.floor(CONTAINER_SPAN_TILES / 2),
            x2: TILE_SIZE_PX * (Math.floor(CONTAINER_SPAN_TILES / 2) + 1),
            y2: TILE_SIZE_PX * (Math.floor(CONTAINER_SPAN_TILES / 2) + 1)
        };
        
        var nekoPos = TILE_SIZE_PX * (CONTAINER_SPAN_TILES + (CONTAINER_SPAN_TILES % 2 ? 0 : 1)) / 2;
        
        var hasNekoShownHerMagicTrickYet = false;
        var neko = initTileOneko({
            nekoPosX: nekoPos,
            nekoPosY: nekoPos - TILE_SIZE_PX * 0.25,
            onAnimationFrame: function() {
                if (
                    !hasNekoShownHerMagicTrickYet && (
                        neko.posX < thisTileBounds.x1 ||
                        neko.posX > thisTileBounds.x2 ||
                        neko.posY < thisTileBounds.y1 ||
                        neko.posY > thisTileBounds.y2
                    )
                ) {
                    document.querySelector('.tile--backside').className += ' neko-has-breached-confinement';
                    hasNekoShownHerMagicTrickYet = true;
                }
            }
        });
    </script>
    <a href="test1.html" style="position: absolute; top: 0; right: 0; width: 1px; aspect-ratio: 1; display: none;"></a>
</body>
</html>
