import { checkSupabaseConfig } from "@/lib/supabase"
import { createServerSupabaseClient } from "@/lib/auth-server"
import { Button } from "@/components/ui/button"
import Link from "next/link"
import { Star, AlertCircle, BookOpen, Calendar, Eye } from "lucide-react"
import Image from "next/image"
import { Database } from "@/lib/database.types"

export const dynamic = 'force-dynamic'

type BookReview = Database['public']['Tables']['book_reviews']['Row']

async function getReviews(): Promise<BookReview[] | null> {
  try {
    const supabase = await createServerSupabaseClient()

    const { data, error } = await supabase
      .from('book_reviews')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(20)

    if (error) {
      console.error('Error fetching reviews:', error)
      return []
    }

    return data || []
  } catch (error) {
    console.error('Error in getReviews:', error)
    return null
  }
}

function StarRating({ rating }: { rating: number }) {
  return (
    <div className="flex items-center gap-0.5">
      {Array.from({ length: 5 }).map((_, i) => (
        <Star           key={i}
          className={`size-3.5 ${
            i < rating
              ? 'fill-amber-400 text-amber-400'
              : 'text-muted-foreground/30'
          }`}
        ></Star>
      ))}
    </div>
  )
}

export default async function HomePage() {
  const configCheck = checkSupabaseConfig()
  const reviews = await getReviews()

  if (!configCheck.isConfigured) {
    return (
      <div className="container mx-auto max-w-2xl px-4 py-8">
        <div className="rounded-xl bg-destructive/5 p-6">
          <div className="flex items-center gap-2 mb-4">
            <AlertCircle className="size-5 text-destructive" ></AlertCircle>
            <h2 className="font-semibold text-destructive">Supabase 설정 필요</h2>
          </div>
          <p className="text-sm text-muted-foreground whitespace-pre-line mb-4">
            {configCheck.message}
          </p>
          <div className="rounded-lg bg-muted p-4 font-mono text-xs">
            <div className="mb-2 font-semibold">누락된 환경 변수:</div>
            <ul className="list-disc list-inside space-y-1">
              {configCheck.missing?.map((key) => (
                <li key={key}>{key}</li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto max-w-6xl px-4 py-8">
      {/* 헤더 섹션 */}
      <header className="mb-10">
        <h1 className="text-4xl font-bold tracking-tight mb-2">책 후기</h1>
        <p className="text-muted-foreground text-lg">
          읽은 책에 대한 감상평을 공유해보세요
        </p>
      </header>

      {reviews === null ? (
        <div className="py-16 text-center">
          <div className="inline-flex items-center justify-center size-16 rounded-full bg-muted mb-4">
            <AlertCircle className="size-8 text-muted-foreground" ></AlertCircle>
          </div>
          <p className="text-muted-foreground">
            데이터베이스 연결에 문제가 발생했습니다.
          </p>
        </div>
      ) : reviews.length === 0 ? (
        <div className="py-16 text-center">
          <div className="inline-flex items-center justify-center size-16 rounded-full bg-muted mb-4">
            <BookOpen className="size-8 text-muted-foreground" ></BookOpen>
          </div>
          <p className="text-lg font-medium mb-2">아직 작성된 후기가 없습니다</p>
          <p className="text-muted-foreground mb-6">
            첫 번째 책 후기를 작성해보세요!
          </p>
          
        </div>
      ) : (
        <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {reviews.map((review) => (
            
          ))}
        </div>
      )}
    </div>
  )
}
</BookReview[]>