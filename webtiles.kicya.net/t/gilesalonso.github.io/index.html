<!DOCTYPE html>
<html lang="en">
<head>
    <style>* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

.tile-body {
  user-select: none;
  color: #fff;
  background: #000;
  width: 250px;
  height: 250px;
  font-family: Courier New, monospace;
  position: relative;
  overflow: hidden;
}

canvas {
  background: #000;
  outline: none;
  width: 250px;
  height: 250px;
  display: block;
}

#startZone {
  z-index: 999;
  cursor: pointer;
  pointer-events: auto;
  background: none;
  justify-content: center;
  align-items: center;
  width: 250px;
  height: 250px;
  display: flex;
  position: absolute;
  top: 0;
  left: 0;
}

#startZone.hidden {
  display: none;
}

.blink-wrapper {
  pointer-events: none;
  background: #0009;
  border: 1px solid #0f0;
  border-radius: 4px;
  padding: 10px;
  box-shadow: 0 0 10px #0f03;
}

.blink-text {
  color: #0f0;
  text-shadow: 0 0 4px #0f0;
  text-align: center;
  font-size: 12px;
  font-weight: bold;
  line-height: 1.4;
  animation: .8s step-end infinite blink;
  display: block;
}

#heroLayer, #gameLayer {
  width: 250px;
  height: 250px;
  position: absolute;
  top: 0;
  left: 0;
}

#heroLayer {
  z-index: 50;
  pointer-events: none;
}

#gameLayer {
  z-index: 100;
}

#heroLayer.hidden, #gameLayer.hidden {
  display: none;
}

#gameUI {
  pointer-events: none;
  text-shadow: 1px 1px #000;
  font-size: 12px;
  font-weight: bold;
  position: absolute;
  top: 5px;
  left: 5px;
}

#touchControls {
  opacity: .6;
  pointer-events: auto;
  justify-content: space-between;
  width: 100%;
  padding: 0 5px;
  display: flex;
  position: absolute;
  bottom: 5px;
  left: 0;
}

#touchControls:hover {
  opacity: 1;
}

.touch-btn {
  color: #fff;
  cursor: pointer;
  text-align: center;
  background: #ffffff26;
  border: 1px solid #fff6;
  border-radius: 50%;
  width: 35px;
  height: 35px;
  margin: 0 2px;
  padding: 0;
  font-size: 18px;
  line-height: 35px;
}

.touch-btn:active {
  color: #000;
  background: #fff;
}

.fire-btn {
  color: #f55;
  border-color: #f55;
  width: 40px;
  height: 40px;
  line-height: 40px;
}

#gameOverScreen {
  text-align: center;
  z-index: 200;
  background: #000000f2;
  border: 2px solid #fff;
  width: 200px;
  padding: 15px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 0 10px #fff3;
}

#gameOverScreen.hidden {
  display: none;
}

.go-title {
  color: red;
  margin-bottom: 10px;
  font-size: 18px;
  font-weight: bold;
}

.nav-row {
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
  display: flex;
}

.nav-btn {
  color: #fff;
  cursor: pointer;
  background: #333;
  border: 1px solid #fff;
  border-radius: 50%;
  justify-content: center;
  align-items: center;
  width: 35px;
  height: 35px;
  font-size: 16px;
  text-decoration: none;
  display: flex;
}

.nav-btn:hover {
  color: #000;
  background: #fff;
}

.accent-btn {
  color: #0f0;
  border-color: #0f0;
}

@keyframes blink {
  0%, 100% {
    opacity: 1;
  }

  50% {
    opacity: 0;
  }
}
</style>
</head>
<body>
    <div id="startZone">
        <div class="blink-wrapper">
            <span class="blink-text">INSERT COIN<br>CLICK TO START</span>
        </div>
    </div>
    <div id="heroLayer">
        <canvas id="attractCanvas" width="250" height="250"></canvas>
    </div>
    <div id="gameLayer" class="hidden">
        <canvas id="gameCanvas" width="250" height="250" tabindex="0"></canvas>
        <div id="gameUI">SCORE: <span id="scoreVal">0</span></div>
        <div id="touchControls">
            <div class="d-pad">
                <button id="btnLeft" class="touch-btn">←</button>
                <button id="btnThrust" class="touch-btn">↑</button>
                <button id="btnRight" class="touch-btn">→</button>
            </div>
            <button id="btnFire" class="touch-btn fire-btn">●</button>
        </div>
        <div id="gameOverScreen" class="hidden">
            <div class="go-title">GAME OVER</div>
            <div class="go-score">SCORE: <span id="finalScore">0</span></div>
            <div class="nav-row">
                
                <button id="btnRestart" class="nav-btn" title="Back to Menu">&#x21bb;</button>
                <a href="https://giles.vercel.app/" target="_blank" class="nav-btn accent-btn" title="Portfolio">&#x279c;</a>
            </div>
        </div>
    </div>
    <script type="text/tilescript">(function () {
    // --- VARIABLES ---
    var currentState = 0; // 0=Attract, 1=Game, 2=Over
    var loopTimer = null;
    
    // Elements
    var startZone = document.getElementById('startZone');
    var heroLayer = document.getElementById('heroLayer');
    var gameLayer = document.getElementById('gameLayer');
    var gameOverScreen = document.getElementById('gameOverScreen');
    var btnRestart = document.getElementById('btnRestart');
    var scoreEl = document.getElementById('scoreVal');
    
    var attractCanvas = document.getElementById('attractCanvas');
    var gameCanvas = document.getElementById('gameCanvas');

    // Contexts
    var actx = (attractCanvas && attractCanvas.getContext) ? attractCanvas.getContext('2d') : null;
    var ctx = (gameCanvas && gameCanvas.getContext) ? gameCanvas.getContext('2d') : null;

    // Constants
    var W = 250;
    var H = 250;

    // --- 1. EVENT LISTENERS ---
    
    function safeAdd(el, evt, fn) {
        if (el && el.addEventListener) el.addEventListener(evt, fn);
    }

    // A. Start Game
    safeAdd(startZone, 'click', function() {
        if (currentState !== 0) return;
        currentState = 1;
        
        startZone.className = "hidden";
        heroLayer.className = "hidden";
        gameLayer.className = "";
        
        if (loopTimer) clearTimeout(loopTimer);
        setTimeout(startGame, 50);
    });

    // B. Back to Menu
    safeAdd(btnRestart, 'click', function() {
        resetToMenu();
    });

    function resetToMenu() {
        currentState = 0;
        
        // Reset UI
        if(gameOverScreen) gameOverScreen.className = "hidden";
        if(gameLayer) gameLayer.className = "hidden";
        if(heroLayer) heroLayer.className = "";
        if(startZone) startZone.className = "";

        // Stop Game
        if(loopTimer) clearTimeout(loopTimer);

        // Reset Attract Variables
        initAttractVariables();
        loopAttract();
    }

    // Inputs
    var keys = { left:false, right:false, up:false, fire:false };

    // Keyboard
    if (gameCanvas) {
        gameCanvas.addEventListener('keydown', function(e) {
            if (currentState !== 1) return;
            var c = e.keyCode;
            if(c===37||c===65) keys.left=true;
            if(c===39||c===68) keys.right=true;
            if(c===38||c===87) keys.up=true;
            if(c===32) keys.fire=true;
        });

        gameCanvas.addEventListener('keyup', function(e) {
            if (currentState !== 1) return;
            var c = e.keyCode;
            if(c===37||c===65) keys.left=false;
            if(c===39||c===68) keys.right=false;
            if(c===38||c===87) keys.up=false;
            if(c===32) keys.fire=false;
        });
    }

    // Touch
    function bindTouch(id, k) {
        var el = document.getElementById(id);
        if(el) {
            safeAdd(el, 'mousedown', function(e){ e.preventDefault(); keys[k]=true; });
            safeAdd(el, 'mouseup', function(e){ e.preventDefault(); keys[k]=false; });
            safeAdd(el, 'touchstart', function(e){ e.preventDefault(); keys[k]=true; });
            safeAdd(el, 'touchend', function(e){ e.preventDefault(); keys[k]=false; });
        }
    }
    bindTouch('btnLeft','left');
    bindTouch('btnRight','right');
    bindTouch('btnThrust','up');
    bindTouch('btnFire','fire');

    // --- 2. ATTRACT MODE (ORIGINAL RECURSIVE FORMULA) ---
    
    // State variables must persist between frames for the shape to connect
    var t_math = 0;
    var pat_i = 0, pat_j = 0;
    var x_val = 0, u_val = 0, v_val = 0;

    function initAttractVariables() {
        t_math = Math.random() * 4;
        pat_i = 0; 
        pat_j = 0;
        x_val = 0; 
        u_val = 0; 
        v_val = 0;
        
        // Clear screen
        if(actx) {
            actx.fillStyle = '#000';
            actx.fillRect(0, 0, W, H);
        }
    }
    
    function loopAttract() {
        if (currentState !== 0) return;
        if (!actx) return;

        // SCALE: 42 fills the 250px box nicely with this specific math
        var scale = 42; 
        var r = (2 * Math.PI) / 235;
        
        // Draw 400 dots per frame
        for (var k = 0; k < 400; k++) {
            if (pat_i >= 250) break;
            
            // --- THE ORIGINAL FORMULA ---
            // Relying on previous state of x_val, u_val, v_val
            var new_u = Math.sin(pat_i + v_val) + Math.sin(r * pat_i + x_val);
            var new_v = Math.cos(pat_i + v_val) + Math.cos(r * pat_i + x_val);
            var new_x = new_u + t_math;
            
            // Update state
            u_val = new_u;
            v_val = new_v;
            x_val = new_x;
            
            var px = Math.floor((W/2) + scale * u_val);
            var py = Math.floor((H/2) + scale * v_val);

            if (px >= 0 && px < W && py >= 0 && py < H) {
                var rr = Math.floor((pat_i * 3) % 255);
                var gg = Math.floor((pat_j * 2) % 255);
                var bb = Math.floor((255 - (pat_i + pat_j) / 2) % 255);
                
                // Color boost
                rr = Math.min(255, rr + 50);
                gg = Math.min(255, gg + 50);
                bb = Math.min(255, bb + 20);
                
                actx.fillStyle = 'rgb(' + rr + ',' + gg + ',' + bb + ')';
                actx.fillRect(px, py, 1, 1);
            }
            
            pat_j++;
            if (pat_j >= 250) { 
                pat_j = 0; 
                pat_i++; 
            }
        }
        
        if (pat_i >= 250) {
            // Pause 3 seconds, then restart with new shape
            loopTimer = setTimeout(function() {
                if (currentState !== 0) return;
                initAttractVariables();
                loopAttract();
            }, 3000);
        } else {
            loopTimer = setTimeout(loopAttract, 20);
        }
    }

    // --- 3. GAME MODE (Asteroids) ---
    
    var ship = {}, bullets = [], asteroids = [], particles = [];
    var score = 0;
    var lastShot = 0;

    function startGame() {
        if (!ctx) return;
        if (gameCanvas.focus) gameCanvas.focus();
        
        score = 0;
        if(scoreEl) scoreEl.textContent = "0";
        
        ship = { x: W/2, y: H/2, a: -1.57, vx: 0, vy: 0, dead: false, invuln: 100 };
        bullets = []; asteroids = []; particles = [];
        keys.left=false; keys.right=false; keys.up=false; keys.fire=false;
        
        spawnAsteroid(true); spawnAsteroid(true); spawnAsteroid(true);
        
        gameLoop();
    }

    function spawnAsteroid(isBig, x, y) {
        var a = {
            x: (x!==undefined) ? x : Math.random()*W,
            y: (y!==undefined) ? y : Math.random()*H,
            vx: (Math.random()-0.5) * (isBig?1.0:1.5),
            vy: (Math.random()-0.5) * (isBig?1.0:1.5),
            size: isBig ? 18 : 10,
            pts: [],
            big: isBig
        };
        if(x===undefined) {
            var d = Math.sqrt((a.x-W/2)*(a.x-W/2) + (a.y-H/2)*(a.y-H/2));
            if(d < 60) a.x += 80;
        }
        var vCount = 6 + Math.floor(Math.random()*4);
        for(var j=0; j<vCount; j++) {
            var ang = (j/vCount)*Math.PI*2;
            var rad = a.size * (0.8 + Math.random()*0.4);
            a.pts.push({ x: Math.cos(ang)*rad, y: Math.sin(ang)*rad });
        }
        asteroids.push(a);
    }

    function gameLoop() {
        if (currentState !== 1) return;

        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, W, H);

        if (!ship.dead) {
            if (keys.left) ship.a -= 0.12;
            if (keys.right) ship.a += 0.12;
            if (keys.up) {
                ship.vx += Math.cos(ship.a)*0.15;
                ship.vy += Math.sin(ship.a)*0.15;
                particles.push({x:ship.x-Math.cos(ship.a)*8, y:ship.y-Math.sin(ship.a)*8, vx:0, vy:0, life:5, c:'#f90'});
            }
            ship.vx *= 0.95; ship.vy *= 0.95;
            ship.x += ship.vx; ship.y += ship.vy;
            
            if(ship.x<0) ship.x=W; if(ship.x>W) ship.x=0;
            if(ship.y<0) ship.y=H; if(ship.y>H) ship.y=0;
            if(ship.invuln > 0) ship.invuln--;

            if (keys.fire && (new Date().getTime() - lastShot > 300)) {
                bullets.push({
                   x: ship.x+Math.cos(ship.a)*12, y: ship.y+Math.sin(ship.a)*12,
                   vx: ship.vx+Math.cos(ship.a)*4, vy: ship.vy+Math.sin(ship.a)*4, life: 40
                });
                lastShot = new Date().getTime();
            }
        }

        ctx.fillStyle = '#ff0';
        for(var b=bullets.length-1; b>=0; b--) {
            var bu = bullets[b];
            bu.x += bu.vx; bu.y += bu.vy; bu.life--;
            if(bu.x<0) bu.x=W; if(bu.x>W) bu.x=0;
            if(bu.y<0) bu.y=H; if(bu.y>H) bu.y=0;
            if(bu.life<=0) { bullets.splice(b,1); continue; }
            ctx.fillRect(bu.x-1, bu.y-1, 2, 2);
        }

        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1.5;
        for(var i=asteroids.length-1; i>=0; i--) {
            var ast = asteroids[i];
            ast.x += ast.vx; ast.y += ast.vy;
            if(ast.x<0) ast.x=W; if(ast.x>W) ast.x=0;
            if(ast.y<0) ast.y=H; if(ast.y>H) ast.y=0;

            ctx.beginPath();
            ctx.moveTo(ast.x+ast.pts[0].x, ast.y+ast.pts[0].y);
            for(var p=1; p<ast.pts.length; p++) ctx.lineTo(ast.x+ast.pts[p].x, ast.y+ast.pts[p].y);
            ctx.closePath();
            ctx.stroke();

            var hit = false;
            for(var b=bullets.length-1; b>=0; b--) {
                var dx = ast.x - bullets[b].x;
                var dy = ast.y - bullets[b].y;
                if (Math.sqrt(dx*dx+dy*dy) < ast.size) {
                    bullets.splice(b,1);
                    asteroids.splice(i,1);
                    hit = true;
                    score += ast.big ? 100 : 200;
                    if(scoreEl) scoreEl.textContent = score;
                    for(var k=0; k<6; k++) particles.push({x:ast.x, y:ast.y, vx:(Math.random()-0.5)*3, vy:(Math.random()-0.5)*3, life:15, c:'#aaa'});
                    if(ast.big) {
                        spawnAsteroid(false, ast.x, ast.y);
                        spawnAsteroid(false, ast.x, ast.y);
                    }
                    if(asteroids.length===0) setTimeout(function(){ for(var n=0;n<3;n++) spawnAsteroid(true); }, 1000);
                    break;
                }
            }
            if(hit) continue;

            if(!ship.dead && ship.invuln <= 0) {
                 var sdx = ast.x - ship.x;
                 var sdy = ast.y - ship.y;
                 if (Math.sqrt(sdx*sdx+sdy*sdy) < ast.size + 6) {
                     ship.dead = true;
                     currentState = 2; // Game Over
                     if(gameOverScreen) {
                         var fs = document.getElementById('finalScore');
                         if(fs) fs.textContent = score;
                         gameOverScreen.className = "";
                     }
                 }
            }
        }

        for(var p=particles.length-1; p>=0; p--) {
            var pt = particles[p];
            pt.x += pt.vx; pt.y += pt.vy; pt.life--;
            if(pt.life<=0) { particles.splice(p,1); continue; }
            ctx.fillStyle = pt.c;
            ctx.fillRect(pt.x, pt.y, 2, 2);
        }

        if(!ship.dead) {
            if(Math.floor(ship.invuln/5)%2===0) {
                ctx.strokeStyle = '#0f0';
                ctx.save();
                ctx.translate(ship.x, ship.y);
                ctx.rotate(ship.a);
                ctx.beginPath();
                ctx.moveTo(10,0); ctx.lineTo(-7,6); ctx.lineTo(-7,-6); ctx.closePath();
                ctx.stroke();
                ctx.restore();
            }
        }

        loopTimer = setTimeout(gameLoop, 20);
    }

    // --- INIT ---
    initAttractVariables();
    loopAttract();

})();</script>
</body>
</html>