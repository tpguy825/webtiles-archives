<!DOCTYPE html>
<html lang="en">
<head>
    <style>.tile-body {
  color: #111;
  background-color: #f0f0f0;
  margin: 0;
}

#plink {
  width: 100%;
  height: 100%;
}

#footer {
  box-sizing: border-box;
  color: #000;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: .5rem;
  display: flex;
  position: absolute;
  bottom: 0;
}

#footer h1 {
  margin: 0;
  font-size: 1rem;
}

:not(.active) #mute {
  display: none;
}

.active #mute {
  cursor: pointer;
  color: #00f;
  text-decoration: underline;
  display: block;
}
</style>
</head>
<body>
    <img id="plink" src="plinKhd.webp">
    
    <div id="footer">
        <h1>plinK</h1>
        
        <h1 id="click">click on me!</h1>
        
        <a id="mute"></a>
    </div>
    
    <audio id="music" src="jreast_loop.mp3" loop preload="metadata"></audio>
    
    <script type="text/tilescript">console.log("plinK")

var click = document.getElementById("click")
click.style["display"] = "none"

var music = document.getElementById("music")

function setVolume(volume) {
    localStorage.setItem("volume", volume)
    music.volume = volume
}

function getVolume() {
    var volume = localStorage.getItem("volume")
    
    if (!volume)
        volume = 0.1
    else
        volume = parseFloat(volume)
    
    return volume
}

music.volume = getVolume()
music.play()

var mute = document.getElementById("mute")

function updateMuteText() {
    if (music.volume !== 0) {
        mute.innerText = "mute song"
    } else {
        mute.innerText = "unmute song"
    }
}

updateMuteText()
mute.onclick = function() {
    setVolume(music.volume !== 0 ? 0 : 0.1)
    music.currentTime = 0
    
    updateMuteText()
}</script>
    
    
    <style>:not(.active) #lastfm-widget {
  opacity: 0 !important;
}

#lastfm-widget {
  box-sizing: border-box;
  color: #fff;
  background: linear-gradient(#000b, #0000);
  flex-direction: column;
  gap: .4rem;
  padding: .3rem .5rem;
  font-size: .7rem;
  transition-duration: 1s;
  display: flex;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
}

#lastfm-widget #lastfm-info {
  justify-content: space-between;
  padding: 0 .5rem;
  display: flex;
}

#lastfm-widget #lastfm-profile {
  color: red;
}

#lastfm-widget #lastfm-song {
  color: #fff;
  grid-template-columns: min-content 1fr;
  gap: .5rem;
  text-decoration: none;
  display: grid;
}

#lastfm-widget #lastfm-cover {
  display: none;
}

#lastfm-widget #lastfm-cover[src] {
  aspect-ratio: 1;
  border-radius: 5px;
  width: 40px;
  display: block;
}

#lastfm-widget #lastfm-metadata {
  flex-direction: column;
  justify-content: center;
  gap: 5px;
  width: 170px;
  display: flex;
}

#lastfm-widget #lastfm-metadata > span {
  text-overflow: ellipsis;
  text-wrap: nowrap;
  width: 100%;
  display: inline-block;
  overflow: hidden;
}
</style>
    <div id="lastfm-widget" style="opacity:0;">
        <div id="lastfm-info">
            <span id="lastfm-status">loading...</span>
            
            <a id="lastfm-profile">lastfm</a>
        </div>
        
        <a id="lastfm-song">
            <img id="lastfm-cover" >

            <div id="lastfm-metadata">
                <span id="lastfm-title" style="font-weight: bold;"></span>
                <span id="lastfm-artist"></span>
            </div>
        </a>
    </div>
    <script type="text/tilescript">// last fm presence widget for webtiles written by nekoramuza [kat.nekoweb.org]
function lastfm() {
    // lastfm username
    var username = "xtract_"
    // display link to lastfm profile
    var profile_link = true
    // display username on profile link
    var display_username = false

    // image that is displayed when no cover is found
    var nocover = "/notfound.jpg"
    // shows even when not ready yet i.e. hasn't recieved first response from api
    var always_show = true

    // text for currently / last listened to song
    var currently_listening = "i'm currently listening to"
    var last_listened = "i last listened to"

    // update interval in seconds
    var update_interval = 15

    // enables logging if true
    var debug = false
    // enables showing errors in the status element if true
    var show_errors = true

    // END OF CONFIG

    // get elements
    var lastfmElement = document.getElementById("lastfm-widget")
    var profileElement = document.getElementById("lastfm-profile")
    var statusElement = document.getElementById("lastfm-status")
    var coverElement = document.getElementById("lastfm-cover")
    var linkElement = document.getElementById("lastfm-song")
    var titleElement = document.getElementById("lastfm-title")
    var artistElement = document.getElementById("lastfm-artist")

    // set the profile link to the lastfm user link
    if (profile_link) {
        if (display_username)
            profileElement.innerText = username

        profileElement.href = "https://www.last.fm/user/" + username
    }

    // logging functions that can be disabled as to not clutter the console
    function log(text) {
        if (debug)
            console.log(text)
    }

    function error(text, status) {
        if (debug)
            console.error(text)
        
        if (show_errors && status)
            setStatus(text, true)
    }

    function request(uri, callback, errorCallback) {
        var xhr = new XMLHttpRequest()

        xhr.onload = function() {
            callback(xhr.response)
        }
        
        var err = function(e) {
            error(e)

            errorCallback(e)
        }
        
        xhr.onerror = function(e) {
			err("request error")
        }
        
        xhr.onabort = function(e) {
            err("request aborted")
        }
        
        xhr.ontimeout = function(e) {
            err("request timed out")
        }

        xhr.open("GET", uri, true)

        xhr.send(null)
    }

    // XMLHttpRequest json wrapper
    function requestJSON(uri, callback, errorCallback) {
        request(uri, function(res) {
            var json = JSON.parse(res)

            callback(json)
        }, errorCallback)
    }

    function setStatus(text, error) {
        statusElement.innerText = text
        statusElement.style["color"] = (error ? "red" : "")
    }

    function updateElement(playing, title, artist, url, cover) {
        log("update lastfm element")

        // unforunately, due to webtile limitations, outside urls are not allowed meaning no covers :(
        // coverElement.src = cover
        coverElement.src = nocover
        
        setStatus(playing ? currently_listening : last_listened)
        linkElement.href = url
        titleElement.innerText = title
        artistElement.innerText = artist
    }

    function setElementVisibility(visible) {
        if (visible) {
            lastfmElement.style["opacity"] = ""
        } else {
            lastfmElement.style["opacity"] = "0"
        }
    }
    
    if (always_show)
        setElementVisibility(true)

    var lastCompleted = true
    var nowPlaying = null
    function updateSong() {
        if (!lastCompleted) {
            log("last request incomplete, skipping")
            return;
        }
		
        lastCompleted = false
        log("requesting lastfm data")
        requestJSON("https://lastfm-last-played.biancarosa.com.br/" + username + "/latest-song", function(data) {
            log("recieved lastfm data")

            var song = data.track

            if (!song) {
                error("no song present")
                lastCompleted = true
                return;
            }

            if (song.message) {
                error("lastfm data error")
                lastCompleted = true
                return;
            }

            var playing = (song["@attr"] && song["@attr"].nowplaying) === "true"

            var name = song.name
            var artist = song.artist["#text"]

            var songIdentifier = name + artist
            if (songIdentifier === nowPlaying) {
                log("song already up to date")
                lastCompleted = true
                return;
            }

            nowPlaying = songIdentifier

            var url = song.url
            var cover = song.image[0]["#text"]

            updateElement(playing, name, artist, url, cover)
            setElementVisibility(true)
            
            lastCompleted = true
            log("completed song update")
        }, function(e) {
            lastCompleted = true
            error("error retrieving lastfm data", true)
        })
    }

    // start update
    updateSong()
	setInterval(updateSong, update_interval * 1000)
}

lastfm()</script>
    
</body>
</html>