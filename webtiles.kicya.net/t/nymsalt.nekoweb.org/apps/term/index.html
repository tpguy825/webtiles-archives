<!doctype html>
<html lang="en">
    <head>
        <style>.tile-body {
  color: #191511;
  width: 250px;
  height: 250px;
  image-rendering: pixelated;
  background-color: #ff6a00;
  background-image: url("../../img/iotadot.png");
  margin: 0;
  font-family: MS UI Gothic, Unifont, Times New Roman, Times, serif;

  &:has( > component[name="wallpaper"][preset="none"]) {
    background-image: none;
  }

  &:has( > component[name="wallpaper"][preset="corporate"]) {
    background-image: url("../../img/iotacorporate.png");
  }
}

.icon {
  background-image: url("../../img/icons.png");
  width: 20px;
  height: 20px;

  &.icon-apps {
    background-position-x: -20px;
  }
}

#nav {
  background: #ffd2b2;
  border-bottom: thick solid #191511;
  flex-direction: row;
  justify-content: space-between;
  height: 20px;
  padding: 5px;
  display: flex;

  & #apps-toggle {
    cursor: pointer;
    opacity: 0;
    width: 20px;
    height: 20px;
    padding: 5px;
  }

  & label[for="apps-toggle"] {
    display: none;
  }
}

#list {
  margin: 0;
  padding: 0;
  list-style-type: none;
  display: none;

  & li {
    background: #ffd2b2;
    border-bottom: thin solid #191511;
    padding-left: 1em;

    &:last-child {
      border-bottom: thick solid #191511;
    }
  }
}

.appview {
  background: #ffd2b2;
  border-bottom: thin solid #ffd2b2;
  width: 250px;
  height: 215px;

  &#terminal {
    color: #fff;
    background: #000;
    border-bottom: thin solid #000;
    flex-direction: column;
    display: flex;

    & span.line {
      height: 20px;
      margin-left: .5em;
    }

    & input[type="text"] {
      color: #fff;
      background: #000;
      border: thin solid #fff;
      width: 98%;
      height: 15px;
      font-family: MS UI Gothic, Unifont, Times New Roman, Times, serif;
    }
  }

  &#files {
    & [hidden] {
      display: none;
    }

    & .files-controls {
      flex-direction: row;
      justify-content: space-between;
      padding-left: .5em;
      padding-right: .5em;
      display: flex;

      &[top] {
        border-bottom: thick solid #191511;
      }

      &[bottom] {
        border-top: thick solid #191511;
      }

      & div {
        flex-direction: row;
        justify-content: space-between;
        display: flex;
      }

      & #previous-page, & #next-page {
        cursor: pointer;
        user-select: none;
        padding: 0 1em;
      }
    }

    & #files-list {
      & div.line {
        border-bottom: thin solid #191511;
        height: 23px;
        padding-left: .5em;

        &:hover {
          cursor: pointer;
          filter: brightness(110%);
          background: #ffd2b2;
        }

        &:last-child {
          border-bottom: none;
        }
      }
    }

    & #files-edit {
      width: 100%;
      height: 250px;
    }
  }

  &#settings {
    & #settings-controls {
      border-bottom: thick solid #191511;
      flex-direction: row;
      justify-content: space-between;
      padding-left: .5em;
      padding-right: .5em;
      display: flex;

      & div {
        flex-direction: row;
        justify-content: space-between;
        display: flex;
      }

      & a {
        color: inherit;
        text-decoration: none;
      }
    }

    & #settings-options {
      flex-direction: column;
      display: flex;

      & .line {
        border-bottom: thin solid #191511;
        height: 23px;
        padding-left: .5em;

        &:hover {
          cursor: pointer;
          filter: brightness(110%);
          background: #ffd2b2;
        }

        &:last-child {
          border-bottom: none;
        }
      }
    }

    & #wallpaper-choices {
      flex-direction: row;
      justify-content: space-evenly;
      display: flex;

      & .wallpaper-choice {
        cursor: pointer;
        flex-direction: column;
        display: flex;

        & input {
          display: none;
        }

        &:has( > input:checked) {
          & img {
            border: thick solid #191511;
          }
        }

        & img {
          background: #ff6a00;
          width: 80px;
          height: 80px;
        }
      }
    }

    & #wallpaper-name {
      text-align: center;
      font-weight: bold;
    }

    &:has(#first-wallpaper-choice > input:checked) #wallpaper-name:after {
      content: "default";
    }

    &:has(#second-wallpaper-choice > input:checked) #wallpaper-name:after {
      content: "none";
    }

    &:has(#third-wallpaper-choice > input:checked) #wallpaper-name:after {
      content: "corporate";
    }
  }
}

button {
  cursor: pointer;
}

.tile-body {
  &:has(#apps-toggle:checked) {
    & #list {
      display: inline;
    }
  }
}
</style>
    </head>
    <body>
        
        <component id="wallpaper-component" name="wallpaper" preset="default"></component>

        <audio src="../../sfx/click2.wav" id="sound-click" preload="metadata"></audio>
        <div id="nav">
            <div><a href="../../home/index.html" id="home-button">IOTA</a></div>
            <div class="icon icon-apps">
                <input type="checkbox" id="apps-toggle" autocomplete="off">
                <label for="apps-toggle">apps</label>
            </div>
        </div>
        <ul id="list">
            
            <li><a href="../files/index.html" id="fs-link">files</a></li>
            <li><a href="index.html" id="term-link">term</a></li>
            <li><a href="../settings/index.html" id="settings-link">settings</a></li>
        </ul>
        <div>
            
<div class="appview" id="terminal">
    <span class="line" id="tenth-line"></span>
    <span class="line" id="ninth-line"></span>
    <span class="line" id="eigth-line"></span>
    <span class="line" id="seventh-line"></span>
    <span class="line" id="sixth-line"></span>
    <span class="line" id="fifth-line"></span>
    <span class="line" id="fourth-line"></span>
    <span class="line" id="third-line"></span>
    <span class="line" id="second-line"></span>
    <span class="line" id="first-line"></span>
    <input type="text" placeholder="?" id="command-line" autocomplete="off">
</div>
<script defer type="text/tilescript">// to dimden or whoever is reading this after i'm spamming updates for this tile
// in the hopes of debugging where the file isn't parsing:
// sorry

var cmdline = document.getElementById("command-line");

var firstLine = document.getElementById("first-line");
var secondLine = document.getElementById("second-line");
var thirdLine = document.getElementById("third-line");
var fourthLine = document.getElementById("fourth-line");
var fifthLine = document.getElementById("fifth-line");
var sixthLine = document.getElementById("sixth-line");
var seventhLine = document.getElementById("seventh-line");
var eigthLine = document.getElementById("eigth-line");
var ninthLine = document.getElementById("ninth-line");
var tenthLine = document.getElementById("tenth-line");

var lines = ["(enter ? for help)", "// iotadot terminal //"];
var prefix = "";

function rerender() {
  firstLine.textContent = lines[0];
  secondLine.textContent = lines[1];
  thirdLine.textContent = lines[2];
  fourthLine.textContent = lines[3];
  fifthLine.textContent = lines[4];
  sixthLine.textContent = lines[5];
  seventhLine.textContent = lines[6];
  eigthLine.textContent = lines[7];
  ninthLine.textContent = lines[8];
  tenthLine.textContent = lines[9];
}

function cmd_help(n) {
  if (n == "n") {
    lines.unshift("?1 (terminal)");
    lines.unshift("?2 (file system)");
    lines.unshift("?3 (key-value)");
  } else if (n == "1") {
    lines.unshift("clear: clears the terminal");
    lines.unshift("prefix str: prefix file names with str");
  } else if (n == "2") {
    // ARROW BRACKETS IN STRINGS BREAK JSINTERPRETER????
    lines.unshift("fs0_out: outputs raw string");
    lines.unshift("fs0_wipe: deletes all files");
    lines.unshift("ls: outputs all files");
    lines.unshift("write file content");
    lines.unshift("touch file");
    lines.unshift("read file");
    lines.unshift("delete file");
    lines.unshift("(content HATES spaces)");
  } else if (n == "3") {
    lines.unshift("kv_set file key value");
    lines.unshift("kv_get file key");
    lines.unshift("kv_clear file key");
    lines.unshift("(value HATES spaces)");
  }
}

function cmd_clear() {
  lines = [];
}

function cmd_prefix(pre) {
  if (pre == undefined) {
    prefix = "";
    lines.unshift("cleared prefix");
  } else {
    prefix = pre;
    lines.unshift("prefixing with " + pre + "...");
  }
}

function cmd_ls() {
  var keys = Object.keys(fs0_parse());
  keys.forEach(function (v) {
    if (!v) {
      return;
    }
    lines.unshift(v);
  });
}

function cmd_write(name, value) {
  if (name == undefined) {
    return;
  }

  var obj = fs0_parse();
  fs0_write(obj, name, value);
  fs0_push(obj);
}

function cmd_delete(name) {
  var obj = fs0_parse();
  fs0_delete(obj, name);
  fs0_push(obj);
}

function cmd_read(name) {
  var obj = fs0_parse();
  lines.unshift(obj[name]);
}

function cmd_fs0_out() {
  lines.unshift(localStorage.getItem("fs0"));
}

function cmd_fs0_wipe() {
  fs0_push({});
}

function cmd_kv_set(name, key, value) {
  var buf = fs0_parse();
  var content = buf[name];
  var kv = kv_fromstring(content);
  kv[key] = value;
  var str = kv_tostring(kv);
  buf[name] = str;
  fs0_push(buf);
}

function cmd_kv_get(name, key) {
  var buf = fs0_parse();
  var content = buf[name];
  var kv = kv_fromstring(content);
  lines.unshift(kv[key]);
}

function cmd_kv_delete(name, key) {
  var buf = fs0_parse();
  var content = buf[name];
  var kv = kv_fromstring(content);
  kv[key] = undefined;
  var str = kv_tostring(kv);
  buf[name] = str;
  fs0_push(buf);
}

function runCommand(str) {
  var parsed = str.split(" "); // no strings :3
  var cmdlet = parsed[0];
  switch (cmdlet) {
    case "?":
      cmd_help("n");
      break;
    case "?n":
      cmd_help("n");
      break;
    case "??":
      cmd_help("n");
      break;
    case "?1":
      cmd_help("1");
      break;
    case "?2":
      cmd_help("2");
      break;
    case "?3":
      cmd_help("3");
      break;
    case "clear":
      cmd_clear();
      break;
    case "prefix":
      cmd_prefix(parsed[1]);
      break;
    case "pre":
      cmd_prefix(parsed[1]);
      break;
    case "p":
      cmd_prefix(parsed[1]);
      break;
    case "ls":
      cmd_ls();
      break;
    case "write":
      cmd_write(prefix + parsed[1], parsed[2]);
      break;
    case "delete":
      cmd_delete(prefix + parsed[1]);
      break;
    case "read":
      cmd_read(prefix + parsed[1]);
      break;
    case "touch":
      cmd_write(prefix + parsed[1], "");
      break;
    case "fs0_out":
      cmd_fs0_out();
      break;
    case "fs0_wipe":
      cmd_fs0_wipe();
      break;
    case "kv_get":
      cmd_kv_get(prefix + parsed[1], parsed[2]);
      break;
    case "kv_set":
      cmd_kv_set(prefix + parsed[1], parsed[2], parsed[3]);
      break;
    case "kv_delete":
      cmd_kv_delete(prefix + parsed, str);
      break;
    default:
      lines.unshift("cmdlet not found");
  }
}

// can't use form because e.preventDefault isn't supported
cmdline.addEventListener("keypress", function (e) {
  if (e.key !== "Enter") {
    return;
  }

  var command = cmdline.value;
  cmdline.value = "";
  lines.unshift("> " + command);
  runCommand(command);
  lines.length = 10;
  rerender();
});

rerender();
</script>

        </div>
        <script type="text/tilescript">// EVIL AND INTIMIDATING FILE SYSTEM!!! (0)
// syntax:
//  KEY␂VALUE␃...
// (␃ delimits files from each other, ␂ delimits name and content)
// pretty flat and uses the control pictures

/**
 * Returns a map of the file system.
 * Should also be the input for any changes.
 */
function fs0_parse() {
  var fs = localStorage.getItem("fs0");
  if (!fs) {
    fs = "";
  }

  var arr = fs.split("␃").map(function (value) {
    return value.split("␂");
  });
  var obj = {};
  arr.forEach(function (value) {
    obj[value[0]] = value[1];
  });
  return obj;
}

function fs0_push(obj) {
  var str = "";
  for (var key in obj) {
    if (key !== "") {
      str += key + "␂" + obj[key] + "␃";
    }
  }

  localStorage.setItem("fs0", str);
}

function fs0_valid(str) {
  if (str == null || str == undefined) {
    return false;
  }
  return (
    str.indexOf("␂") == -1 && str.indexOf("␃") == -1 && str.indexOf("\\") == -1
  );
}

function fs0_write(obj, name, content) {
  if (!(fs0_valid(name) && fs0_valid(content))) {
    return;
  }
  obj[name] = content;
}

function fs0_delete(obj, name) {
  if (fs0_valid(name)) {
    delete obj[name];
  }
}

// kv edit

function kv_tostring(obj) {
  var str = "";
  for (var key in obj) {
    if (key == "" || obj[key] == undefined) {
      continue;
    }
    str += key + "=" + obj[key] + "\n";
  }
  return str;
}

function kv_fromstring(str) {
  var obj = {};
  var split = str.split("\n").map(function (v) {
    return v.split("=", 2);
  }); // string[][]
  split.forEach(function (v) {
    obj[v[0]] = v[1];
  });
  return obj;
}

// wallpaper
var wallpaperComponent = document.getElementById("wallpaper-component");
var buf = fs0_parse();
var wallpapercfgcontent = buf["config/wallpaper"];
if (wallpapercfgcontent) {
  var kv = kv_fromstring(wallpapercfgcontent);
  switch (kv.preset) {
    case "none":
      wallpaperComponent.setAttribute("preset", "none");
      break;
    case "corporate":
      wallpaperComponent.setAttribute("preset", "corporate");
      break;
  }
}

// jolly stuff

var soundClick = document.getElementById("sound-click");

function playClick() {
  soundClick.pause();
  soundClick.currentTime = 0;
  soundClick.play();
}

function hookClick(id) {
  var element = document.getElementById(id);
  if (element) {
    element.addEventListener("click", playClick);
  }
}

hookClick("home-button");
hookClick("apps-toggle");
hookClick("fs-link");
hookClick("term-link");
hookClick("settings-link");
</script>
    </body>
</html>
