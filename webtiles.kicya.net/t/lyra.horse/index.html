<!DOCTYPE html>
<html lang="en">
<head>
</head>
<body>
    

    <p id="log" style="display:none">
        #
    </p>
    <div id="tileMain" style="position:absolute;inset:0;box-sizing:border-box;padding:8px;display:flex;flex-direction:column">
        <h1 style="margin:0">lyra.horse</h1>
        <p>hi! this webtile has a mini version of the antonymph web experience! you can play it with the button below - note that it contains music and moving visuals</p>
        <button id="startExperience">start experience</button>
        <p style="opacity:0.5;font-style:italic;margin:0;margin-top:4px;margin-left:auto;">(chromium-only)</p>
        <div style="flex:1"></div>
        <div style="display:flex;justify-content: space-between;align-items: flex-end;">
        <a href="https://lyra.horse/" target="_blank"><img src="lyra.horse.png"></a>
        <img src="icon.png">
        </div>
    </div>
    <style id="altStyle">
</style>
    <style id="mainStyle">.tile-body, .tile-body {
  box-sizing: border-box;
  background: #8cffdb;
  border: 2px solid #04593b;
  border-color: #fff #04593b #04593b #fff;
  font-family: serif;
}

* {
  cursor: url("cursor.png") 4 4, auto;
}

button, a, a > img {
  cursor: url("cursor_click.png") 4 4, auto;
}

img {
  image-rendering: pixelated;
}

#antonymphAudio {
  width: 750px;
  position: absolute;
  top: 550px;
  left: -250px;
}

#startExperience {
  color: #000;
  background: #b9b7fe;
  border: 1px solid #31306d;
  border-color: #ccceff #31306d #31306d #ccceff;
  outline: 1px solid #000;
  padding: 4px;
  box-shadow: inset -1px -1px #837dc1, 0 0 0 1px #000;
}

#tileMain ::selection {
  background: #fad542;
}

.aSquare {
  width: 250px;
  height: 250px;
  position: absolute;
}

:not(:has(#antonymphCheckbox:checked)):not(:has(#antonymphAudio:hover)):not(:has(#antonymphAudio:active)) .window {
  opacity: 0 !important;
}

.window {
  z-index: 9;
  pointer-events: none;
  background: #fff;
  border: 2px inset #eee;
  border-top: none;
  width: 250px;
  height: 250px;
  position: absolute;
  top: 500px;
  box-shadow: 1px 2px 4px #0004;
}

.windowTitle {
  color: #fff;
  box-sizing: border-box;
  z-index: -1;
  background: #00f;
  border: 2px inset #eee;
  border-bottom: none;
  height: 20px;
  padding-top: 1px;
  padding-left: 4px;
  position: absolute;
  top: -20px;
  left: -2px;
  right: -2px;
  box-shadow: 1px 2px 4px #0004;
}

.windowInner {
  contain: strict;
  box-sizing: border-box;
  width: 100%;
  height: 100%;
  overflow: clip;
}

.windowInner.bg1 {
  background: url("flash.png");
}

.windowInner.bg2 {
  background: url("image13_small.gif");
}

#backgroundDiv {
  mix-blend-mode: multiply;
  opacity: .5;
  pointer-events: none;
  width: 4000px;
  height: 4000px;
  position: absolute;
  bottom: 0;
  right: -1000px;
}

#backgroundGrid1, #backgroundGrid2 {
  background-blend-mode: difference, difference;
  mix-blend-mode: multiply;
  opacity: 0;
  pointer-events: none;
  background: linear-gradient(#000 50%, #fff 50%) 0 0 / 500px 500px, linear-gradient(-90deg, #000 50%, #fff 50%) 0 0 / 500px 500px;
  width: 4000px;
  height: 4000px;
  position: absolute;
  bottom: 0;
  right: -1000px;
}

#backgroundGrid2 {
  background-blend-mode: difference, difference;
  background: linear-gradient(#fff 50%, #000 50%) 0 0 / 500px 500px, linear-gradient(90deg, #fff 50%, #000 50%) 0 0 / 500px 500px;
}

.component {
  background: #d4d0c8;
  border: 1px solid gray;
  border-color: #fff gray gray #fff;
}

.textBox {
  border: 1px solid #fff;
  border-color: gray #fff #fff gray;
  margin: 2px;
  display: inline-block;
}

.textBox > div {
  background: #fff;
  border: 1px solid #d4d0c8;
  border-color: #404040 #d4d0c8 #d4d0c8 #404040;
  height: 14px;
}

.arrow {
  color: #000;
  font-weight: bold;
  position: absolute;
  right: 4px;
}

.icon {
  background: url("icons.png");
  width: 22px;
  height: 22px;
  display: inline-block;
}
</style>
    
    <audio src="antonymph_epic_cbr_96k.mp3" id="antonymphAudio" controls preload="metadata"></audio>
    <div id="backgroundGrid1"></div>
    <div id="backgroundGrid2"></div>
    <div id="backgroundDiv"></div>
    <input type="checkbox" id="antonymphCheckbox" style="display:none" autocomplete="off">

    <div class="window" id="window1"><div class="windowTitle">text</div><div class="windowInner"></div></div>
    <div class="window" id="window2"><div class="windowTitle">text</div><div class="windowInner"></div></div>
    <div class="window" id="window3"><div class="windowTitle">text</div><div class="windowInner"></div></div>
    <div class="window" id="window4"><div class="windowTitle">text</div><div class="windowInner"></div></div>
    <div class="window" id="window5"><div class="windowTitle">text</div><div class="windowInner"></div></div>








<script lyra type="text/tilescript">
        var DEBUG_MODE = false;
        var mainAudio = document.getElementById("antonymphAudio");
        var antonymphCheckbox = document.getElementById("antonymphCheckbox");
        var backgroundDiv = document.getElementById("backgroundDiv");
        var backgroundGrid1 = document.getElementById("backgroundGrid1");
        var backgroundGrid2 = document.getElementById("backgroundGrid2");
        var log = document.getElementById("log");

        var windows = [];
        var windowTitles = [];
        var windowContents = [];
        var popupState = [{
        x: -1,
        y: -1,
        w: -1,
        h: -1,
        lastEvent: -1,
        sillyHidden: false,
        lastMove: -1,
        lastResize: -1,
        lastUrl: '',
        lastHistory: '',
        restored: true,
      },{
        x: -1,
        y: -1,
        w: -1,
        h: -1,
        lastEvent: -1,
        sillyHidden: false,
        lastMove: -1,
        lastResize: -1,
        lastUrl: '',
        lastHistory: '',
        restored: true,
      },{
        x: -1,
        y: -1,
        w: -1,
        h: -1,
        lastEvent: -1,
        sillyHidden: false,
        lastMove: -1,
        lastResize: -1,
        lastUrl: '',
        lastHistory: '',
        restored: true,
      },{
        x: -1,
        y: -1,
        w: -1,
        h: -1,
        lastEvent: -1,
        sillyHidden: false,
        lastMove: -1,
        lastResize: -1,
        lastUrl: '',
        lastHistory: '',
        restored: true,
      },{
        x: -1,
        y: -1,
        w: -1,
        h: -1,
        lastEvent: -1,
        sillyHidden: false,
        lastMove: -1,
        lastResize: -1,
        lastUrl: '',
        lastHistory: '',
        restored: true,
      }];
        for (var i = 1; i<=5;i++) {
            windows.push(document.getElementById("window" + i));
        }
        for (var i = 1; i<=5;i++) {
            windowTitles.push(document.getElementById("window" + i).getElementsByClassName("windowTitle")[0]);
        }
        for (var i = 1; i<=5;i++) {
            windowContents.push(document.getElementById("window" + i).getElementsByClassName("windowInner")[0]);
        }
        var popups = [];
        for (var i = 1; i<=5;i++) {
            popups.push({document:{body:document.getElementById("window" + i).getElementsByClassName("windowInner")[0]}});
        }

        function asset(assetName) {
            return "/t/lyra.horse/./" + assetName;
        }

  function sillyHide(index) {
    if (popupState[index].sillyHidden) return;
    //popupState[index].sillyHidden = size(index, 100,100) && size(index, 0,0) && move(index, 0,0);
    //popupState[index].sillyHidden = size(index, 100,100) && size(index, 100,1) && move(index, 0,0);
    //popupState[index].sillyHidden = size(index, 100,100) && size(index, 100,1) && move(index, 0,50);
    windows[index].style.opacity = 0;
    popupState[index].sillyHidden = true;
  }

   function restorePopup(index, force) {
    if (popupState[index].restored && !force) return;
    popupState[index].restored = true;
  }

  function oneTime(index, currentBeat, desiredBeat) {
    if (popupState[index].lastEvent > currentBeat) {
      popupState[index].lastEvent = currentBeat;
    }
    if (currentBeat >= desiredBeat && currentBeat-desiredBeat < 1) {
      if (popupState[index].lastEvent < desiredBeat) {
        popupState[index].lastEvent = desiredBeat;
        return true;
      }
    }
    return false;
  }
        // var SONG_BPM = 147;
        // function getBeat() {
        //     return ((antonymphAudio.currentTime - 0.078) / (60/SONG_BPM))/4;
        // }
          var bpm = 132;
  function getCurrentBeat() {
    // return ((mainAudio.currentTime - 0.052) / (60/132))/4;
    return ((mainAudio.currentTime) / (60/bpm))/4;
  }

  function beatToMs(beat) {
    return beat * ((60/bpm)*4) * 1000;
  }

  function msToBeat(ms) {
    return (ms / 1000) / ((60/bpm)*4);
  }


        function animationFrame() {
            if (mainAudio.paused) {
                antonymphCheckbox.checked = false;
                return;
            } else {
                antonymphCheckbox.checked = getCurrentBeat() < 31.75;
            }
            mainLoop();
            setTimeout(animationFrame, 1000/120);
        }
        
        mainAudio.onplay = animationFrame;
    
    var isFirstStart = true;
        
        function startExperience() {
            if (isFirstStart) {
                // bypass #1 (2026-01-19T20:30Z)
                //document.getElementById("mainStyle").innerText += "\n:host:has(#antonymphCheckbox:checked), :host:has(#antonymphAudio:hover), :host:has(#antonymphAudio:active) {contain:initial!important;overflow:initial!important}";
                document.getElementById("altStyle").innerText = ":host:has(#antonymphCheckbox:checked), :host:has(#antonymphAudio:hover), :host:has(#antonymphAudio:active) {contain:initial!important;overflow:initial!important}";
                isFirstStart = false;
            }
            if (!mainAudio.paused) {
                mainAudio.pause();
                antonymphCheckbox.checked = false;
                return;
            }
            document.getElementById("startExperience").innerText = "start/stop experience";
            mainAudio.currentTime = 0;
            mainAudio.play();
            antonymphCheckbox.checked = true;
        }
        //document.getElementById("alert").onclick = function () {  document.getElementById("nymphaudio").play(); alert(document.getElementById("nymphaudio").currentTime) };
        document.getElementById("startExperience").onclick = startExperience;
        

        /////

        var timedLyrics = [
    [0, "Antonymph"],
    [15.875, "I messaged somepony over Tumblr last night"],
    [17.625, "She said \"RAWR X3\" so it's true love at first sight"],
    [19.875, "Throw on my kandi bracelets, now I'm headed to class"],
    [21.625, "I'm still 20 percent, so get your head out your ass"],
    [24.25, "I'm the antonymph of the internet"],
    [25.8125, "Still cleaning up the viruses that you had left"],
    [28.25, "I think I'm falling in love again (love again)"],
    [30.25, "Don't stop, don't stop until you hear the- (Yay!)"],
    [32.25, "I'm the antonymph of the internet"],
    [33.875, "Been fighting on Newgrounds over if my love is valid"],
    [36.1875, "Fuck the cynicism, let the colors fly"],
    [37.875, "Don't care you think it's cringe, because it's not your life"],
    [40.6875, "She said, \"Do you like waffles?\", I said \"Hell yeah!\""],
    [42.875, "Been watching Equals Three until 2 a.m."],
    [44.875, "I ain't got no iPhone, but I got a DS"],
    [46.75, "With a keychain of Pinkie, her cupcakes are the best (sing a song about life)"],
    [48.75, "I've been failing my classes, 'cause I don't give a damn"],
    [50.625, "They say the world is my oyster but the free market's a scam"],
    [52.875, "Everything's been changing since last generation was born"],
    [54.75, "And they won't try to take in change is a two-edged sword"],
    /*
    [65.25, "I'm the antonymph of the internet"],
    [66.8125, "Still cleaning up the viruses that you had left"],
    [69.25, "I think I'm falling in love again (love again)"],
    [71.25, "Don't stop, don't stop until you-"],
    [73.25, "I'm the antonymph of the internet"],
    [74.875, "Been fighting on Newgrounds over if my love is valid"],
    [77.1875, "Fuck the cynicism, let the colors fly"],
    [78.875, "Don't care you think it's cringe, because it's not your life"],
    */
    [57, "bam bam beem bam"],
    [57.5, "ja babara ra rom"],
    [58, "rem ram ram rrram"],
    [59.125, "ba baa baaa baaaaa"],
    [60, "beeeaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"],
    //
    [64.75, "나는 사나이"],
    [65.6875, "낮에는 너만큼 따사로운 그런"],
    //
    // A ram me am brem da
    // Am da rem ram am da baabeeeaaaaaaa!
    [66.75, "just"],
    [67, "go"],
    [67.25, "kitty"],
    [67.5, "go"],
    [67.75, "kitty"],
    [68, "go"],
    [68.25, "kitty"],
    [68.5, "go"],
    [68.75, "and just"],
    [69, "ride"],
    [69.25, "kitty"],
    [69.5, "ride"],
    [69.75, "kitty"],
    [70, "ride"],
    [70.25, "kitty"],
    [70.5, "roll"],
    [70.75, "and just"],
    [71, "go"],
    [71.25, "kitty"],
    [71.5, "go"],
    [71.75, "kitty"],
    [72, "go"],
    [72.25, "kitty"],
    //
    [72.5, ":3"],
    [73, null],
    [81, "..."],
    //
    [82.5, "Tacky wacky!"],
    //
    [82.875, "It's never too late to fall in love with the world"],
    [84.875, "Your past is not today, so set your stride with a twirl"],
    [86.75, "Yeah, we've all made mistakes before"],
    [88.125, "That's a fact of life"],
    [89.125, "But once you restitch your heart, you'll be just fine"],
    [91.625, "Now it's your life, you'll say, \"It's all mine!\""],
    [93.75, "All mine"],
    [95, "Revel in your friends and hobbies, let your heart speak"],
    [96.875, "When a drifter says some shit, just block that internet freak!"],
    [100.25, "I'm the antonymph of the internet"],
    [101.8125, "Still cleaning up the viruses that you had left"],
    [104.25, "I think I'm falling in love again (love again)"],
    [106.25, "Don't stop, don't stop until you-"],
    [108.25, "I'm the antonymph of the internet"],
    [109.875, "Been fighting on Newgrounds over if my love is valid"],
    [112.1875, "Fuck the cynicism, let the colors fly"],
    [113.875, "Don't care you think it's cringe, because it's not your life"],
  ];

  /*function tumblrChat(title, messages) {
    var finalText = "=== " + title + " ===\n";
    for (var i = 0; i<messages.length; i++) {
        var message = messages[i];
        finalText += (message[0] ? "xxflutt-gir-shy: " : "itsdashyy327: ") + message[1] + "\n";
    }
    return finalText
  }*/
  function tumblrChat(title, messages, el) {
    if (!el.innerText.length) {
        el.setAttribute("style", "background: #D1D4F4; height: 100%; font-family: 'Comic Sans MS', cursive;filter: brightness(1);");
        var div = document.createElement("div");
        div.setAttribute("style", "background: #6A708F; width: 100%; height: 25px; color: white; font-size: 16px; padding: 15px");
        div.innerText = title;
        el.appendChild(div);
        div = document.createElement("div");
        el.appendChild(div);
        div = document.createElement("div");
        div.setAttribute("style", "background: #FAF6FC; width: 100%; height: 25px; color: #B0B2C3; font-size: 16px; padding: 15px; position: absolute; bottom: 0");
        div.innerText = "Say Something";
        el.appendChild(div);
    }
    var msgsLen = el.getElementsByClassName("chat").length;
    for (var i = 0; i<messages.length; i++) {
        if (i < msgsLen) continue;
        var message = messages[i];
        if (message[0]) {
            var img = document.createElement("img");
            img.src = asset("chat-d.png");
            img.style.margin = "20px 13px 0 20px";
            el.childNodes[1].appendChild(img);  
            var span = document.createElement("span");
            span.setAttribute("class", "chat");
            span.setAttribute("style", "background:white; font-size: 15px; border-radius: 10px;padding: 8px; margin:5px 0; display: inline-block; width:50%");
            span.innerText = message[1];
            el.childNodes[1].appendChild(span);  
        } else {
            var span = document.createElement("span");
            span.setAttribute("style", "background:white; font-size: 15px; border-radius: 10px;padding: 8px; margin-left: 90px; display: inline-block; width:50%");
            span.setAttribute("class", "chat");
            span.innerText = message[1];
            el.childNodes[1].appendChild(span);  
            var img = document.createElement("img");
            img.src = asset("chat-f.png");
            img.style.margin = "20px 13px 0 20px";
            el.childNodes[1].appendChild(img);  
        }
             var br = document.createElement("br");
             el.childNodes[1].appendChild(br);  
    }
    //return finalText
  }


  function setBackgroundTransColor(trans, color) {
    if (trans)
      backgroundDiv.style.transition = trans;
    if (color)
      backgroundDiv.style.backgroundColor = color;
  }


 function size(index, w, h, rateLimit) {
    //if (!popupState[index].restored) return;
    //if (rateLimit && windowRateLimit && !popupState[index].sillyHidden && rateLimitState > 1) return;
    //if (rateLimit && Date.now() - popups[index].lastResize < rateLimitMs) return false;
      w = Math.max(178, w);
      h = Math.max(100, h);
    if (popupState[index].sillyHidden) {
        windows[index].style.opacity = 1;
        popupState[index].sillyHidden = false;
    }
    //if (popupState[index].w !== w || popupState[index].h !== h || ignoreLimits) {
    if (popupState[index].w !== w || popupState[index].h !== h) {
      
        //debug_action_calls++;
        //if (rateLimit) popups[index].lastResize = Date.now();
        //if (rateLimit) rateLimitState = 1;
        //popups[index].resizeTo(w, h);
        windows[index].style.width=w+"px";
        windows[index].style.height=h+"px";

      popupState[index].w = w;
      popupState[index].h = h;
    }
        
    return true;
  }

  function move(index, x, y, rateLimit) {
    //if (!popupState[index].restored) return;
    //if (rateLimit && windowRateLimit && !popupState[index].sillyHidden && rateLimitState > 1) return;
    //if (rateLimit && Date.now() - popups[index].lastMove < rateLimitMs) return false;
      //[x, y] = calculateOffsets(index, Math.floor(x), Math.floor(y));
    if (popupState[index].sillyHidden) {
        windows[index].style.opacity = 1;
        popupState[index].sillyHidden = false;
    }
    
    //if (popupState[index].x !== x || popupState[index].y !== y || ignoreLimits) {
    if (popupState[index].x  !== x || popupState[index].y !== y) {
      
        //debug_action_calls++;
        //if (rateLimit) popups[index].lastMove = Date.now();
        //if (rateLimit) rateLimitState = 1;
                windows[index].style.left=(x-1920/2+125)+"px";
        windows[index].style.top=(y-1080/2+125)+"px";
      
      popupState[index].x = x;
      popupState[index].y = y;
    }
    return true;
  }

        /* beats 0 - 24 */
        function part1(currentBeat){
    if (oneTime(0, currentBeat, 0)) {
      setBackgroundTransColor("background-color 1.5s", "#E8E9C5");
      var img = document.createElement("img");
      img.src = "ezgif-57337c98275e2d40.gif";
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.imageRendering= "pixelated";
      popups[3].document.body.appendChild(img);
    }
    if (oneTime(0, currentBeat, 8)){
      setBackgroundTransColor("background-color 3s cubic-bezier(0,0.5,0,1)", "#174180");
      popups[3].document.body.innerText = "";
    }


    if (currentBeat < 8) {
        popups[0].document.body.innerText = "Antonymph";
        popups[0].document.body.style.color = "#E8E9C5";
      for (var i = 0; i < 3; i++) {
        size(i, 200, 200);
        move(i, 200, i*200 + 140 + 100);
          popups[i].document.body.style.backgroundColor = "#E8E9C5";
      }
    }

    if (currentBeat >= 0 && currentBeat < 8) {
      var currentText = [
        "antonymph\nmusic & vocals by vylet pony, crazy frog, psy\nproduced, mixed, & mastered by vylet pony\nwritten by vylet pony, voreburger, astroeden, calamarispider, sylver stripe\nadditional arranging & recording by voreburger & astroeden",
        "lick icon by voreburger\nflutt-gir-shy designed by voreburger",
        "web experience\nproduced & coded by rebane2001",
        "illustrations by\nvoreburger, mataschmata, nootaz, astroeden, syrupyyyart,\ncalamarispider, nekosnicker, bunxl, chibadeer, retromochi,\ncassettepunk, voidmoth, galaxysquid, blairvonglitter, hazelnoods\nstereo flier, anticularpony, huffylime, fizzlesoda, opossum stuff,\n& wutanimations",
        ][Math.floor(currentBeat/2)];
      // try {
      popups[4].document.body.setAttribute('style','width:100%;height:100%;padding: 1px 16px;background:#E8E9C5;font-family:monospace');
      popups[4].document.body.innerText = currentText;
      //popups[4].document.title = "Antonymph";
    // } catch{}
      size(4, 600, 200);
      if (currentBeat < 4)
        move(4, 280, 226);
      else
        move(4, 1040, 712);
      size(3, 1400, 800);
      move(3, (1920-1400)/2, (1080-800)/2);
      //var currentMapBeat = Math.floor(currentBeat)*3 + Math.floor((currentBeat%1)*16/6);
      //navigatePopup(3, `https://www.openstreetbrowser.org/#roads/w515658673&map=${Math.min(19, currentMapBeat)}/37.6486/-122.4296`, false)
      //if (platformFixes.focusFix) popups[4]?.focus();
    }

    if (oneTime(3, currentBeat, 8)) {
      restorePopup(3);
      popups[4].document.body.setAttribute("style","");
      popups[4].document.body.style.backgroundColor = "#174180";
      sillyHide(1);
      sillyHide(2);
      sillyHide(4);
      size(0, 840, 250);
      move(0, (1920-840)/2, (1080-250)/2);
    }

    if (currentBeat >= 8 && currentBeat < 16) {
      var popupBody = popups[0].document.body;
      var first = (currentBeat < 12);
      var currentSize = easeOutCubic((currentBeat-(first ? 8 : 12))/8)*250 + 250;
      popupBody.style.backgroundColor = "#174180";
      popupBody.style.color = "#fff";
      popupBody.style.fontSize = (currentSize/(first ? 2 : 3)) + "px";
      popupBody.style.fontFamily = "sans-serif";
      popupBody.style.textAlign = "center";
      popupBody.innerText = first ? "Antonymph" : "by trixielulam00nz!";
      var popupSize = [(first ? 840 : 1100) + currentSize, first ? currentSize : currentSize/1.5];
      if (currentBeat >= 8 + msToBeat(1000/15)) {
        size(0, popupSize[0], popupSize[1], true);
        move(0, (1920-popupSize[0])/2, (1080-popupSize[1])/2, true);
      }

      sillyHide(3);
    }
    if (oneTime(3, currentBeat, 16)) {
      setBackgroundTransColor("background-color 0s", "#174180");
      popups[4].document.body.style.background = "#174180";
    }

    if (currentBeat >= 16 && currentBeat < 24) {
      size(0, 800, 900);
      move(0, (1920-800)/2, (1080-900)/2);
      if (popups[0].document.body.innerText.length) {
        popups[0].document.body.innerText = "";
        var kandiImage = document.createElement("img");
      kandiImage.src = asset("Kandi_for_rave.jpg");
      popups[0].document.body.appendChild(kandiImage);  
      }
      
      //if (navigatePopup(0, currentBeat < 20 ? "https://tumblr.com" : "https://en.wikipedia.org/wiki/Kandi_bracelet#/media/File:Kandi_for_rave.jpg"))
          //restorePopup(1, true);
      size(1, 380, 560);
      if (currentBeat >= 23 + 12/16) {
        move(1, 1100, 460 + Math.floor((currentBeat*16 + 1)%2)*20);
      } else {
        move(1, 1100, 460 + Math.floor((Math.min(23.74, currentBeat)*4)%2)*20);  
      }
        var messages = [];
          if(currentBeat >= 17)messages.push([1, 'hi!']);
          if(currentBeat >= 18)messages.push([0, 'rawr x3']);
          if(currentBeat >= 19)messages.push([1, 'omggg!!1']);
          if(currentBeat >= 21)messages.push([1, 'gotta go']);
        //popups[1].document.body.innerText = tumblrChat("xxflutt-gir-shy + itsdashyy327", messages);
        tumblrChat("xxflutt-gir-shy + itsdashyy327", messages, popups[1].document.body);
    }
        }

 /* beats 24 - 41 */
  function part2(currentBeat) {
    
    if (oneTime(1, currentBeat, 24)) {
      restorePopup(0, true);
      sillyHide(1); 
      setBackgroundTransColor("background-color 0s", "#637");
      popups[1].document.body.style.background = "#637";
      popups[3].document.body.style.background = "#637";
      popups[4].document.body.style.background = "#637";
      popups[1].document.body.innerText = "";
      popups[3].document.body.innerText = "";
      popups[4].document.body.innerText = "";
      popups[0].document.body.innerText = "";
      popups[2].document.body.innerText = "";
    }
    


    if (currentBeat >= 24 && currentBeat < 31.5) {
      var currentLoveIndex = Math.max(0, Math.floor((currentBeat - (28 + 2/16))*40));
      var currentLoveText = "I think I'm falling\nin love again.....".slice(0, Math.min(currentLoveIndex, 34 + Math.floor(currentBeat*6*4)%6)).replace("\n", "<br>");
      /*
      var coinGenerator = `<div style="width:100%;height:100%;background:#EEE;font-family: sans-serif;color: #777;box-shadow: 1px 1px 30px #939393 inset;"><div style="width:50%;float: left;"><form style="padding: 20px;"><span>Penguin Username:</span><br>
<input type="text" value="USERNAME" disabled="disabled"><br><br><span>Penguin Password:</span><br>
<input type="password" value="hunter2" disabled="disabled"><br><br><span>Coin Amount:</span><br><select disabled="disabled"><option>15,000 coins</option></select><br><br><button disabled="disabled">Generate Coins</button></form></div><div style="width: 50%;float: right;display: flex;flex-direction: column;align-items: center;justify-content: center;height: 100%;transform: translate(-24px, 13px);"><span style="
    text-align: center;
">We are generating your<br>epic penguin coins...<br><br>Please wait...<br><br></span>
<div style="width: 208px;height: 13px;background: repeating-linear-gradient(-60deg, #fff,  #fff 8px,#ddd 9px, #ddd 17px, #fff 18px);border: 1px #999 solid;border-radius: 4px;box-shadow: 1px 1px 7px #888 inset;background-position-x: -16px;"></div><br><br></div></div>`.replace("USERNAME", "biscuit327");
      var flash = `<div id="bg" style=" width: calc(100% + 32px); height: calc(100% + 32px); background: repeating-linear-gradient(-45deg, #484848,  #484848 16px, #3E3E3E 16px, #3E3E3E 32px); position: absolute; top: 0; left: 0; z-index: -1;"></div>
        <img src="/antonymph/sad.png" id="sad" style="position: absolute;left: 220px;top: 130px;z-index: 2;filter: drop-shadow(0px 0px 3px #0005);">
        <div id="fg" style="width: 100%; height: 100%; position: absolute; top: 170px; left: 0; z-index: 1; text-align: center;line-height: 4px;font-size: 12px;font-family: sans-serif;color: white;text-shadow: 1px 1px 3px #0006">
        <p>The Adobe Flash plugin has crashed.</p>
        <p><u>Reload the page</u> to try again.</p>
        <br><br><br><br><br><br>
        <p>No report available.</p>
        </div>`;*/


      popups[2].document.body.setAttribute("class", currentBeat >= 28 ? "windowInner bg2" : "windowInner bg1");
      // popups[2].document.body.innerText = "";
      var toolbarSeparator = function() {var div = document.createElement("div");div.setAttribute("class","component");div.setAttribute("style","width: 1px;height: 16px;margin: 2px;display: inline-block");return div};
      var addToolbar = function(toolbarIdx, toolbarDom) {
        var toolbarClass = "toolbar-" + toolbarIdx;
        var oldToolbar = document.getElementsByClassName(toolbarClass);
        if (oldToolbar.length) {
            oldToolbar[0].remove();
        }
        toolbarDom.setAttribute("class", toolbarClass + " " +toolbarDom.className);
        popups[2].document.body.appendChild(toolbarDom);
      }
      var toolbarContainer = function(contents) {
        var div = document.createElement("div");
        div.setAttribute("class","component");
        div.setAttribute("style","width: calc(100% - 2px);height: 22px;font-family: sans-serif;font-size: 12px; z-index: 4");
        div.appendChild(toolbarSeparator());
        for (var i = 0; i<contents.length; i++) {
            if (contents[i])
                div.appendChild(contents[i]);
        }
        var span = document.createElement("span");
        span.setAttribute("class","arrow");
        span.innerText = "»";
        div.appendChild(span);
        return div;
      };
      var toolbarTextbox = function(width) {
        var div = document.createElement("div");
        div.setAttribute("class","textBox");
        var div2 = document.createElement("div");
        div2.setAttribute("style", "width: "+width+"px");
        div.appendChild(div2);
        return div;
      };
      var toolbarText = function(content) {
        var span = document.createElement("span");
        span.setAttribute("style","display: inline-block;transform: translateY(-7px); margin: 2px");
        span.innerText = content;
        return span;
      };
      var toolbarIcon = function(index, mr) {
        var div = document.createElement("div");
        div.setAttribute("class","icon");
        div.setAttribute("style","background-position-x: -" + index*22 + "px; margin-right: " + (mr || 0) + "px");
        return div;
      };
      var toolbarButton = function(iconIndex, content) {
        var span = document.createElement("span");
        span.appendChild(toolbarIcon(iconIndex, -2));
        span.appendChild(toolbarText(content));
        return span;
      };

      if (currentBeat >= 24.25 && currentBeat < 25)
        addToolbar(0,(toolbarContainer([
        toolbarIcon(9),toolbarIcon(10) ,toolbarTextbox(80)
        , (currentBeat >= 24 + 6/16 ? toolbarButton(12, "The") : false)
        , (currentBeat >= 24 + 8/16 ? toolbarButton(13, currentBeat >= 24 + 12/16 ? "Antonymph" : "Anto") : false)
      ])));

    var foo1a = document.createElement("span");
    var foo1b = document.createElement("font");
    var foo1c = document.createElement("font");
    var foo1d = document.createElement("font");
    foo1a.setAttribute("style", "display: inline-block;transform: translateY(-7px);font-family: 'Arial Black', sans-serif;font-size: 11px;font-weight: bold;padding: 4px;");
    foo1b.setAttribute("style", "color: #929598;");
    foo1c.setAttribute("style", "font-style: italic;color: #0c57ba;padding-right: 1px;");
    foo1d.setAttribute("style", "color: #5b5a5b;");
    foo1b.innerText = "of";
    foo1c.innerText = currentBeat >= 25 + 2/16 ? 'the' : '';
    foo1d.innerText = (currentBeat >= 25 + 4/16 ? 'in' : '') + (currentBeat >= 25 + 6/16 ? 'ter' : '') + (currentBeat >= 25 + 8/16 ? 'net' : '');
    foo1a.appendChild(foo1b);
    foo1a.appendChild(foo1c);
    foo1a.appendChild(foo1d);

      if(currentBeat >= 25 && currentBeat < 26 + 8/16)
        addToolbar(1,(toolbarContainer([
        foo1a
        , (currentBeat >= 25 + 12/16 ? toolbarIcon(7)  : false)
        , (currentBeat >= 25 + 12/16 ? toolbarTextbox(128) : false)
        , (currentBeat >= 25 + 13/16 ? toolbarButton(8, "Still") : false)
        , (currentBeat >= 26 ? toolbarButton(0, "Cleaning") : false)
        , (currentBeat >= 26 + 4/16 ? toolbarButton(1, "Up") : false)
        , (currentBeat >= 26 + 6/16 ? toolbarButton(2, "The") : false)
      ])));

    var foo2a = document.createElement("span");
    var foo2b = document.createElement("font");
    var foo2c = document.createElement("font");
    var foo2d = document.createElement("font");
    var foo2e = document.createElement("font");
    var foo2f = document.createElement("font");
    var foo2g = document.createElement("font");
    var foo2h = document.createElement("font");
    foo2a.setAttribute("style", "display: inline-block;transform: translateY(-6px);font-family: serif;font-size: 14px;font-weight: bold;filter: drop-shadow(0 1px 1px #0008);");
    foo2b.setAttribute("style", "color: #144ceb;");
    foo2c.setAttribute("style", "color: #db222d;");
    foo2d.setAttribute("style", "color: #e3a005;");
    foo2e.setAttribute("style", "color: #0c3ad8;");
    foo2f.setAttribute("style", "color: #00a70d;");
    foo2g.setAttribute("style", "color: #ef2832;");
    foo2h.setAttribute("style", "color: #e3a105;");
    foo2b.innerText = "V";
    foo2c.innerText = "i";
    foo2d.innerText = "r";
    foo2e.innerText = "u";
    foo2f.innerText = "s";
    foo2g.innerText = "e";
    foo2h.innerText = "s";
    foo2a.appendChild(foo2b);
    foo2a.appendChild(foo2c);
    foo2a.appendChild(foo2d);
    foo2a.appendChild(foo2e);
    if (currentBeat >= 26 + 11/16) {
        foo2a.appendChild(foo2f);
        foo2a.appendChild(foo2g);
        foo2a.appendChild(foo2h);
    }

      if(currentBeat >= 26 + 8/16 && currentBeat < 27 + 4/16)
        addToolbar(2,(toolbarContainer([
        foo2a,(currentBeat >= 27 ? toolbarSeparator() : false)
        , (currentBeat >= 27 + 2/16 ? toolbarButton(11, "That") : false)
        , (currentBeat >= 27 + 2/16 ? toolbarTextbox(333) : false)
        ])));
     

     if(currentBeat >= 27 + 4/16 && currentBeat < 27 + 12/16) {
        addToolbar(3,(toolbarContainer([
            toolbarIcon(3), toolbarIcon(4) , toolbarTextbox(165)
        , (currentBeat >= 27 + 6/16 ? toolbarSeparator() : false)
        , (currentBeat >= 27 + 6/16 ? toolbarButton(6, "Had") : false)
        , (currentBeat >= 27 + 6/16 ? toolbarIcon(7) : false)
        , (currentBeat >= 27 + 8/16 ? toolbarButton(5, "Left") : false)
        , (currentBeat >= 27 + 8/16 ?  toolbarIcon(7) : false)
            ])));
     }
     /*
      popups[2].document.body.innerHTML = `
      ${currentBeat >= 27 + 4/16 ? toolbarContainer(
        toolbarIcon(3) + toolbarIcon(4) + toolbarTextbox(165)
        + (currentBeat >= 27 + 6/16 ? toolbarSeparator() + toolbarButton(6, "Had") + toolbarIcon(7) : '')
        + (currentBeat >= 27 + 8/16 ? toolbarButton(5, "Left") + toolbarIcon(7) : '')
      ) : ''}
      ${currentBeat >= 28 ? `<img src="/antonymph/image13_small.gif" style="image-rendering: pixelated;width: 400px; height: 260px;"><p style="position: absolute;top: 131px;left: 332px;font-family: serif;color: black;">${currentLoveText}</p>` : flash}`;
*/

      var progress = (currentBeat*4)%1;
      var bgOffset = Math.sqrt(32*32/2)*Math.pow(progress, 0.5);
      //if (currentBeat < 28) {
      //  popups[2].document.getElementById("sad").style.transform = "scale(" + Math.max(1.1 - progress/4, 1) + ")`;
      //  popups[2].document.getElementById("bg").style.transform = "translate(" + -bgOffset + "px, " + -bgOffset} + "px)";
      //}
      move(2, (1920 - 480)/2, (1080 - 360)/2);
      size(2, 480, 360 - 4);

      if (currentBeat >= 26 && currentBeat < 31.5) {
        //popups[4].document.body.innerHTML = coinGenerator.replace("-16", Math.sqrt(18*18*2/3)*currentBeat*4);
        if(!popups[4].document.body.childNodes.length) {
            var img = document.createElement("img");
            img.src = asset("coins.png");
            popups[4].document.body.appendChild(img);
        }
        move(4, 280 + Math.floor((currentBeat*8)%2)*16, 640 - Math.floor((currentBeat*8)%2)*16);
        size(4, 485, 231);
      }
       
      if (currentBeat >= 27.9 && currentBeat < 31.5) {
        //const heartColors = ["F4ABBA", "DD2E44", "F4900C", "FDCB59", "77B256", "5EAFEB", "AB8ED6"]
        //                 ?? ["F4ABBA", "DD2E44", "F4900C", "FDCB59", "77B256", "89C9F9", "5EAFEB", "AB8ED6", "31373D", "99AAB5", "E7E8E8", "C1694F"];
        var heartColors = ["F4ABBA", "DD2E44", "F4900C", "FDCB59", "77B256", "5EAFEB", "AB8ED6"];
        //var heartSVG = `<svg style="background: #637" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36"><path fill="#AA8ED6" d="M35.885 11.833c0-5.45-4.418-9.868-9.867-9.868-3.308 0-6.227 1.633-8.018 4.129-1.791-2.496-4.71-4.129-8.017-4.129-5.45 0-9.868 4.417-9.868 9.868 0 .772.098 1.52.266 2.241C1.751 22.587 11.216 31.568 18 34.034c6.783-2.466 16.249-11.447 17.617-19.959.17-.721.268-1.469.268-2.242z"></path></svg>`.replace("#AA8ED6", `#${heartColors[Math.floor(Math.max(currentBeat-0.01,28.25)*4) % heartColors.length]}`);
        var mult = ((currentBeat*4+0.5) % 2 > 1) ? 1 : -1;
        var s1ze = [200, 200];
        var hiddenWindow = (currentBeat < 28.4825) ? (mult === 1 ? 3 : 0) : -1;
        if(!popups[0].document.body.childNodes.length) {
            var img = document.createElement("img");
            img.src = asset("heart.png");
            popups[0].document.body.appendChild(img);
            img = document.createElement("img");
            img.src = asset("heart.png");
            popups[3].document.body.appendChild(img);
        }
        var heartColor = "#" + heartColors[Math.floor(Math.max(currentBeat-0.01,28.25)*4) % heartColors.length];
        popups[0].document.body.style.backgroundColor = heartColor;
        popups[3].document.body.style.backgroundColor = heartColor;
        console.log(heartColor);
        if (hiddenWindow === 0) {
          move(0, 300, 650, true);
        } else {
          move(0, (1920 - s1ze[0])/2 + Math.sin(currentBeat*4*Math.PI)*360*mult, (1080 - s1ze[1])/2 + Math.cos(currentBeat*Math.PI)*240*mult, true);
        }
        if (hiddenWindow === 3) {
          move(3, 300, 650, true);
        } else {
          move(3, (1920 - s1ze[0])/2 - Math.sin(currentBeat*4*Math.PI)*360*mult, (1080 - s1ze[1])/2 - Math.cos(currentBeat*Math.PI)*240*mult, true);
        }
        size(0, s1ze[0], s1ze[1]);
        size(3, s1ze[0], s1ze[1]);
      } else {
        sillyHide(0);
      }
    }

    if (oneTime(0, currentBeat, 31.5)) {
      sillyHide(0);
      sillyHide(1);
      sillyHide(2);
      sillyHide(3);
      sillyHide(4);
      setBackgroundTransColor("background-color 0s", "#FAF5AB");
    }
    if (oneTime(0, currentBeat, 31.75)) {
      //size(1, 1280, 720);
      //move(1, (1920 - 1280)/2, (1080 - 720)/2);
      //popups[1].document.body.innerText = "im too lazy to port the rest of the experience over to webtiles, so check out the full version on my website";
      //var aLink =document.createElement("a");
      //aLink.href= "https://lyra.horse/antonymph/";
      //aLink.innerText = aLink.href;
      //popups[1].document.body.appendChild(aLink);
    }
}

        function part3(currentBeat){}
        function part4(currentBeat){}
        function part5(currentBeat){}
        function part6(currentBeat){}

 var lastLyrics = "";
  function setLyrics(currentBeat) {
    var currentLyrics = [null,null];
    for (var i = 0; i < timedLyrics.length; i++){
        if (timedLyrics[i][0] > currentBeat) break;
        currentLyrics = timedLyrics[i];
    }
    if (currentLyrics[1] == null) {
      return;
    }
    if (currentLyrics[1] != lastLyrics) {
      lastLyrics = currentLyrics[1];
      console.log(lastLyrics);
    }

    var charCount = Math.floor((currentBeat - currentLyrics[0])*30);
    //var urlString = "/" + currentLyrics[1].substring(0, charCount).trim().replace(/ /g, "_");
    //for (let i = 0; i < 5; i++) {
    //  setPopupHistory(i, urlString);
    //}
                for (var i = 0; i<5;i++) {
                //windowTitles[i].innerText = urlString.replace(/_/g, " ").replace(/^\//, "");
                windowTitles[i].innerText = currentLyrics[1].substring(0, charCount);
            }

  }

  var lastFrame = 0;
  var lastError = 0;
 function mainLoop() {
    if (mainAudio.paused) {
      if (getCurrentBeat() > 133) {
        //experienceEnd();
        return;
      }
      return;
    }

    var frameStart = Date.now();

    lastFrame = frameStart;
    var currentBeat = getCurrentBeat();

    if (currentBeat >= 16) {
        var beat2 = (currentBeat*4);
        ((beat2 % 2) < 1 ? backgroundGrid1 : backgroundGrid2).style.opacity = Math.max(0,0.5-(beat2 % 1)) *0.1;
    }

    try {
      setLyrics(currentBeat);
  
      // The parts here are somewhat arbitrary.
      // I originally had everything in the mainLoop
      // function, but eventually I chunked it up
      // into parts for better JS performance.
      if (currentBeat >= 0 && currentBeat < 24+2)
        part1(currentBeat);
      if (currentBeat >= 24 && currentBeat < 41+2)
        part2(currentBeat);
      if (currentBeat >= 41 && currentBeat < 56+2)
        part3(currentBeat);
      if (currentBeat >= 56 && currentBeat < 81+2)
        part4(currentBeat);
      if (currentBeat >= 81 && currentBeat < 102+2)
        part5(currentBeat);
      if (currentBeat >= 102 && currentBeat < 132+2)
        part6(currentBeat);
    } catch (e) {
      if (Date.now() - lastError >= 100) {
        console.error(e);
        console.error("Whoops, an error occurred at " + (currentBeat) + "more details above. :c");
        lastError = Date.now();
      }
      if (DEBUG_MODE) {
        mainAudio.pause();
      }
    }

    var frameEnd =  Date.now();

    //console.log(frameStart - requestTime, frameEnd - requestTime)
    //setTimeout(() => {requestTime = window.performance.now();requestAnimationFrame(mainLoop)}, Math.max((frameStart + 1000/60) - frameEnd, 0));
    //setTimeout(mainLoop, Math.max((frameStart + 1000/60) - Date.now(), 4));

  }
  // UTIL
  function bounceBack(x) {
    return x < 1 ? x : (2-x);
  }

  function easeOutCubic(x) {
    return 1 - Math.pow(1 - x, 3);
  }

    </script>
</body>
</html>