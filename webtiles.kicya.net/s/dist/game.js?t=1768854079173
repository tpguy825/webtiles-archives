var et=Object.defineProperty;var tt=(e,t,n)=>t in e?et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var pe=(e,t,n)=>tt(e,typeof t!="symbol"?t+"":t,n);var Pe={user:null,settings:{logCalls:localStorage.logCalls==="true",disableJS:localStorage.disableJS==="true"}},Se=document.getElementById("user-data");if(Se)try{let e=JSON.parse(Se.textContent);e&&e.email_verified&&(Pe.user=e)}catch(e){console.error(e)}var i=Pe;var A=class A{static init(){A.container||(A.container=document.createElement("div"),A.container.id="modal-container",A.container.className="modal-overlay",A.container.addEventListener("click",t=>{t.target===A.container&&A.activeModal&&A.activeModal.close()}),document.body.appendChild(A.container))}constructor(t={}){this.title=t.title||"",this.content=t.content||"",this.warning=t.warning||null,this.buttons=t.buttons||[],this.onClose=t.onClose||null,this.element=null,this._buttonElements=new Map}_createButton(t){let n=document.createElement("button");return n.className=`modal-btn modal-btn-${t.type||"default"}`,n.textContent=t.text,t.disabled&&(n.disabled=!0),n.addEventListener("click",async()=>{t.onClick&&await t.onClick(this,n)}),this._buttonElements.set(t.id||t.text,n),n}_build(){let t=document.createElement("div");if(t.className="modal-content",this.title){let n=document.createElement("h3");n.className="modal-title",n.textContent=this.title,t.appendChild(n)}if(this.content){let n=document.createElement("div");n.className="modal-body",typeof this.content=="string"?n.innerHTML=this.content:this.content instanceof HTMLElement&&n.appendChild(this.content),t.appendChild(n)}if(this._warningEl=document.createElement("div"),this._warningEl.className="modal-warning",this.warning?(this._warningEl.innerHTML=this.warning,this._warningEl.style.display="block"):this._warningEl.style.display="none",t.appendChild(this._warningEl),this.buttons.length>0){let n=document.createElement("div");n.className="modal-actions";for(let s of this.buttons)n.appendChild(this._createButton(s));t.appendChild(n)}return this.element=t,t}open(){return A.init(),A.activeModal&&A.activeModal.close(),this._build(),A.container.innerHTML="",A.container.appendChild(this.element),A.container.classList.add("active"),A.activeModal=this,i.camera&&i.camera.setZoomEnabled(!1),this}close(){return A.container&&A.container.classList.remove("active"),A.activeModal=null,this._buttonElements.clear(),i.camera&&i.camera.setZoomEnabled(!0),this.onClose&&this.onClose(this),this}setContent(t){let n=this.element?.querySelector(".modal-body");return n&&(typeof t=="string"?n.innerHTML=t:t instanceof HTMLElement&&(n.innerHTML="",n.appendChild(t))),this.content=t,this}setWarning(t){return this._warningEl&&(t?(this._warningEl.innerHTML=t,this._warningEl.style.display="block"):this._warningEl.style.display="none"),this.warning=t,this}getButton(t){return this._buttonElements.get(t)}setButtonLoading(t,n,s){let o=this.getButton(t);return o?(n?(o._originalText=o._originalText||o.textContent,o.textContent=s||"Loading...",o.disabled=!0):(o.textContent=o._originalText||o.textContent,o.disabled=!1),this):this}};pe(A,"container",null),pe(A,"activeModal",null);var R=A;function ue(){return document.querySelector('meta[name="turnstile-sitekey"]')?.content||""}var nt=ue(),B=localStorage.getItem("captchaToken"),ge=parseInt(localStorage.getItem("captchaExpiresAt")||"0"),X=null,oe=[],le=!1,Ie=0,st=5e3;ge<Date.now()&&(B=null,localStorage.removeItem("captchaToken"),localStorage.removeItem("captchaExpiresAt"));function Le(){B=null,localStorage.removeItem("captchaToken"),localStorage.removeItem("captchaExpiresAt")}function it(e,t){B=e,ge=t,localStorage.setItem("captchaToken",e),localStorage.setItem("captchaExpiresAt",t)}function ae(){return le?!0:window.turnstile?(le=!0,!0):!1}function de(e,t){if(!ae())return console.error("[Captcha] Turnstile not ready"),!1;let n=ue()||nt||"";if(!n)return!0;let s=typeof e=="string"?document.querySelector(e):e;if(!s)return console.error("[Captcha] Container not found:",e),!1;s.innerHTML="";let o=window.turnstile;return o.render(s,{sitekey:n,callback:async function(r){let c=document.getElementById("loading-text");c&&(c.textContent="Verifying...");try{let g=await(await fetch("/api/captcha/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({turnstileToken:r})})).json();if(g.success){if(it(g.token,g.expiresAt),c&&(c.textContent="Loading..."),t&&X){X.close(),X=null;let v=[...oe];oe=[],v.forEach(d=>d())}}else c&&(c.textContent="Verification failed. Please try again."),o.reset(s)}catch(p){console.error("[Captcha] Verification error:",p),c&&(c.textContent="Verification failed. Please try again."),o.reset(s)}},"error-callback":function(){let r=document.getElementById("loading-text");r&&(r.textContent="Captcha failed. Please refresh.")},"expired-callback":function(){o.reset(s)}}),!0}function Ne(){if(ue())return new Promise(e=>{if(Date.now()-Ie<st){e();return}if(R.activeModal){oe.push(e);return}Ie=Date.now(),oe.push(e);let n=document.createElement("div");n.id="captcha-modal-turnstile",n.style.display="flex",n.style.justifyContent="center",n.style.padding="20px";let s=document.createElement("div"),o=document.createElement("p");if(o.textContent="Please complete the captcha to continue.",s.appendChild(o),s.appendChild(n),X=new R({title:"Verification Required",content:s,buttons:[{text:"Cancel",type:"cancel",onClick:r=>{r.close(),X=null,oe=[]}}],onClose:()=>{X=null}}),X.open(),ae())de(n,!0);else{let r=setInterval(()=>{ae()&&(clearInterval(r),de(n,!0))},100);setTimeout(()=>clearInterval(r),1e4)}})}function ve(){if(B)return;let e=document.querySelector("#turnstile-container");if(e)if(ae())de(e,!1);else{let t=setInterval(()=>{ae()&&(clearInterval(t),B||de(e,!1))},100);setTimeout(()=>clearInterval(t),1e4)}}window.onTurnstileLoad=function(){le=!0,B||ve()};window.turnstile&&(le=!0,B||ve());i.api={getToken(){return B},getTokenExpiry(){return ge},clearToken:Le,showCaptchaModal:Ne,renderCaptchaOnLoadingScreen:ve,getTurnstileSiteKey:ue,async makeRequest(e,t={}){let n=(t.method||"GET").toUpperCase();n!=="GET"&&B&&(t.headers=t.headers||{},t.headers["X-Captcha-Token"]=B);let s=await fetch(e,t);if(s.status===403){let o=s.clone();try{if((await o.json()).code==="CAPTCHA_REQUIRED")return Le(),await Ne(),n!=="GET"&&B&&(t.headers=t.headers||{},t.headers["X-Captcha-Token"]=B),fetch(e,t)}catch{}}return s}};var $t=i.api;var W=[.25,.5,.75,1,1.5],Me=50;function Re(e,t,n){let s=new WeakMap,o=2048,r=1e4,c=new WeakMap;function p(l){}function g(){c.clear=new WeakMap}function v(l,m){if(!l)return null;if(s.has(l))return s.get(l);let E=e.createObject(z);return E.native=l,E.canvas=m,s.set(l,E),E}let d=e.createNativeFunction(function(){throw TypeError("Illegal constructor")},!0);e.setProperty(t,"CanvasGradient",d);let u=e.getProperty(d,"prototype");e.setProperty(u,"addColorStop",e.createNativeFunction(function(l,m){this.native.addColorStop(l,m)}));function b(l){let m=e.createObject(d);return m.native=l,m}let T=e.createNativeFunction(function(){throw TypeError("Illegal constructor")},!0);e.setProperty(t,"CanvasPattern",T);function C(l){let m=e.createObject(T);return m.native=l,m}let f=e.createNativeFunction(function(l,m){if(l>o||m>o)throw new Error(`ImageData size exceeds maximum (${o}x${o})`);i.settings.logCalls&&console.log(n.domain,"create ImageData",this,l,m);let E=new ImageData(l,m);this.native=E,this.width=l,this.height=m},!0);e.setProperty(t,"ImageData",f);let w=e.getProperty(f,"prototype");e.setProperty(w,"width",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.width})}),e.setProperty(w,"height",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.height})}),e.setProperty(w,"data",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let l=this.native.data,m=e.createObjectProto(e.ARRAY_PROTO);e.setProperty(m,"length",l.length);let E=e.nativeToPseudo({});e.setProperty(E,"length",l.length),e.setProperty(E,"get",e.createNativeFunction(function(x){return l[x]})),e.setProperty(E,"set",e.createNativeFunction(function(x,P){i.settings.logCalls&&console.log(n.domain,"setImageData",this,x,P),l[x]=P}));for(let x=0;x<Math.min(l.length,1e3);x++)(P=>{e.setProperty(E,P,Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return l[P]}),set:e.createNativeFunction(function(N){i.settings.logCalls&&console.log(n.domain,"setImageData",this,P,N),l[P]=N})})})(x);return E})});function k(l){let m=e.createObject(f);return m.native=l,m}let I=e.createNativeFunction(function(){throw TypeError("Illegal constructor")},!0);e.setProperty(t,"TextMetrics",I);let j=e.getProperty(I,"prototype"),H=["width","actualBoundingBoxLeft","actualBoundingBoxRight","fontBoundingBoxAscent","fontBoundingBoxDescent","actualBoundingBoxAscent","actualBoundingBoxDescent","emHeightAscent","emHeightDescent","hangingBaseline","alphabeticBaseline","ideographicBaseline"];for(let l of H)e.setProperty(j,l,Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native[l]})});function J(l){let m=e.createObject(I);return m.native=l,m}let Y=e.createNativeFunction(function(l){l&&l.native?this.native=new Path2D(l.native):typeof l=="string"?this.native=new Path2D(l):this.native=new Path2D},!0);e.setProperty(t,"Path2D",Y);let se=e.getProperty(Y,"prototype"),_={addPath:function(l,m){l?.native&&this.native.addPath(l.native,m)},closePath:function(){this.native.closePath()},moveTo:function(l,m){this.native.moveTo(l,m)},lineTo:function(l,m){this.native.lineTo(l,m)},bezierCurveTo:function(l,m,E,x,P,N){this.native.bezierCurveTo(l,m,E,x,P,N)},quadraticCurveTo:function(l,m,E,x){this.native.quadraticCurveTo(l,m,E,x)},arc:function(l,m,E,x,P,N){this.native.arc(l,m,E,x,P,N)},arcTo:function(l,m,E,x,P){this.native.arcTo(l,m,E,x,P)},ellipse:function(l,m,E,x,P,N,D,q){this.native.ellipse(l,m,E,x,P,N,D,q)},rect:function(l,m,E,x){this.native.rect(l,m,E,x)},roundRect:function(l,m,E,x,P){this.native.roundRect(l,m,E,x,P)}};for(let[l,m]of Object.entries(_))e.setProperty(se,l,e.createNativeFunction(m));let z=e.createNativeFunction(function(){throw TypeError("Illegal constructor")},!0);e.setProperty(t,"CanvasRenderingContext2D",z);let G=e.getProperty(z,"prototype"),re=["globalAlpha","globalCompositeOperation","lineWidth","lineCap","lineJoin","miterLimit","lineDashOffset","font","textAlign","textBaseline","direction","shadowBlur","shadowColor","shadowOffsetX","shadowOffsetY","imageSmoothingEnabled","imageSmoothingQuality","filter"];for(let l of re)e.setProperty(G,l,Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native[l]}),set:e.createNativeFunction(function(m){i.settings.logCalls&&console.log(n.domain,"context set "+l,this,m),this.native[l]=m})});for(let l of["fillStyle","strokeStyle"])e.setProperty(G,l,Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let m=this.native[l];return m}),set:e.createNativeFunction(function(m){m?.native?this.native[l]=m.native:this.native[l]=m})});e.setProperty(G,"canvas",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.canvas})});let me={clearRect:function(l,m,E,x){this.native,this.native.clearRect(l,m,E,x)},fillRect:function(l,m,E,x){this.native,this.native.fillRect(l,m,E,x)},strokeRect:function(l,m,E,x){this.native,this.native.strokeRect(l,m,E,x)},fillText:function(l,m,E,x){this.native,x!==void 0?this.native.fillText(String(l).slice(0,1e3),m,E,x):this.native.fillText(String(l).slice(0,1e3),m,E)},strokeText:function(l,m,E,x){this.native,x!==void 0?this.native.strokeText(String(l).slice(0,1e3),m,E,x):this.native.strokeText(String(l).slice(0,1e3),m,E)},measureText:function(l){return J(this.native.measureText(String(l).slice(0,1e3)))},getLineDash:function(){return e.nativeToPseudo(this.native.getLineDash())},setLineDash:function(l){let m=e.pseudoToNative(l);this.native.setLineDash(m)},createLinearGradient:function(l,m,E,x){return b(this.native.createLinearGradient(l,m,E,x))},createRadialGradient:function(l,m,E,x,P,N){return b(this.native.createRadialGradient(l,m,E,x,P,N))},createConicGradient:function(l,m,E){return b(this.native.createConicGradient(l,m,E))},createPattern:function(l,m){let E=l?.native||l;if(!E)return null;let x=this.native.createPattern(E,m);return x?C(x):null},beginPath:function(){this.native.beginPath()},closePath:function(){this.native.closePath()},moveTo:function(l,m){this.native.moveTo(l,m)},lineTo:function(l,m){this.native.lineTo(l,m)},bezierCurveTo:function(l,m,E,x,P,N){this.native.bezierCurveTo(l,m,E,x,P,N)},quadraticCurveTo:function(l,m,E,x){this.native.quadraticCurveTo(l,m,E,x)},arc:function(l,m,E,x,P,N){this.native.arc(l,m,E,x,P,N)},arcTo:function(l,m,E,x,P){this.native.arcTo(l,m,E,x,P)},ellipse:function(l,m,E,x,P,N,D,q){this.native.ellipse(l,m,E,x,P,N,D,q)},rect:function(l,m,E,x){this.native.rect(l,m,E,x)},roundRect:function(l,m,E,x,P){let N=e.pseudoToNative(P);this.native.roundRect(l,m,E,x,N)},fill:function(l,m){this.native,l?.native?this.native.fill(l.native,m):this.native.fill(l)},stroke:function(l){this.native,l?.native?this.native.stroke(l.native):this.native.stroke()},clip:function(l,m){l?.native?this.native.clip(l.native,m):this.native.clip(l)},isPointInPath:function(l,m,E,x){return l?.native?this.native.isPointInPath(l.native,m,E,x):this.native.isPointInPath(l,m,E)},isPointInStroke:function(l,m,E){return l?.native?this.native.isPointInStroke(l.native,m,E):this.native.isPointInStroke(l,m)},getTransform:function(){let l=this.native.getTransform();return e.nativeToPseudo({a:l.a,b:l.b,c:l.c,d:l.d,e:l.e,f:l.f})},rotate:function(l){this.native.rotate(l)},scale:function(l,m){this.native.scale(l,m)},translate:function(l,m){this.native.translate(l,m)},transform:function(l,m,E,x,P,N){this.native.transform(l,m,E,x,P,N)},setTransform:function(l,m,E,x,P,N){if(typeof l=="object"&&l!==null){let D=e.pseudoToNative(l);this.native.setTransform(D)}else this.native.setTransform(l,m,E,x,P,N)},resetTransform:function(){this.native.resetTransform()},drawImage:function(l,m,E,x,P,N,D,q,ie){this.native;let a=l?.native||l;a&&(q!==void 0?this.native.drawImage(a,m,E,x,P,N,D,q,ie):x!==void 0?this.native.drawImage(a,m,E,x,P):this.native.drawImage(a,m,E))},createImageData:function(l,m){if(l?.native)return k(this.native.createImageData(l.native));if(l>o||m>o)throw new Error(`ImageData size exceeds maximum (${o}x${o})`);return k(this.native.createImageData(l,m))},getImageData:function(l,m,E,x){if(E>o||x>o)throw new Error(`ImageData size exceeds maximum (${o}x${o})`);return k(this.native.getImageData(l,m,E,x))},putImageData:function(l,m,E,x,P,N,D){this.native,l?.native&&(x!==void 0?this.native.putImageData(l.native,m,E,x,P,N,D):this.native.putImageData(l.native,m,E))},save:function(){this.native.save()},restore:function(){this.native.restore()},reset:function(){this.native.reset()}};for(let[l,m]of Object.entries(me))e.setProperty(G,l,e.createNativeFunction(m));return{extendElement:function(l,m){e.setProperty(l,"getContext",e.createNativeFunction(function(E,x){i.settings.logCalls&&console.log(n.domain,"getContext",this,E,x);let P=this.native;if(P.tagName!=="CANVAS")throw new Error("getContext is only available on canvas elements");if(P.width>o&&(P.width=o),P.height>o&&(P.height=o),E==="2d"){let N=P.getContext("2d",x?e.pseudoToNative(x):void 0);return v(N,this)}throw new Error(`Context type "${E}" is not supported`)})),e.setProperty(l,"width",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.tagName==="CANVAS"?this.native.width:this.native.width}),set:e.createNativeFunction(function(E){i.settings.logCalls&&console.log(n.domain,"set width",this,E),this.native.tagName==="CANVAS"&&(this.native.width=Math.min(E,o))})}),e.setProperty(l,"height",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.tagName==="CANVAS"?this.native.height:this.native.height}),set:e.createNativeFunction(function(E){i.settings.logCalls&&console.log(n.domain,"set height",this,E),this.native.tagName==="CANVAS"&&(this.native.height=Math.min(E,o))})}),e.setProperty(l,"toDataURL",e.createNativeFunction(function(E,x){if(this.native.tagName!=="CANVAS")throw new Error("toDataURL is only available on canvas elements");return i.settings.logCalls&&console.log(n.domain,"toDataURL",this,E,x),this.native.toDataURL(E,x)}))},resetDrawCounts:g,contextToPseudo:v}}function Ae(e,t,n){let c=0,p=window.location.origin;function g(f){if(typeof f!="string"||f.startsWith("/")||f.startsWith("./")||f.startsWith("../")||!f.startsWith("http://")&&!f.startsWith("https://"))return!1;try{let w=new URL(f);if(w.origin===p||w.hostname==="kicya.net"||w.hostname.endsWith(".kicya.net")||w.hostname==="nekoweb.org")return!1;let k=w.hostname.toLowerCase();return!(k==="localhost"||k==="127.0.0.1"||k==="0.0.0.0"||k.startsWith("192.168.")||k.startsWith("10.")||k.startsWith("172.16.")||k.startsWith("172.17.")||k.startsWith("172.18.")||k.startsWith("172.19.")||k.startsWith("172.2")||k.startsWith("172.30.")||k.startsWith("172.31.")||k==="[::1]")}catch{return!1}}let v=0,d=e.nativeToPseudo({});e.setProperty(t,"__xhrCallbacks",d);function u(f,...w){if(!f||typeof f!="object")return;let k=v++;e.setProperty(d,"fn"+k,f);let I=w.map((H,J)=>{let Y="arg"+k+"_"+J;return e.setProperty(d,Y,H),Y}),j=I.map(H=>`__xhrCallbacks.${H}`).join(",");e.appendCode(`__xhrCallbacks.fn${k}(${j}); delete __xhrCallbacks.fn${k}; ${I.map(H=>`delete __xhrCallbacks.${H}`).join("; ")};`)}let b=e.createNativeFunction(function(){i.settings.logCalls&&console.log(n.domain,"XMLHttpRequest",this),this.native=new window.XMLHttpRequest,this._method=null,this._url=null,this._async=!0,this._headers={},this._eventHandlers={};let w=this;this.native.onreadystatechange=function(){e.setProperty(w,"readyState",w.native.readyState),w.native.readyState===4&&(e.setProperty(w,"status",w.native.status),e.setProperty(w,"statusText",w.native.statusText),e.setProperty(w,"responseText",w.native.responseText?.slice(0,5242880)||""),e.setProperty(w,"responseURL",w.native.responseURL),c=Math.max(0,c-1)),w._eventHandlers.onreadystatechange&&u(w._eventHandlers.onreadystatechange)},this.native.onload=function(){w._eventHandlers.onload&&u(w._eventHandlers.onload)},this.native.onerror=function(){c=Math.max(0,c-1),w._eventHandlers.onerror&&u(w._eventHandlers.onerror)},this.native.ontimeout=function(){c=Math.max(0,c-1),w._eventHandlers.ontimeout&&u(w._eventHandlers.ontimeout)},this.native.onabort=function(){c=Math.max(0,c-1),w._eventHandlers.onabort&&u(w._eventHandlers.onabort)},this.native.onprogress=function(k){if(w._eventHandlers.onprogress){let I=e.nativeToPseudo({loaded:k.loaded,total:k.total,lengthComputable:k.lengthComputable});u(w._eventHandlers.onprogress,I)}},this.native.onloadstart=function(){w._eventHandlers.onloadstart&&u(w._eventHandlers.onloadstart)},this.native.onloadend=function(){w._eventHandlers.onloadend&&u(w._eventHandlers.onloadend)},e.setProperty(this,"readyState",0),e.setProperty(this,"status",0),e.setProperty(this,"statusText",""),e.setProperty(this,"responseText",""),e.setProperty(this,"responseURL","")},!0);e.setProperty(t,"XMLHttpRequest",b);let T=e.getProperty(b,"prototype");e.setProperty(b,"UNSENT",0),e.setProperty(b,"OPENED",1),e.setProperty(b,"HEADERS_RECEIVED",2),e.setProperty(b,"LOADING",3),e.setProperty(b,"DONE",4),e.setProperty(T,"UNSENT",0),e.setProperty(T,"OPENED",1),e.setProperty(T,"HEADERS_RECEIVED",2),e.setProperty(T,"LOADING",3),e.setProperty(T,"DONE",4);let C=["onreadystatechange","onload","onerror","ontimeout","onabort","onprogress","onloadstart","onloadend"];for(let f of C)e.setProperty(T,f,Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this._eventHandlers[f]||null}),set:e.createNativeFunction(function(w){i.settings.logCalls&&console.log(n.domain,"XMLHttpRequest set "+f,this,w),this._eventHandlers[f]=w})});e.setProperty(T,"timeout",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.timeout}),set:e.createNativeFunction(function(f){this.native.timeout=Math.min(f,3e4)})}),e.setProperty(T,"withCredentials",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.withCredentials}),set:e.createNativeFunction(function(f){this.native.withCredentials=!1})}),e.setProperty(T,"responseType",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.responseType}),set:e.createNativeFunction(function(f){(f===""||f==="text"||f==="json")&&(this.native.responseType=f)})}),e.setProperty(T,"response",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let f=this.native.response;return this.native.responseType==="json"?e.nativeToPseudo(f):typeof f=="string"?f.slice(0,5242880):f})}),e.setProperty(T,"open",e.createNativeFunction(function(f,w,k,I,j){if(!g(w))throw new Error(`XHR request blocked: URL "${w}" is not allowed. Only absolute URLs to external origins are permitted.`);let H=["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS"];if(f=String(f).toUpperCase(),!H.includes(f))throw new Error(`HTTP method "${f}" is not allowed`);i.settings.logCalls&&console.log(n.domain,"XMLHttpRequest open",this,f,w,k,I,j),this._method=f,this._url=w,this._async=k!==!1,this.native.open(f,w,this._async),this.native.timeout=3e4,e.setProperty(this,"readyState",this.native.readyState)})),e.setProperty(T,"setRequestHeader",e.createNativeFunction(function(f,w){if(["cookie","cookie2","set-cookie","set-cookie2","host","origin","referer"].includes(f.toLowerCase()))throw new Error(`Setting header "${f}" is not allowed`);i.settings.logCalls&&console.log(n.domain,"XMLHttpRequest setRequestHeader",this,f,w),this._headers[f]=w,this.native.setRequestHeader(f,w)})),e.setProperty(T,"send",e.createNativeFunction(function(f){if(c>=5)throw new Error("Maximum concurrent requests (5) exceeded");i.settings.logCalls&&console.log(n.domain,"XMLHttpRequest send",this,f),c++;let w=null;f!=null&&(typeof f=="string"?w=f.slice(0,5242880):typeof f=="object"&&(w=JSON.stringify(e.pseudoToNative(f)))),this.native.send(w)})),e.setProperty(T,"abort",e.createNativeFunction(function(){i.settings.logCalls&&console.log(n.domain,"XMLHttpRequest abort",this),this.native.abort(),c=Math.max(0,c-1)})),e.setProperty(T,"getResponseHeader",e.createNativeFunction(function(f){return this.native.getResponseHeader(f)})),e.setProperty(T,"getAllResponseHeaders",e.createNativeFunction(function(){return this.native.getAllResponseHeaders()})),e.setProperty(T,"overrideMimeType",e.createNativeFunction(function(f){this.native.overrideMimeType(f)}))}var ot="webtiles_storage",at=1,F="localStorage",_e=1024*1024,Oe=100,V=null,he=null;function Z(){return he||(he=new Promise((e,t)=>{let n=indexedDB.open(ot,at);n.onerror=()=>t(n.error),n.onsuccess=()=>{V=n.result,e(V)},n.onupgradeneeded=s=>{let o=s.target.result;o.objectStoreNames.contains(F)||o.createObjectStore(F,{keyPath:["site","key"]}).createIndex("site","site",{unique:!1})}}),he)}async function De(e,t){return await Z(),new Promise((n,s)=>{let c=V.transaction(F,"readonly").objectStore(F).get([e,t]);c.onsuccess=()=>n(c.result?.value??null),c.onerror=()=>s(c.error)})}async function rt(e,t,n){return await Z(),new Promise((s,o)=>{let p=V.transaction(F,"readwrite").objectStore(F).put({site:e,key:t,value:n});p.onsuccess=()=>s(),p.onerror=()=>o(p.error)})}async function ct(e,t){return await Z(),new Promise((n,s)=>{let c=V.transaction(F,"readwrite").objectStore(F).delete([e,t]);c.onsuccess=()=>n(),c.onerror=()=>s(c.error)})}async function lt(e){return await Z(),new Promise((t,n)=>{let c=V.transaction(F,"readonly").objectStore(F).index("site").getAll(e);c.onsuccess=()=>{let p=c.result.map(g=>g.key);t(p)},c.onerror=()=>n(c.error)})}async function Fe(e){return await Z(),new Promise((t,n)=>{let c=V.transaction(F,"readonly").objectStore(F).index("site").getAll(e);c.onsuccess=()=>{let p=0;for(let g of c.result)p+=(g.key.length+g.value.length)*2;t({size:p,count:c.result.length})},c.onerror=()=>n(c.error)})}async function dt(e){return await Z(),new Promise((t,n)=>{let c=V.transaction(F,"readwrite").objectStore(F).index("site").openCursor(e);c.onsuccess=p=>{let g=p.target.result;g?(g.delete(),g.continue()):t()},c.onerror=()=>n(c.error)})}function $e(e,t,n){let s=e.nativeToPseudo({});e.setProperty(s,"getItem",e.createAsyncFunction(function(o,r){if(i.settings.logCalls&&console.log(n,"localStorage.getItem",this,o),o==null){r(null);return}o=String(o),De(n,o).then(c=>r(c)).catch(c=>{console.error("localStorage.getItem error:",c),r(null)})})),e.setProperty(s,"setItem",e.createAsyncFunction(function(o,r,c){if(i.settings.logCalls&&console.log(n,"localStorage.setItem",this,o,r),o==null){c();return}o=String(o),r=String(r),Fe(n).then(({size:p,count:g})=>{De(n,o).then(v=>{if(v===null&&g>=Oe)throw new Error(`localStorage item limit exceeded (max ${Oe} items)`);let u=v?(o.length+v.length)*2:0,b=(o.length+r.length)*2;if(p-u+b>_e)throw new Error(`localStorage size limit exceeded (max ${_e/1024}KB)`);return rt(n,o,r)}).then(()=>c()).catch(v=>{throw console.error("localStorage.setItem error:",v),v})}).catch(p=>{console.error("localStorage.setItem error:",p),c()})})),e.setProperty(s,"removeItem",e.createAsyncFunction(function(o,r){if(i.settings.logCalls&&console.log(n,"localStorage.removeItem",this,o),o==null){r();return}o=String(o),ct(n,o).then(()=>r()).catch(c=>{console.error("localStorage.removeItem error:",c),r()})})),e.setProperty(s,"clear",e.createAsyncFunction(function(o){i.settings.logCalls&&console.log(n,"localStorage.clear",this),dt(n).then(()=>o()).catch(r=>{console.error("localStorage.clear error:",r),o()})})),e.setProperty(s,"key",e.createAsyncFunction(function(o,r){o=parseInt(o)||0,lt(n).then(c=>{r(o>=0&&o<c.length?c[o]:null)}).catch(c=>{console.error("localStorage.key error:",c),r(null)})})),e.setProperty(s,"getLength",e.createAsyncFunction(function(o){Fe(n).then(({count:r})=>o(r)).catch(r=>{console.error("localStorage.getLength error:",r),o(0)})})),e.setProperty(t,"localStorage",s),e.setProperty(t,"sessionStorage",s)}Z().catch(e=>{console.error("Failed to initialize storage DB:",e)});function Be(e,t,n,s){let o=e.createNativeFunction(function(){},!0);e.setProperty(t,"DOMParser",o);let r=e.getProperty(o,"prototype");e.setProperty(r,"parseFromString",e.createNativeFunction(function(c,p){if(i.settings.logCalls&&console.log(s.domain,"DOMParser parseFromString",this,c,p),!["text/html","text/xml","application/xml","application/xhtml+xml","image/svg+xml"].includes(p))throw new Error(`DOMParser: Unsupported MIME type "${p}"`);if(typeof c!="string"&&(c=String(c)),c.length>1e5)throw new Error("DOMParser: Input string too large (max 100KB)");let d=new DOMParser().parseFromString(c,p),u=e.createObjectProto(e.OBJECT_PROTO);function b(T){if(T==null)return null;let C=e.createObjectProto(e.OBJECT_PROTO);return C.native=T,C.fromDOMParser=!0,e.setProperty(C,"nodeName",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.nodeName})}),e.setProperty(C,"nodeType",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.nodeType})}),e.setProperty(C,"nodeValue",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.nodeValue}),set:e.createNativeFunction(function(f){i.settings.logCalls&&console.log(s.domain,"DOMParser set nodeValue",this,f),this.native.nodeValue=f})}),e.setProperty(C,"textContent",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.textContent}),set:e.createNativeFunction(function(f){i.settings.logCalls&&console.log(s.domain,"DOMParser set textContent",this,f),this.native.textContent=String(f).slice(0,5e4)})}),e.setProperty(C,"tagName",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.tagName})}),e.setProperty(C,"id",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.id}),set:e.createNativeFunction(function(f){i.settings.logCalls&&console.log(s.domain,"DOMParser set id",this,f),this.native.id=String(f).slice(0,100)})}),e.setProperty(C,"className",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.className}),set:e.createNativeFunction(function(f){i.settings.logCalls&&console.log(s.domain,"DOMParser set className",this,f),this.native.className=String(f).slice(0,1e3)})}),e.setProperty(C,"innerHTML",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.innerHTML}),set:e.createNativeFunction(function(f){throw new Error("innerHTML is not allowed. Create elements using document.createElement and append them instead or use innerText instead.")})}),e.setProperty(C,"outerHTML",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native.outerHTML})}),e.setProperty(C,"children",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let f=Array.from(this.native.children),w=e.createObjectProto(e.ARRAY_PROTO);for(let k=0;k<f.length;k++)e.setProperty(w,k,b(f[k]));return e.setProperty(w,"length",f.length),w})}),e.setProperty(C,"childNodes",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let f=Array.from(this.native.childNodes),w=e.createObjectProto(e.ARRAY_PROTO);for(let k=0;k<f.length;k++)e.setProperty(w,k,b(f[k]));return e.setProperty(w,"length",f.length),w})}),e.setProperty(C,"firstChild",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return b(this.native.firstChild)})}),e.setProperty(C,"lastChild",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return b(this.native.lastChild)})}),e.setProperty(C,"firstElementChild",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return b(this.native.firstElementChild)})}),e.setProperty(C,"lastElementChild",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return b(this.native.lastElementChild)})}),e.setProperty(C,"parentNode",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){if(!this.fromDOMParser)throw new Error("No access.");return this.native.isSameNode(n)?null:(i.settings.logCalls&&console.log(s.domain,"DOMParser get parentNode",this),b(this.native.parentNode))})}),e.setProperty(C,"parentElement",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){if(!this.fromDOMParser)throw new Error("No access.");return this.native.isSameNode(n)?null:(i.settings.logCalls&&console.log(s.domain,"DOMParser get parentElement",this),b(this.native.parentElement))})}),e.setProperty(C,"nextSibling",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){if(!this.fromDOMParser)throw new Error("No access.");return this.native.isSameNode(n)?null:(i.settings.logCalls&&console.log(s.domain,"DOMParser get nextSibling",this),b(this.native.nextSibling))})}),e.setProperty(C,"previousSibling",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){if(!this.fromDOMParser)throw new Error("No access.");return this.native.isSameNode(n)?null:(i.settings.logCalls&&console.log(s.domain,"DOMParser get previousSibling",this),b(this.native.previousSibling))})}),e.setProperty(C,"getAttributeNames",e.createNativeFunction(function(){if(!this.fromDOMParser)throw new Error("No access.");let f=Array.from(this.native.getAttributeNames()),w=e.createObjectProto(e.ARRAY_PROTO);for(let k=0;k<f.length;k++)e.setProperty(w,k,f[k]);return e.setProperty(w,"length",f.length),w})),e.setProperty(C,"getAttribute",e.createNativeFunction(function(f){if(!this.fromDOMParser)throw new Error("No access.");return this.native.getAttribute(f)})),e.setProperty(C,"setAttribute",e.createNativeFunction(function(f,w){if(!this.fromDOMParser)throw new Error("No access.");if(f=String(f).toLowerCase(),f.startsWith("on"))throw new Error("Event handlers are not allowed");this.native.setAttribute(f,String(w)),i.settings.logCalls&&console.log(s.domain,"DOMParser set attribute",this,f,w)})),e.setProperty(C,"hasAttribute",e.createNativeFunction(function(f){if(!this.fromDOMParser)throw new Error("No access.");return this.native.hasAttribute(f)})),e.setProperty(C,"removeAttribute",e.createNativeFunction(function(f){if(!this.fromDOMParser)throw new Error("No access.");if(this.native.isSameNode(n))throw new Error("No access.");this.native.removeAttribute(f),i.settings.logCalls&&console.log(s.domain,"DOMParser remove attribute",this,f)})),e.setProperty(C,"querySelector",e.createNativeFunction(function(f){if(!this.fromDOMParser)throw new Error("No access.");return b(this.native.querySelector(f))})),e.setProperty(C,"querySelectorAll",e.createNativeFunction(function(f){if(!this.fromDOMParser)throw new Error("No access.");let w=Array.from(this.native.querySelectorAll(f)),k=e.createObjectProto(e.ARRAY_PROTO);for(let I=0;I<w.length;I++)e.setProperty(k,I,b(w[I]));return e.setProperty(k,"length",w.length),k})),e.setProperty(C,"getElementsByTagName",e.createNativeFunction(function(f){if(!this.fromDOMParser)throw new Error("No access.");let w=Array.from(this.native.getElementsByTagName(f)),k=e.createObjectProto(e.ARRAY_PROTO);for(let I=0;I<w.length;I++)e.setProperty(k,I,b(w[I]));return e.setProperty(k,"length",w.length),k})),e.setProperty(C,"getElementsByClassName",e.createNativeFunction(function(f){if(!this.fromDOMParser)throw new Error("No access.");let w=Array.from(this.native.getElementsByClassName(f)),k=e.createObjectProto(e.ARRAY_PROTO);for(let I=0;I<w.length;I++)e.setProperty(k,I,b(w[I]));return e.setProperty(k,"length",w.length),k})),e.setProperty(C,"getElementById",e.createNativeFunction(function(f){if(!this.fromDOMParser)throw new Error("No access.");return b(this.native.getElementById?this.native.getElementById(f):null)})),C}return e.setProperty(u,"documentElement",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return b(d.documentElement)})}),e.setProperty(u,"head",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return i.settings.logCalls&&console.log(s.domain,"DOMParser get head",this),b(d.head)})}),e.setProperty(u,"body",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return i.settings.logCalls&&console.log(s.domain,"DOMParser get body",this),b(d.body)})}),e.setProperty(u,"title",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return d.title})}),e.setProperty(u,"querySelector",e.createNativeFunction(function(T){return b(d.querySelector(T))})),e.setProperty(u,"querySelectorAll",e.createNativeFunction(function(T){let C=Array.from(d.querySelectorAll(T)),f=e.createObjectProto(e.ARRAY_PROTO);for(let w=0;w<C.length;w++)e.setProperty(f,w,b(C[w]));return e.setProperty(f,"length",C.length),f})),e.setProperty(u,"getElementById",e.createNativeFunction(function(T){return b(d.getElementById(T))})),e.setProperty(u,"getElementsByTagName",e.createNativeFunction(function(T){let C=Array.from(d.getElementsByTagName(T)),f=e.createObjectProto(e.ARRAY_PROTO);for(let w=0;w<C.length;w++)e.setProperty(f,w,b(C[w]));return e.setProperty(f,"length",C.length),f})),e.setProperty(u,"getElementsByClassName",e.createNativeFunction(function(T){let C=Array.from(d.getElementsByClassName(T)),f=e.createObjectProto(e.ARRAY_PROTO);for(let w=0;w<C.length;w++)e.setProperty(f,w,b(C[w]));return e.setProperty(f,"length",C.length),f})),u}))}function He(e,t,n,s){let o=new WeakMap,r=1e3,c=5,p=new WeakMap,g=0,v=e.nativeToPseudo({});e.setProperty(t,"__eventCallbacks",v);function d(a,h){let y=g++;e.setProperty(v,"fn"+y,a),e.setProperty(v,"ev"+y,h),e.appendCode(`__eventCallbacks.fn${y}(__eventCallbacks.ev${y}); delete __eventCallbacks.fn${y}; delete __eventCallbacks.ev${y};`)}function u(){return n.getElementsByTagName("*").length}function b(a=1){if(u()+a>r)throw new Error(`DOM element limit exceeded (max ${r})`)}function T(a){return a instanceof Element?1+a.getElementsByTagName("*").length:0}function C(a,h=!1){if(a==null)return null;if(o.has(a))return o.get(a);let y=a instanceof Element?se:I,S=e.createObject(y);return S.native=a,S.fromDOMParser||(S.fromDOMParser=h),o.set(a,S),S}function f(a){return a&&n.contains(a)}function w(a){return f(a)?a:null}function k(a){let h=e.createObjectProto(e.ARRAY_PROTO);for(let y=0;y<a.length;y++)e.setProperty(h,y,C(a[y]));return e.setProperty(h,"length",a.length),h}let I=e.createNativeFunction(function(){throw TypeError("Illegal constructor")},!0);e.setProperty(t,"Node",I);let j=e.getProperty(I,"prototype"),H={firstChild:function(){return C(w(this.native.firstChild))},lastChild:function(){return C(w(this.native.lastChild))},parentNode:function(){return C(w(this.native.parentNode))},parentElement:function(){return C(w(this.native.parentElement))},nextSibling:function(){return C(w(this.native.nextSibling))},previousSibling:function(){return C(w(this.native.previousSibling))},childNodes:function(){let a=Array.from(this.native.childNodes).filter(f);return k(a)},nodeName:function(){return this.native.nodeName},nodeType:function(){return this.native.nodeType},nodeValue:function(){return this.native.nodeValue},textContent:function(){return this.native.textContent}},J={textContent:function(a){i.settings.logCalls&&console.log(s.domain,"set textContent",this,a),this.native.textContent=a},nodeValue:function(a){i.settings.logCalls&&console.log(s.domain,"set nodeValue",this,a),this.native.nodeValue=a}};for(let[a,h]of Object.entries(H)){let y={get:e.createNativeFunction(h)};J[a]&&(y.set=e.createNativeFunction(J[a])),e.setProperty(j,a,Interpreter.VALUE_IN_DESCRIPTOR,y)}let Y={hasChildNodes:function(){return this.native.hasChildNodes()},appendChild:function(a){if(!a?.native)return null;if(a.fromDOMParser)throw new Error("You cannot append DOMParser elements to the DOM.");return b(T(a.native)),this.native.appendChild(a.native),i.settings.logCalls&&console.log(s.domain,"appendChild",this,a),a},append:function(a){for(let h of a)if(h?.native){if(h.fromDOMParser)throw new Error("You cannot append DOMParser elements to the DOM.");b(T(h.native)),this.native.appendChild(h.native)}return i.settings.logCalls&&console.log(s.domain,"append",this,a),a},removeChild:function(a){return!a?.native||!f(a.native)?null:(i.settings.logCalls&&console.log(s.domain,"removeChild",this,a),C(this.native.removeChild(a.native)))},insertBefore:function(a,h){if(!a?.native)return null;if(a.fromDOMParser)throw new Error("You cannot insert DOMParser elements into the DOM.");if(this.native.isSameNode(n))throw new Error("No access.");b(T(a.native));let y=h?.native||null;return this.native.insertBefore(a.native,y),i.settings.logCalls&&console.log(s.domain,"insertBefore",this,a,y),a},cloneNode:function(a){return i.settings.logCalls&&console.log(s.domain,"cloneNode",this,a),C(this.native.cloneNode(a),this.fromDOMParser)},contains:function(a){return a?.native?this.native.contains(a.native):!1},remove:function(){if(this.native.isSameNode(n))throw new Error("No access.");this.native.remove(),i.settings.logCalls&&console.log(s.domain,"remove",this)},after:function(a){if(!a?.native)return null;if(a.fromDOMParser)throw new Error("You cannot insert DOMParser elements into the DOM.");if(this.native.isSameNode(n))throw new Error("No access.");return b(T(a.native)),this.native.after(a.native),i.settings.logCalls&&console.log(s.domain,"after",this,a),a},before:function(a){if(!a?.native)return null;if(a.fromDOMParser)throw new Error("You cannot insert DOMParser elements into the DOM.");if(this.native.isSameNode(n))throw new Error("No access.");return b(T(a.native)),this.native.before(a.native),i.settings.logCalls&&console.log(s.domain,"before",this,a),a}};for(let[a,h]of Object.entries(Y))e.setProperty(j,a,e.createNativeFunction(h));let se=e.createNativeFunction(function(){throw TypeError("Illegal constructor")},!0);e.setProperty(t,"Element",se);let _=e.createObject(I);e.setProperty(se,"prototype",_);function z(a){if(!a)return"";a=String(a);let h=a.toLowerCase().trim();if(h.startsWith("javascript:")||h.startsWith("vbscript:"))throw new Error("javascript: URLs are not allowed");if(h.startsWith("data:"))return a;try{let y=new URL(a,location.href);if(y.hostname!==location.hostname)throw new Error("External URLs are not allowed");let S=y.pathname+y.search+y.hash;return S.startsWith(`/t/${s.domain}/`)||(S=`/t/${s.domain}/${S}`.replaceAll("//","/")),S}catch(y){if(y.message.includes("not allowed"))throw y;let S=a;return!S.startsWith(`/t/${s.domain}/`)&&!S.startsWith("#")&&(S=`/t/${s.domain}/${S}`.replaceAll("//","/")),S}}let G={innerText:function(){return this.native.innerText},innerHTML:function(){return this.native.innerHTML},outerHTML:function(){return this.native.outerHTML},id:function(){return this.native.id},className:function(){return this.native.className},tagName:function(){return this.native.tagName},children:function(){let a=Array.from(this.native.children).filter(f);return k(a)},firstElementChild:function(){return C(w(this.native.firstElementChild))},lastElementChild:function(){return C(w(this.native.lastElementChild))},nextElementSibling:function(){return C(w(this.native.nextElementSibling))},previousElementSibling:function(){return C(w(this.native.previousElementSibling))},childElementCount:function(){return this.native.childElementCount},src:function(){return this.native.src},href:function(){return this.native.href},hidden:function(){return this.native.hidden},disabled:function(){return this.native.disabled},checked:function(){return this.native.checked},selected:function(){return this.native.selected},readOnly:function(){return this.native.readOnly},required:function(){return this.native.required},draggable:function(){return this.native.draggable},title:function(){return this.native.title},alt:function(){return this.native.alt},name:function(){return this.native.name},type:function(){return this.native.type},value:function(){return this.native.value},placeholder:function(){return this.native.placeholder},tabIndex:function(){return this.native.tabIndex},offsetWidth:function(){return this.native.offsetWidth},offsetHeight:function(){return this.native.offsetHeight},offsetTop:function(){return this.native.offsetTop},offsetLeft:function(){return this.native.offsetLeft},clientWidth:function(){return this.native.clientWidth},clientHeight:function(){return this.native.clientHeight},scrollWidth:function(){return this.native.scrollWidth},scrollHeight:function(){return this.native.scrollHeight},scrollTop:function(){return this.native.scrollTop},scrollLeft:function(){return this.native.scrollLeft},currentTime:function(){return this.native.currentTime||0},duration:function(){return this.native.duration||0},paused:function(){return this.native.paused!==void 0?this.native.paused:!0},ended:function(){return this.native.ended||!1},muted:function(){return this.native.muted||!1},volume:function(){return this.native.volume!==void 0?this.native.volume:1},loop:function(){return this.native.loop||!1},autoplay:function(){return this.native.autoplay||!1},controls:function(){return this.native.controls||!1},playbackRate:function(){return this.native.playbackRate!==void 0?this.native.playbackRate:1},defaultPlaybackRate:function(){return this.native.defaultPlaybackRate!==void 0?this.native.defaultPlaybackRate:1},currentSrc:function(){return this.native.currentSrc||""},readyState:function(){return this.native.readyState||0},networkState:function(){return this.native.networkState||0},seeking:function(){return this.native.seeking||!1},preload:function(){return this.native.preload||"auto"},poster:function(){return this.native.poster||""},videoWidth:function(){return this.native.videoWidth||0},videoHeight:function(){return this.native.videoHeight||0}},re={innerText:function(a){this.native.innerText=a.slice(0,1e3)},innerHTML:function(a){throw new Error("innerHTML is not allowed. Create elements using document.createElement and append them instead or use innerText instead.")},id:function(a){if(this.native.className==="tile-body")throw new Error("No access.");this.native.id=a,i.settings.logCalls&&console.log(s.domain,"set id",this,a)},className:function(a){if(this.native.className==="tile-body")throw new Error("No access.");this.native.className=a,i.settings.logCalls&&console.log(s.domain,"set className",this,a)},src:function(a){this.native.src=z(a),i.settings.logCalls&&console.log(s.domain,"set src",this,a)},href:function(a){this.native.href=this.native.tagName==="A"?a:z(a),i.settings.logCalls&&console.log(s.domain,"set href",this,a)},hidden:function(a){if(this.native.className==="tile-body")throw new Error("No access.");this.native.hidden=!!a},disabled:function(a){if(this.native.className==="tile-body")throw new Error("No access.");this.native.disabled=!!a},checked:function(a){this.native.checked=!!a},selected:function(a){this.native.selected=!!a},readOnly:function(a){this.native.readOnly=!!a},required:function(a){this.native.required=!!a},draggable:function(a){this.native.draggable=!!a},title:function(a){this.native.title=String(a).slice(0,1e3)},alt:function(a){this.native.alt=String(a).slice(0,1e3)},name:function(a){this.native.name=String(a).slice(0,100)},type:function(a){this.native.type=String(a).slice(0,50)},value:function(a){this.native.value=String(a).slice(0,1e4)},placeholder:function(a){this.native.placeholder=String(a).slice(0,500)},tabIndex:function(a){this.native.tabIndex=parseInt(a)||0},scrollTop:function(a){this.native.scrollTop=a},scrollLeft:function(a){this.native.scrollLeft=a},currentTime:function(a){this.native instanceof HTMLMediaElement&&(this.native.currentTime=Math.max(0,Number(a)||0))},muted:function(a){this.native instanceof HTMLMediaElement&&(this.native.muted=!!a)},volume:function(a){this.native instanceof HTMLMediaElement&&(this.native.volume=Math.max(0,Math.min(1,Number(a)||0)))},loop:function(a){this.native instanceof HTMLMediaElement&&(this.native.loop=!!a)},autoplay:function(a){this.native instanceof HTMLMediaElement&&(this.native.autoplay=!!a)},controls:function(a){this.native instanceof HTMLMediaElement&&(this.native.controls=!!a)},playbackRate:function(a){this.native instanceof HTMLMediaElement&&(this.native.playbackRate=Math.max(.25,Math.min(4,Number(a)||1)))},defaultPlaybackRate:function(a){this.native instanceof HTMLMediaElement&&(this.native.defaultPlaybackRate=Math.max(.25,Math.min(4,Number(a)||1)))},preload:function(a){if(this.native instanceof HTMLMediaElement){let h=["none","metadata","auto"];this.native.preload=h.includes(a)?a:"auto"}},poster:function(a){this.native instanceof HTMLVideoElement&&(this.native.poster=z(a))}};for(let[a,h]of Object.entries(G)){let y={get:e.createNativeFunction(h)};re[a]&&(y.set=e.createNativeFunction(re[a])),e.setProperty(_,a,Interpreter.VALUE_IN_DESCRIPTOR,y)}let me={getAttributeNames:function(){let a=Array.from(this.native.getAttributeNames()),h=e.createObjectProto(e.ARRAY_PROTO);for(let y=0;y<a.length;y++)e.setProperty(h,y,a[y]);return e.setProperty(h,"length",a.length),h},getAttribute:function(a){return this.native.getAttribute(a)},setAttribute:function(a,h){if(this.native.className==="tile-body")throw new Error("No access.");if(a=String(a).toLowerCase(),h=String(h),i.settings.logCalls&&console.log(s.domain,"setAttribute",this,a,h),a==="style"&&h.includes("animation-play-state")&&h.includes("!important"))throw new Error("Cannot set animation-play-state to !important");if(a==="src"||a==="poster"||a==="data"||this.native.tagName!=="A"&&a==="href"){this.native.setAttribute(a,z(h));return}if(a==="autoplay")throw new Error("autoplay is not allowed");if(a==="srcset")throw new Error("srcset is not allowed");if(a==="action"||a==="formaction")throw new Error("action and formaction are not allowed");if(a.startsWith("on"))throw new Error("Event handlers are not allowed. Use addEventListener instead.");if(a==="width"||a==="height"){let y=parseFloat(h);if(isNaN(y)||y<0||y>4096)throw new Error("Invalid width or height")}this.native.setAttribute(a,h)},focus:function(){this.native.focus()},blur:function(){this.native.blur()},click:function(){this.native.click()},scrollIntoView:function(a){a&&typeof a=="object"?this.native.scrollIntoView(e.pseudoToNative(a)):this.native.scrollIntoView(a)},scrollTo:function(a,h){this.native.scrollTo(a,h)},scrollBy:function(a,h){this.native.scrollBy(a,h)},removeAttribute:function(a){if(this.native.className==="tile-body")throw new Error("No access.");if(a=String(a).toLowerCase(),a==="target")throw new Error("removing target is not allowed");i.settings.logCalls&&console.log(s.domain,"removeAttribute",this,a),this.native.removeAttribute(a)},hasAttribute:function(a){return this.native.hasAttribute(a)},querySelector:function(a){let h=this.native.querySelector(a);return C(w(h))},querySelectorAll:function(a){let h=Array.from(this.native.querySelectorAll(a)).filter(f);return k(h)},getElementsByClassName:function(a){let h=Array.from(this.native.getElementsByClassName(a)).filter(f);return k(h)},getElementsByTagName:function(a){let h=Array.from(this.native.getElementsByTagName(a)).filter(f);return k(h)},closest:function(a){let h=this.native.closest(a);for(;h&&!n.contains(h);)h=null;return C(h)},matches:function(a){return this.native.matches(a)},classList:function(){if(this.native.className==="tile-body")throw new Error("No access.");let a=this.native.classList;return e.nativeToPseudo({add:(...h)=>a.add(...h),remove:(...h)=>a.remove(...h),toggle:(h,y)=>a.toggle(h,y),contains:h=>a.contains(h),replace:(h,y)=>a.replace(h,y)})},getBoundingClientRect:function(){let a=this.native.getBoundingClientRect();return e.nativeToPseudo({x:a.x,y:a.y,width:a.width,height:a.height,top:a.top,right:a.right,bottom:a.bottom,left:a.left})},play:function(){if(!(this.native instanceof HTMLMediaElement))return e.createObjectProto(e.OBJECT_PROTO);if(!this.native.isConnected)throw new Error("Element is not connected to the DOM. Append it to the DOM before playing.");let a=e.createObjectProto(e.OBJECT_PROTO),h=this,y=null,S=null;return i.settings.logCalls&&console.log(s.domain,"play",this),e.setProperty(a,"then",e.createNativeFunction(function(L){return y=L,a})),e.setProperty(a,"catch",e.createNativeFunction(function(L){return S=L,a})),h.native.play().then(()=>{y&&d(y,e.nativeToPseudo(void 0))}).catch(L=>{S&&d(S,e.nativeToPseudo({message:L.message,name:L.name}))}),a},pause:function(){this.native instanceof HTMLMediaElement&&this.native.pause()},load:function(){this.native instanceof HTMLMediaElement&&this.native.load()},canPlayType:function(a){return this.native instanceof HTMLMediaElement?this.native.canPlayType(String(a||"")):""},fastSeek:function(a){this.native instanceof HTMLMediaElement&&typeof this.native.fastSeek=="function"&&this.native.fastSeek(Math.max(0,Number(a)||0))},getAnimations:function(a){if(!this.native.getAnimations)return k([]);let h=a?{subtree:!!e.pseudoToNative(a)?.subtree}:{},y=this.native.getAnimations(h),S=e.createObjectProto(e.ARRAY_PROTO);for(let L=0;L<y.length;L++)S.properties[L]=l(y[L]);return e.setProperty(S,"length",y.length),S}};for(let[a,h]of Object.entries(me))e.setProperty(_,a,e.createNativeFunction(h));function l(a){let h=e.createObjectProto(e.OBJECT_PROTO);return e.setProperty(h,"id",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a.id})}),e.setProperty(h,"playState",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a.playState})}),e.setProperty(h,"pending",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a.pending})}),e.setProperty(h,"replaceState",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a.replaceState})}),e.setProperty(h,"currentTime",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a.currentTime}),set:e.createNativeFunction(function(y){a.currentTime=y})}),e.setProperty(h,"playbackRate",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a.playbackRate}),set:e.createNativeFunction(function(y){a.playbackRate=Math.max(-10,Math.min(10,Number(y)||1))})}),e.setProperty(h,"startTime",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a.startTime}),set:e.createNativeFunction(function(y){a.startTime=y})}),e.setProperty(h,"play",e.createNativeFunction(function(){a.play()})),e.setProperty(h,"pause",e.createNativeFunction(function(){a.pause()})),e.setProperty(h,"cancel",e.createNativeFunction(function(){a.cancel()})),e.setProperty(h,"finish",e.createNativeFunction(function(){a.finish()})),e.setProperty(h,"reverse",e.createNativeFunction(function(){a.reverse()})),e.setProperty(h,"updatePlaybackRate",e.createNativeFunction(function(y){a.updatePlaybackRate(Math.max(-10,Math.min(10,Number(y)||1)))})),h}function m(a){let h=e.createObjectProto(e.OBJECT_PROTO),y=a?a.length:0;return e.setProperty(h,"length",y),e.setProperty(h,"start",e.createNativeFunction(function(S){if(!a||S<0||S>=a.length)throw new Error("Index out of bounds");return a.start(S)})),e.setProperty(h,"end",e.createNativeFunction(function(S){if(!a||S<0||S>=a.length)throw new Error("Index out of bounds");return a.end(S)})),h}e.setProperty(_,"buffered",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native instanceof HTMLMediaElement?m(this.native.buffered):m(null)})}),e.setProperty(_,"played",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native instanceof HTMLMediaElement?m(this.native.played):m(null)})}),e.setProperty(_,"seekable",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return this.native instanceof HTMLMediaElement?m(this.native.seekable):m(null)})}),e.setProperty(_,"classList",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let a=this.native.classList,h=e.nativeToPseudo({});return e.setProperty(h,"add",e.createNativeFunction(function(...y){if(this.native.className==="tile-body")throw new Error("No access.");a.add(...y)})),e.setProperty(h,"remove",e.createNativeFunction(function(...y){if(this.native.className==="tile-body")throw new Error("No access.");a.remove(...y)})),e.setProperty(h,"toggle",e.createNativeFunction(function(y,S){if(this.native.className==="tile-body")throw new Error("No access.");return a.toggle(y,S)})),e.setProperty(h,"contains",e.createNativeFunction(function(y){return a.contains(y)})),e.setProperty(h,"replace",e.createNativeFunction(function(y,S){if(this.native.className==="tile-body")throw new Error("No access.");return a.replace(y,S)})),h})}),e.setProperty(_,"style",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let a=this.native.style,h=e.nativeToPseudo({}),y=["color","backgroundColor","width","height","margin","padding","border","display","position","top","left","right","bottom","fontSize","fontFamily","fontWeight","textAlign","lineHeight","opacity","visibility","overflow","zIndex","transform","transition","animation","flexDirection","justifyContent","alignItems","gap","gridTemplateColumns","gridTemplateRows"];for(let S of y)e.setProperty(h,S,Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a[S]}),set:e.createNativeFunction(function(L){a[S]=L,i.settings.logCalls&&console.log(s.domain,"set style",this,S,L)})});return e.setProperty(h,"cssText",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return a.cssText}),set:e.createNativeFunction(function(S){a.cssText=S,i.settings.logCalls&&console.log(s.domain,"set cssText",this,S)})}),e.setProperty(h,"setProperty",e.createNativeFunction(function(S,L,O){if(this.native?.className==="tile-body")throw new Error("No access.");a.setProperty(S,L,O),i.settings.logCalls&&console.log(s.domain,"setProperty",this,S,L,O)})),e.setProperty(h,"getPropertyValue",e.createNativeFunction(function(S){return a.getPropertyValue(S)})),e.setProperty(h,"removeProperty",e.createNativeFunction(function(S){if(this.native?.className==="tile-body")throw new Error("No access.");return i.settings.logCalls&&console.log(s.domain,"removeProperty",this,S),a.removeProperty(S)})),h})}),e.setProperty(_,"dataset",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let a=this.native.dataset,h=e.nativeToPseudo({});for(let y in a)e.setProperty(h,y,a[y]);return e.setProperty(h,"get",e.createNativeFunction(function(y){return a[y]})),e.setProperty(h,"set",e.createNativeFunction(function(y,S){a[y]=String(S).slice(0,1e3),i.settings.logCalls&&console.log(s.domain,"set dataset",this,y,S)})),e.setProperty(h,"delete",e.createNativeFunction(function(y){delete a[y],i.settings.logCalls&&console.log(s.domain,"delete dataset",this,y)})),e.setProperty(h,"has",e.createNativeFunction(function(y){return y in a})),h})}),e.setProperty(_,"offsetParent",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return C(w(this.native.offsetParent))})});let E=["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","keydown","keyup","keypress","focus","blur","focusin","focusout","input","change","submit","reset","touchstart","touchend","touchmove","touchcancel","wheel","scroll","resize","dragstart","drag","dragend","dragenter","dragleave","dragover","drop","animationstart","animationend","animationiteration","transitionstart","transitionend","transitioncancel","contextmenu","pointerdown","pointerup","pointermove","pointerenter","pointerleave","pointerover","pointerout","play","pause","playing","waiting","seeking","seeked","ended","loadstart","loadeddata","loadedmetadata","progress","canplay","canplaythrough","timeupdate","durationchange","volumechange","ratechange","stalled","suspend","emptied","abort","error","load"];function x(a){let h=e.nativeToPseudo({}),y=["type","bubbles","cancelable","defaultPrevented","timeStamp"];for(let S of y)e.setProperty(h,S,a[S]);if(a instanceof MouseEvent||a instanceof PointerEvent){let S=["clientX","clientY","pageX","pageY","screenX","screenY","offsetX","offsetY","movementX","movementY","button","buttons","altKey","ctrlKey","shiftKey","metaKey"];for(let L of S)e.setProperty(h,L,a[L])}if(a instanceof KeyboardEvent){let S=["key","code","keyCode","charCode","altKey","ctrlKey","shiftKey","metaKey","repeat"];for(let L of S)e.setProperty(h,L,a[L])}return typeof TouchEvent=="function"&&a instanceof TouchEvent&&(e.setProperty(h,"touches",e.nativeToPseudo({length:a.touches.length})),e.setProperty(h,"changedTouches",e.nativeToPseudo({length:a.changedTouches.length}))),typeof WheelEvent=="function"&&a instanceof WheelEvent&&(e.setProperty(h,"deltaX",a.deltaX),e.setProperty(h,"deltaY",a.deltaY),e.setProperty(h,"deltaZ",a.deltaZ),e.setProperty(h,"deltaMode",a.deltaMode)),a.target&&f(a.target)&&e.setProperty(h,"target",C(a.target)),a.currentTarget&&f(a.currentTarget)&&e.setProperty(h,"currentTarget",C(a.currentTarget)),e.setProperty(h,"preventDefault",e.createNativeFunction(function(){a.preventDefault()})),e.setProperty(h,"stopPropagation",e.createNativeFunction(function(){a.stopPropagation()})),e.setProperty(h,"stopImmediatePropagation",e.createNativeFunction(function(){a.stopImmediatePropagation()})),h}e.setProperty(_,"addEventListener",e.createNativeFunction(function(a,h){if(!a||typeof a!="string"||!h||typeof h!="object")return;if(a=a.toLowerCase(),!E.includes(a))throw new Error(`Event type "${a}" is not allowed`);i.settings.logCalls&&console.log(s.domain,"addEventListener",this,a,h);let y=this.native;p.has(y)||p.set(y,new Map);let S=p.get(y);S.has(a)||S.set(a,[]);let L=S.get(a);if(L.length>=c)throw new Error(`Maximum listeners (${c}) reached for event "${a}"`);if(L.some(U=>U.pseudo===h))return;let O=function(U){let ce=x(U);d(h,ce)};L.push({pseudo:h,native:O}),y.addEventListener(a,O)})),e.setProperty(_,"removeEventListener",e.createNativeFunction(function(a,h){if(!a||typeof a!="string"||!h||typeof h!="object")return;i.settings.logCalls&&console.log(s.domain,"removeEventListener",this,a,h),a=a.toLowerCase();let y=this.native;if(!p.has(y))return;let S=p.get(y);if(!S.has(a))return;let L=S.get(a),O=L.findIndex(U=>U.pseudo===h);O!==-1&&(y.removeEventListener(a,L[O].native),L.splice(O,1))}));let P=["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","keydown","keyup","keypress","focus","blur","input","change","submit","touchstart","touchend","touchmove","wheel","scroll","contextmenu","play","pause","playing","waiting","seeking","seeked","ended","loadstart","loadeddata","loadedmetadata","progress","canplay","canplaythrough","timeupdate","durationchange","volumechange","ratechange","stalled","suspend","emptied","abort","error","load"];for(let a of P){let h="on"+a;e.setProperty(_,h,Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){let y=this.native;if(!p.has(y))return null;let S=p.get(y),L=`__${h}`;return S.get(L)||null}),set:e.createNativeFunction(function(y){let S=this.native;p.has(S)||p.set(S,new Map);let L=p.get(S),O=`__${h}`;i.settings.logCalls&&console.log(s.domain,"setOn"+a,this,y);let U=L.get(O+"_native");if(U&&(S.removeEventListener(a,U),L.delete(O),L.delete(O+"_native")),y&&typeof y=="object"){let ce=function(Ke){let Qe=x(Ke);d(y,Qe)};S.addEventListener(a,ce),L.set(O,y),L.set(O+"_native",ce)}})})}Re(e,t,s).extendElement(_,C),Ae(e,t,s),$e(e,t,s.domain),Be(e,t,n,s);let D=e.nativeToPseudo({});e.setProperty(t,"document",D);let q={getElementById:function(a){let h=n.querySelector(`#${CSS.escape(a)}`);return C(h)},getElementsByClassName:function(a){let h=Array.from(n.getElementsByClassName(a));return k(h)},getElementsByTagName:function(a){let h=Array.from(n.getElementsByTagName(a));return k(h)},querySelector:function(a){return C(n.querySelector(a))},querySelectorAll:function(a){let h=Array.from(n.querySelectorAll(a));return k(h)},createElement:function(a){if(typeof a!="string")throw new Error("Invalid tag");if(a=a.toLowerCase().trim(),["script","style","iframe","embed","object","frame","frameset","layer","ilayer","applet","meta","base","link","title","source","geolocation","permission"].includes(a))throw new Error("Creating "+a+" elements is not allowed");return i.settings.logCalls&&console.log(s.domain,"createElement",this,a),C(document.createElement(a))},createTextNode:function(a){return i.settings.logCalls&&console.log(s.domain,"createTextNode",this,a),C(document.createTextNode(a))}};for(let[a,h]of Object.entries(q))e.setProperty(D,a,e.createNativeFunction(h));e.setProperty(D,"body",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return i.settings.logCalls&&console.log(s.domain,"get body",this),C(n)})}),e.setProperty(D,"documentElement",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return i.settings.logCalls&&console.log(s.domain,"get documentElement",this),C(n)})});let ie=e.nativeToPseudo({});e.setProperty(t,"location",ie),e.setProperty(ie,"href",Interpreter.VALUE_IN_DESCRIPTOR,{get:e.createNativeFunction(function(){return`/t/${s.domain}${s.path}`}),set:e.createNativeFunction(function(a){if(typeof a=="string"){i.settings.logCalls&&console.log(s.domain,"set href",this,a);try{let h=new URL(a,`http://${s.domain}`);if(h.hostname&&h.hostname!==location.hostname)throw new Error("External URLs are not allowed");let y=h.pathname+h.search+h.hash;if(y.startsWith(`/t/${s.domain}/`)?y=y.substring(`/t/${s.domain}`.length):y===`/t/${s.domain}`&&(y="/"),y.startsWith("/")||(y="/"+y),y.endsWith(".html")||y==="/"||y==="")s.fetchContent(y||"/index.html"),s.setActive(!0);else throw new Error("Only HTML files can be navigated to")}catch(h){if(h.message.includes("not allowed")||h.message.includes("Only HTML"))throw h;let y=a;if(y.startsWith("/")||(y="/"+y),y.endsWith(".html")||y==="/"||y==="")s.fetchContent(y||"/index.html").then(()=>s.setActive(!0));else throw new Error("Only HTML files can be navigated to")}}})}),e.setProperty(ie,"reload",e.createNativeFunction(function(){s.fetchContent(s.path,!0).then(()=>s.setActive(!0))}))}var ut={console:{log:function(...e){this.logCount++>1e3||console.log(`[${this.tile.domain}]`,...e)},error:function(...e){this.logCount++>1e3||console.error(`[${this.tile.domain}]`,...e)},warn:function(...e){this.logCount++>1e3||console.warn(`[${this.tile.domain}]`,...e)}},alert(e){this.alertCount++>10||alert(`[${this.tile.domain}] ${e}`)},prompt(e){if(!(this.alertCount++>10))return prompt(`[${this.tile.domain}] ${e}`)},confirm(e){if(!(this.alertCount++>10))return confirm(`[${this.tile.domain}] ${e}`)},atob(e){return atob(e)},btoa(e){return btoa(e)}},ye=class{constructor(t){this.running=!1,this.logCount=0,this.alertCount=0,this.tile=t,this.waitUntil=null,this.index=0,this.sizeLimitReached=!1,this.interpreter=new Interpreter("",(n,s)=>{let o=(r,c)=>{for(let[p,g]of Object.entries(r))if(typeof g=="function")n.setProperty(c,p,n.createNativeFunction(g.bind(this)));else if(typeof g=="object"&&g!==null){let v=n.nativeToPseudo({});o(g,v),n.setProperty(c,p,v)}};o(ut,s),He(n,s,this.tile.contentElement,this.tile),n.setProperty(s,"embedded",n.nativeToPseudo(!!this.tile.embed))}),this.runInterval=null,this.running=!1}roughValueMemorySize(){let t=new Set,n=[this.interpreter.getStateStack()],s=0;for(;n.length;){let o=n.pop(),r=typeof o;if(s+=8,r==="string"&&!t.has(o))t.add(o),s+=o.length*2;else if(r==="object"&&o!==null&&!t.has(o)){t.add(o);try{n.push(...Object.keys(o),...Object.values(o))}catch{}}}return s}start(){this.running||i.settings.disableJS||this.sizeLimitReached||(this.running=!0,this.runInterval=setInterval(()=>{if(!(this.waitUntil&&Date.now()<this.waitUntil)&&this.running)for(let t=0;t<5e3;t++)try{if(!this.interpreter.step()){this.waitUntil=Date.now()+50;break}if(this.index++%500===0){let n=this.roughValueMemorySize();if(n>3e6){this.sizeLimitReached=!0,this.stop(),console.log(`[${this.tile.domain}] Memory size limit reached: ${n} bytes`);break}}}catch(n){console.error(n),this.stop();break}},0))}stop(){this.running&&(clearInterval(this.runInterval),this.running=!1)}runCode(t){i.settings.disableJS||this.interpreter.appendCode(t)}},je=ye;var ht=document.getElementById("plot"),ze=new CSSStyleSheet,ft=()=>{ze.replaceSync(`
        .tile-body:not(.active) * {
            animation-play-state: paused !important;
        }
        .tile-body:not(.active) * {
            text-shadow: none !important;
            box-shadow: none !important;
            filter: none !important;
            backdrop-filter: none !important;
        }
    `)};ft();var qe=new CSSStyleSheet;qe.replaceSync(`
    .free {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .free > p {
        text-align: center;
        color: #777;
        user-select: none;
    }    
`);var $=class e{constructor(t){this.x=t.x??0,this.y=t.y??0,this.domain=t.domain,this.free=!t.domain,this.locked=!1,this.id=`${this.x},${this.y}`,this.rendered=!1,this.active=!1,this.element=null,this.contentElement=null,this.path=t.path||"/index.html",this.content="",this.lastRender=0,this.preview=t.nocontrols||!1,this.embed=t.embed||!1,this.container=t.container||ht,this.interpreter=null,this.render()}static toTilePosition(t,n){return{x:Math.floor(t/250),y:Math.floor(n/250)}}render(){if(this.rendered||this.element)return;this.lastRender=Date.now(),this.rendered=!0;let t=document.createElement("div");t.classList.add("tile"),this.free&&t.classList.add("f"),this.preview?t.style.cssText="width: 100%; height: 100%; position: relative;":(t.style.left=`${this.x*250}px`,t.style.top=`${this.y*250}px`,this.x%10===0&&t.classList.add("b-left"),this.y%10===0&&t.classList.add("b-top")),this.element=t;let n=document.createElement("div");n.classList.add("tile-content"),this.preview&&(n.style.cssText="width: 100%; height: 100%;"),n.addEventListener("click",async o=>{let r=o.composedPath()?.filter(v=>v instanceof Element);if(!r)return;let c=r.findIndex(v=>v.isSameNode(n));if(c===-1)return;let g=r.slice(0,c).find(v=>v.tagName==="A");if(g){o.preventDefault();try{let v=new URL(g.href);if(v.hostname!==location.hostname){let u=document.createElement("a");u.href=g.href,u.target="_blank",u.click();return}let d=v.pathname;if(d.startsWith(`/t/${this.domain}/`)||(d=`/t/${this.domain}/${d}`.replaceAll("//","/")),d.startsWith(`/t/${this.domain}`)&&(d.endsWith(".html")||d===`/t/${this.domain}/`||d===`/t/${this.domain}`))await this.fetchContent(d.replace(`/t/${this.domain}`,"")),this.setActive(!0);else{let u=document.createElement("a");u.href=g.href,u.target="_blank",u.click()}}catch(v){console.error(v)}}}),this.shadow=n.attachShadow({mode:"open"});let s=document.createElement("div");s.className="tile-body",this.embed&&s.classList.add("embedded"),s.style="width: 100%!important; height: 100%!important;position:absolute!important;top:0!important;left:0!important;",this.contentElement=s,this.contentElement.innerHTML=this.preview?"Loading preview...":`Loading ${this.x}, ${this.y}...`,this.shadow.appendChild(s),t.appendChild(n),this.fonts=document.createElement("style"),t.appendChild(this.fonts),this.fetchContent(this.path),this.container&&this.container.appendChild(t),i.plot?.lockCache[this.x+","+this.y]&&this.setLocked(!0)}unrender(){!this.rendered||!this.element||(this.active&&this.setActive(!1),this.element.remove(),this.element=null,this.rendered=!1,this.interpreter&&(this.interpreter.stop(),this.interpreter=null))}async fetchContent(t,n=!1){t.startsWith("/")||(t="/"+t);let s=this.free?`<div class="free">
                <p>${this.locked?"Locked tile":"Free tile"} ${this.x}, ${this.y}</p>
            </div>`:this.path===t&&this.content&&!n?this.content:await fetch(`/t/${this.domain}${t}`).then(c=>c.text()).catch(c=>"<p>Error loading tile</p>");this.free?this.shadow.adoptedStyleSheets=[qe]:this.shadow.adoptedStyleSheets=[ze],this.interpreter&&(this.interpreter.stop(),this.interpreter=null),this.path=t,this.contentElement.innerHTML=s,this.content=s;let o=this.contentElement.querySelectorAll("style");this.fonts.textContent="";let r=0;for(let c of o){if(r>=3)break;let p=c.textContent.match(/@font-face\s*{([^}]*)}/g);if(p)for(let g of p){if(r>=3)break;this.fonts.textContent+=g,r++}}this.preview&&this.setActive(!0)}executeScripts(){let t=this.contentElement.querySelectorAll('script[type="text/tilescript"]');for(let n of t)this.interpreter.runCode(n.textContent);this.preview&&this.interpreter.start()}setActive(t){if(this.element&&(t&&(this.interpreter||(this.interpreter=new je(this),this.executeScripts()),this.interpreter.start()),t!==this.active)){if(this.active=t,t){if(this.element.classList.add("active"),this.contentElement.classList.add("active"),!this.preview&&i.ui){let s=i.ui.createVoteMenu(this);s&&this.element.appendChild(s);let o=i.ui.createTileControl(this);if(this.element.appendChild(o),i.user?.admin||i.user?.moderator){let r=i.ui.createAdminControl(this);this.element.appendChild(r)}i.plot?.activeTile&&i.plot.activeTile.setActive(!1),i.plot&&(i.plot.activeTile=this),this.fetchAndShowClanBorders()}let n=this.contentElement.querySelectorAll("audio, video");for(let s of n)s.dataset.webtilesPaused==="true"&&(s.dataset.webtilesPaused=!1,s.play())}else if(!this.preview){this.interpreter&&this.interpreter.stop(),i.plot.activeTile=null,this.element.classList.remove("active"),this.contentElement.classList.remove("active"),this.preview||(this.element.querySelector(".tile-vote-menu")?.remove(),this.element.querySelector(".tile-info")?.remove(),this.element.querySelector(".tile-admin-panel")?.remove(),i.plot&&(i.plot.activeTile=null)),e.clearClanBorders();let n=this.contentElement.querySelectorAll("audio, video");for(let s of n)s.paused||(s.dataset.webtilesPaused=!0,s.pause())}}}async fetchAndShowClanBorders(){if(!(this.free||!this.domain))try{let n=await(await i.api.makeRequest(`/api/clans/tile-clan?domain=${encodeURIComponent(this.domain)}`)).json();if(!n.success||!n.clan)return;let s=n.clan.members;if(!s||s.length<=1)return;let o=new Set(s.map(r=>`${r.x},${r.y}`));for(let r of s){let c=i.plot.tiles[`${r.x},${r.y}`];if(!c?.element)continue;c.element.classList.add("clan-highlight");let p=o.has(`${r.x},${r.y-1}`),g=o.has(`${r.x},${r.y+1}`),v=o.has(`${r.x-1},${r.y}`),d=o.has(`${r.x+1},${r.y}`);if(!p){let u=document.createElement("div");u.className="clan-border clan-border-top",c.element.appendChild(u)}if(!g){let u=document.createElement("div");u.className="clan-border clan-border-bottom",c.element.appendChild(u)}if(!v){let u=document.createElement("div");u.className="clan-border clan-border-left",c.element.appendChild(u)}if(!d){let u=document.createElement("div");u.className="clan-border clan-border-right",c.element.appendChild(u)}}}catch(t){console.error("Failed to fetch clan borders:",t)}}static clearClanBorders(){if(i.plot?.tiles)for(let t of Object.values(i.plot.tiles))t.element&&(t.element.classList.remove("clan-highlight"),t.element.querySelectorAll(".clan-border").forEach(s=>s.remove()))}setDomain(t){this.domain=t,this.free=!1,this.content="",this.element&&this.element.classList.remove("f"),this.fetchContent("/index.html")}setFree(){this.interpreter&&this.interpreter.stop(),this.domain=null,this.free=!0,this.content="",this.element&&this.element.classList.add("f"),this.fetchContent("/index.html")}setLocked(t){this.locked=t,this.element&&this.element.classList.toggle("locked",t),this.fetchContent("/index.html",!0)}};i.ui={coords:document.querySelector("#coords"),zoomSlider:document.querySelector("#zoom-slider > input"),siteSelector:document.querySelector("#kicya-site-selector"),siteJumpButton:document.querySelector("#kicya-site-jump"),siteCenterButton:document.querySelector("#kicya-site-center"),siteEditButton:document.querySelector("#kicya-site-edit"),siteClanButton:document.querySelector("#kicya-site-clan"),siteEmbedButton:document.querySelector("#kicya-site-embed"),clanIndicator:document.querySelector("#kicya-clan-indicator"),pendingClanInvites:[],createElement:(e,t={})=>{let n=document.createElement(e);for(let[s,o]of Object.entries(t))s==="innerText"?n.innerText=o:s==="innerHTML"?n.innerHTML=o:s.startsWith("on")?n.addEventListener(s.slice(2).toLowerCase(),o):n.setAttribute(s,o);return n},escapeHTML:e=>e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):"",showDashboard:e=>{Ye.src=`/dashboard?site=${encodeURIComponent(e)}&path=/`,We&&(We.textContent=`File Manager - ${e}`),Ve.classList.add("active"),fe&&(fe.style.display="none"),i.camera&&i.camera.setZoomEnabled(!1),i.ws?.isConnected&&setTimeout(()=>{let t=new Int16Array(3);t[0]=0,t[1]=0,t[2]=0,i.ws.send(t.buffer)},100)},showClaimModal:e=>{if(!i.user){location.href="https://kicya.net/auth/login?redirect="+encodeURIComponent("https://webtiles.kicya.net/");return}let t=i.user.selectedSite;if(!t){alert("Please select a site first");return}let n=t.domain,s=t.tile?`<strong>Warning</strong>Your current tile at (${t.tile.x}, ${t.tile.y}) will be unclaimed and your site will be moved to this new tile.`:null;new R({title:"Claim Tile",content:`<p>Do you want to claim tile (${e.x}, ${e.y}) for <strong>${i.ui.escapeHTML(n)}</strong>?</p>`,warning:s,buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:r=>r.close()},{text:"Claim",type:"confirm",id:"confirm",onClick:async r=>{r.setButtonLoading("confirm",!0,"Claiming...");try{let p=await(await i.api.makeRequest("/api/claim",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y})})).json();if(p.success){if(i.user.selectedSite){if(i.user.selectedSite.tile){let g=i.plot.getTile(i.user.selectedSite.tile.x,i.user.selectedSite.tile.y);g&&g.setFree()}i.user.selectedSite.tile={x:e.x,y:e.y,code:p.code,domain:i.user.selectedSite.domain,created_at:Date.now()}}setTimeout(()=>{e.setDomain(i.user.selectedSite.domain),e.setActive(!1),e.element&&e.element.classList.toggle("locked",!1)},400),r.close(),Q()}else alert(p.error||"Failed to claim tile"),r.setButtonLoading("confirm",!1)}catch(c){console.error(c),alert("Failed to claim tile: "+c.message),r.setButtonLoading("confirm",!1)}}}]}).open()},showUnlockModal:e=>{if(!i.user){location.href="https://kicya.net/auth/login?redirect="+encodeURIComponent("https://webtiles.kicya.net/");return}let t=i.user.selectedSite;if(!t){alert("Please select a site first");return}let n=t.domain,s=t.tile?`<strong>Warning</strong>Your current tile at (${t.tile.x}, ${t.tile.y}) will be unclaimed and your site will be moved to this new tile.`:null,o=new R({title:"Unlock & Claim Tile",content:`
                <p>Enter the unlock code to claim the tile at (${e.x}, ${e.y}) for <strong>${i.ui.escapeHTML(n)}</strong>:</p>
                <div class="code-input-container">
                    <input type="text" id="unlock-code-input" class="modal-input" placeholder="Enter unlock code..." autocomplete="off" />
                </div>
            `,warning:s,buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:r=>r.close()},{text:"Unlock & Claim",type:"confirm",id:"confirm",onClick:async r=>{let p=o.element.querySelector("#unlock-code-input").value.trim();if(!p){alert("Please enter a code");return}r.setButtonLoading("confirm",!0,"Unlocking...");try{let v=await(await i.api.makeRequest("/api/claim",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y,code:p})})).json();if(v.success){if(delete i.plot.lockCache[e.x+","+e.y],i.user.selectedSite){if(i.user.selectedSite.tile){let d=i.plot.getTile(i.user.selectedSite.tile.x,i.user.selectedSite.tile.y);d&&d.setFree()}i.user.selectedSite.tile={x:e.x,y:e.y,code:v.code,domain:i.user.selectedSite.domain,created_at:Date.now()}}e.setDomain(i.user.selectedSite.domain),e.setActive(!1),r.close(),Q()}else alert(v.error||"Failed to unlock tile"),r.setButtonLoading("confirm",!1)}catch(g){console.error(g),alert("Failed to unlock tile: "+g.message),r.setButtonLoading("confirm",!1)}}}]});o.open(),setTimeout(()=>{let r=o.element.querySelector("#unlock-code-input");r&&r.focus()},100)},updateClanIndicator:()=>{i.ui.clanIndicator&&(i.ui.clanIndicator.hidden=i.ui.pendingClanInvites.length===0)},fetchClanInvites:async()=>{if(!(!i.user||!i.user.selectedSite))try{let t=await(await i.api.makeRequest("/api/clans/invites")).json();t.success&&(i.ui.pendingClanInvites=t.invites||[],i.ui.updateClanIndicator())}catch(e){console.error("Failed to fetch clan invites:",e)}},showClanModal:async()=>{if(!i.user){location.href="https://kicya.net/auth/login?redirect="+encodeURIComponent("https://webtiles.kicya.net/");return}if(!i.user.selectedSite){alert("Please select a site first");return}let e=new R({title:"Clan Management",content:"<p>Loading...</p>",buttons:[{text:"Close",type:"cancel",id:"close",onClick:t=>t.close()}]});e.open();try{let[t,n]=await Promise.all([i.api.makeRequest("/api/clans/current"),i.api.makeRequest("/api/clans/invites")]),s=await t.json(),o=await n.json();i.ui.pendingClanInvites=o.invites||[],i.ui.updateClanIndicator();let r=i.user?.admin||i.user?.moderator;s.success&&s.clan?i.ui.renderClanInfo(e,s.clan,r):i.ui.renderNoClan(e,o.invites||[],r)}catch(t){console.error(t),e.setContent("<p>Failed to load clan data: "+i.ui.escapeHTML(t.message)+"</p>")}},renderClanInfo:(e,t,n)=>{let s=`
            <div class="clan-name-display">${i.ui.escapeHTML(t.name)}</div>
            <div class="clan-stats">${t.members.length}/5 members. ${t.members.length<3?"Unprotected! Reach 3 members to protect your tiles.":"Your tiles are protected."}</div>
        `;s+=`<div class="clan-section">
            <div class="clan-section-title">Members</div>
            <div class="clan-members-list">`;for(let d of t.members){let u=d.domain===i.user.sites.find(b=>b.tile?.x===d.x&&b.tile?.y===d.y)?.domain;s+=`<div class="clan-member-item">
                <span class="clan-member-domain">${i.ui.escapeHTML(d.domain)}</span>
                <div>`,t.isOwner&&d.domain!==i.user.selectedSite?.domain&&(s+=`<button class="clan-member-kick" data-domain="${i.ui.escapeHTML(d.domain)}">Kick</button>`),s+=`</div>
            </div>`}if(s+="</div></div>",t.isOwner&&t.pendingInvites&&t.pendingInvites.length>0){s+=`<div class="clan-section">
                <div class="clan-section-title">Pending Invites</div>
                <div class="clan-pending-list">`;for(let d of t.pendingInvites)s+=`<div class="clan-pending-item">
                    <span>${i.ui.escapeHTML(d.domain)}</span>
                    <button class="clan-pending-cancel" data-invite="${d.id}">Cancel</button>
                </div>`;s+="</div></div>"}t.isOwner&&t.members.length<5&&(s+=`<div class="clan-section">
                <div class="clan-section-title">Invite Neighboring Tile</div>
                <div class="code-input-container" style="margin: 5px 0;">
                    <input type="text" id="clan-invite-domain" class="modal-input" placeholder="Enter domain..." autocomplete="off" style="font-family: inherit;" />
                </div>
                <button class="modal-btn modal-btn-confirm" id="clan-invite-btn" style="margin-top: 5px;">Send Invite</button>
            </div>`),n&&(s+=`<div class="clan-section">
                <div class="clan-section-title">Admin Tools</div>
                <button class="modal-btn modal-btn-cancel" id="clan-admin-invites-btn">View All Invites</button>
                <button class="modal-btn modal-btn-cancel" id="clan-admin-clans-btn" style="margin-left: 5px;">View All Clans</button>
            </div>`),e.setContent(s);let o=[{text:"Close",type:"cancel",id:"close",onClick:d=>d.close()}];t.isOwner?o.unshift({text:"Disband Clan",type:"cancel",id:"disband",onClick:async d=>{if(confirm("Are you sure you want to disband this clan?")){d.setButtonLoading("disband",!0,"Disbanding...");try{let b=await(await i.api.makeRequest("/api/clans/disband",{method:"POST",headers:{"Content-Type":"application/json"}})).json();b.success?(d.close(),i.ui.showClanModal()):(alert(b.error||"Failed to disband clan"),d.setButtonLoading("disband",!1))}catch(u){alert("Failed to disband clan: "+u.message),d.setButtonLoading("disband",!1)}}}}):o.unshift({text:"Leave Clan",type:"cancel",id:"leave",onClick:async d=>{if(confirm("Are you sure you want to leave this clan?")){d.setButtonLoading("leave",!0,"Leaving...");try{let b=await(await i.api.makeRequest("/api/clans/leave",{method:"POST",headers:{"Content-Type":"application/json"}})).json();b.success?(d.close(),i.ui.showClanModal()):(alert(b.error||"Failed to leave clan"),d.setButtonLoading("leave",!1))}catch(u){alert("Failed to leave clan: "+u.message),d.setButtonLoading("leave",!1)}}}}),e.buttons=o;let r=e.element.querySelector(".modal-actions");r.innerHTML="",e._buttonElements.clear();for(let d of e.buttons)r.appendChild(e._createButton(d));e.element.querySelectorAll(".clan-member-kick").forEach(d=>{d.addEventListener("click",async()=>{let u=d.dataset.domain;if(confirm(`Are you sure you want to kick ${u}?`)){d.disabled=!0,d.textContent="...";try{let T=await(await i.api.makeRequest("/api/clans/kick",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:u})})).json();T.success?(i.ui.showClanModal(),e.close()):(alert(T.error||"Failed to kick member"),d.disabled=!1,d.textContent="Kick")}catch(b){alert("Failed to kick member: "+b.message),d.disabled=!1,d.textContent="Kick"}}})}),e.element.querySelectorAll(".clan-pending-cancel").forEach(d=>{d.addEventListener("click",async()=>{let u=d.dataset.invite;d.disabled=!0,d.textContent="...";try{let T=await(await i.api.makeRequest("/api/clans/cancel-invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({invite:parseInt(u)})})).json();T.success?d.closest(".clan-pending-item").remove():(alert(T.error||"Failed to cancel invite"),d.disabled=!1,d.textContent="Cancel")}catch(b){alert("Failed to cancel invite: "+b.message),d.disabled=!1,d.textContent="Cancel"}})});let c=e.element.querySelector("#clan-invite-btn"),p=e.element.querySelector("#clan-invite-domain");c&&p&&c.addEventListener("click",async()=>{let d=p.value.trim();if(!d){alert("Please enter a domain");return}c.disabled=!0,c.textContent="Sending...";try{let b=await(await i.api.makeRequest("/api/clans/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:d})})).json();b.success?(p.value="",i.ui.showClanModal(),e.close()):(alert(b.error||"Failed to send invite"),c.disabled=!1,c.textContent="Send Invite")}catch(u){alert("Failed to send invite: "+u.message),c.disabled=!1,c.textContent="Send Invite"}});let g=e.element.querySelector("#clan-admin-invites-btn");g&&g.addEventListener("click",()=>{e.close(),setTimeout(()=>i.ui.showAdminInvitesModal(),50)});let v=e.element.querySelector("#clan-admin-clans-btn");v&&v.addEventListener("click",()=>{e.close(),setTimeout(()=>i.ui.showAdminClansModal(),50)})},renderNoClan:(e,t,n)=>{let s="";if(t.length>0){s+=`<div class="clan-section">
                <div class="clan-section-title">Pending Invites</div>
                <div class="clan-invites-list">`;for(let g of t)s+=`<div class="clan-invite-item">
                    <span class="clan-invite-info">
                        Clan: <strong>${i.ui.escapeHTML(g.clan_name)}</strong>
                        ${g.inviter_domain?`<br><span style="font-size: 11px; color: #888;">Invited by: ${i.ui.escapeHTML(g.inviter_domain)}</span>`:""}
                    </span>
                    <div class="clan-invite-actions">
                        <button class="clan-invite-accept" data-invite="${g.id}">Accept</button>
                        <button class="clan-invite-reject" data-invite="${g.id}">Reject</button>
                    </div>
                </div>`;s+="</div></div>"}s+=`<div class="clan-section">
            <div class="clan-section-title">Create a New Clan</div>
            <p style="font-size: 12px; color: #666; margin: 5px 0;">Create a clan to group neighboring tiles together (max 5 tiles).</p>
            <div class="code-input-container" style="margin: 5px 0;">
                <input type="text" id="clan-create-name" class="modal-input" placeholder="Clan name (3-20 chars, alphanumeric)" autocomplete="off" style="font-family: inherit;" maxlength="20" />
            </div>
            <button class="modal-btn modal-btn-confirm" id="clan-create-btn" style="margin-top: 5px;">Create Clan</button>
        </div>`,n&&(s+=`<div class="clan-section">
                <div class="clan-section-title">Admin: Manage Invites</div>
                <button class="modal-btn modal-btn-cancel" id="clan-admin-invites-btn">View All Invites</button>
                <button class="modal-btn modal-btn-cancel" id="clan-admin-clans-btn" style="margin-left: 5px;">View All Clans</button>
            </div>`),e.setContent(s),e.element.querySelectorAll(".clan-invite-accept").forEach(g=>{g.addEventListener("click",async()=>{let v=g.dataset.invite;g.disabled=!0,g.textContent="...";try{let u=await(await i.api.makeRequest("/api/clans/accept-invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({invite:parseInt(v)})})).json();u.success?(i.ui.pendingClanInvites=i.ui.pendingClanInvites.filter(b=>b.id!==parseInt(v)),i.ui.updateClanIndicator(),i.ui.showClanModal(),e.close()):(alert(u.error||"Failed to accept invite"),g.disabled=!1,g.textContent="Accept")}catch(d){alert("Failed to accept invite: "+d.message),g.disabled=!1,g.textContent="Accept"}})}),e.element.querySelectorAll(".clan-invite-reject").forEach(g=>{g.addEventListener("click",async()=>{let v=g.dataset.invite;g.disabled=!0,g.textContent="...";try{let u=await(await i.api.makeRequest("/api/clans/reject-invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({invite:parseInt(v)})})).json();u.success?(i.ui.pendingClanInvites=i.ui.pendingClanInvites.filter(b=>b.id!==parseInt(v)),i.ui.updateClanIndicator(),g.closest(".clan-invite-item").remove()):(alert(u.error||"Failed to reject invite"),g.disabled=!1,g.textContent="Reject")}catch(d){alert("Failed to reject invite: "+d.message),g.disabled=!1,g.textContent="Reject"}})});let o=e.element.querySelector("#clan-create-btn"),r=e.element.querySelector("#clan-create-name");o&&r&&o.addEventListener("click",async()=>{let g=r.value.trim();if(!g){alert("Please enter a clan name");return}if(g.length<3||g.length>20){alert("Clan name must be between 3 and 20 characters");return}if(!/^[a-zA-Z0-9\s]+$/.test(g)){alert("Clan name must only contain letters and numbers");return}o.disabled=!0,o.textContent="Creating...";try{let d=await(await i.api.makeRequest("/api/clans/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:g})})).json();d.success?(i.ui.showClanModal(),e.close()):(alert(d.error||"Failed to create clan"),o.disabled=!1,o.textContent="Create Clan")}catch(v){alert("Failed to create clan: "+v.message),o.disabled=!1,o.textContent="Create Clan"}});let c=e.element.querySelector("#clan-admin-invites-btn");c&&c.addEventListener("click",()=>{e.close(),setTimeout(()=>i.ui.showAdminInvitesModal(),50)});let p=e.element.querySelector("#clan-admin-clans-btn");p&&p.addEventListener("click",()=>{e.close(),setTimeout(()=>i.ui.showAdminClansModal(),50)})},showAdminInvitesModal:async()=>{let e=new R({title:"Admin: All Clan Invites",content:"<p>Loading...</p>",buttons:[{text:"Back",type:"cancel",id:"back",onClick:t=>{t.close(),i.ui.showClanModal()}},{text:"Close",type:"cancel",id:"close",onClick:t=>t.close()}]});e.open();try{let n=await(await i.api.makeRequest("/api/clans/admin/invites")).json();if(n.success)if(n.invites.length===0)e.setContent("<p>No pending invites.</p>");else{let s='<div class="clan-invites-list" style="max-height: 300px;">';for(let o of n.invites)s+=`<div class="clan-invite-item">
                            <div>
                                <div><strong>${i.ui.escapeHTML(o.domain)}</strong></div>
                                <div style="font-size: 11px; color: #888;">Clan: ${i.ui.escapeHTML(o.clan_name)}</div>
                            </div>
                            <button class="clan-invite-reject" data-invite="${o.id}">Delete</button>
                        </div>`;s+="</div>",e.setContent(s),e.element.querySelectorAll(".clan-invite-reject").forEach(o=>{o.addEventListener("click",async()=>{let r=o.dataset.invite;o.disabled=!0,o.textContent="...";try{let p=await(await i.api.makeRequest("/api/clans/admin/delete-invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({invite:parseInt(r)})})).json();p.success?o.closest(".clan-invite-item").remove():(alert(p.error||"Failed to delete invite"),o.disabled=!1,o.textContent="Delete")}catch(c){alert("Failed to delete invite: "+c.message),o.disabled=!1,o.textContent="Delete"}})})}else e.setContent("<p>Failed to load invites: "+i.ui.escapeHTML(n.error)+"</p>")}catch(t){e.setContent("<p>Failed to load invites: "+i.ui.escapeHTML(t.message)+"</p>")}},showAdminClansModal:async()=>{let e=new R({title:"Admin: All Clans",content:"<p>Loading...</p>",buttons:[{text:"Back",type:"cancel",id:"back",onClick:t=>{t.close(),i.ui.showClanModal()}},{text:"Close",type:"cancel",id:"close",onClick:t=>t.close()}]});e.open();try{let n=await(await i.api.makeRequest("/api/clans/admin/clans")).json();if(n.success)if(n.clans.length===0)e.setContent("<p>No clans.</p>");else{let s='<div class="clan-members-list" style="max-height: 300px;">';for(let o of n.clans)s+=`<div class="clan-member-item">
                            <div>
                                <div><strong>${i.ui.escapeHTML(o.name)}</strong></div>
                                <div style="font-size: 11px; color: #888;">${o.member_count}/5 members</div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                ${o.owner_x!==null&&o.owner_y!==null?`<button class="clan-jump-owner" data-x="${o.owner_x}" data-y="${o.owner_y}">Jump</button>`:""}
                                <button class="clan-member-kick" data-clan="${o.id}">Disband</button>
                            </div>
                        </div>`;s+="</div>",e.setContent(s),e.element.querySelectorAll(".clan-jump-owner").forEach(o=>{o.addEventListener("click",()=>{let r=parseInt(o.dataset.x),c=parseInt(o.dataset.y);i.camera&&!isNaN(r)&&!isNaN(c)&&(i.camera.centerOn(r*250+250/2,c*250+250/2),e.close())})}),e.element.querySelectorAll(".clan-member-kick").forEach(o=>{o.addEventListener("click",async()=>{let r=o.dataset.clan;if(confirm("Are you sure you want to disband this clan?")){o.disabled=!0,o.textContent="...";try{let p=await(await i.api.makeRequest("/api/clans/admin/disband",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clan_id:parseInt(r)})})).json();p.success?o.closest(".clan-member-item").remove():(alert(p.error||"Failed to disband clan"),o.disabled=!1,o.textContent="Disband")}catch(c){alert("Failed to disband clan: "+c.message),o.disabled=!1,o.textContent="Disband"}}})})}else e.setContent("<p>Failed to load clans: "+i.ui.escapeHTML(n.error)+"</p>")}catch(t){e.setContent("<p>Failed to load clans: "+i.ui.escapeHTML(t.message)+"</p>")}},showFreeModal:e=>{if(!i.user){location.href="https://kicya.net/auth/login?redirect="+encodeURIComponent("https://webtiles.kicya.net/");return}let t=new R({title:"Free Tile",content:`
                <p>What would you like to do with the tile at (${e.x}, ${e.y})?</p>
                <div class="modal-options">
                    <button class="modal-option" id="option-transfer">
                        <strong>Transfer to Someone</strong>
                        <span>Get a code to share with another person. They can use this code to take the tile.</span>
                    </button>
                    <button class="modal-option" id="option-free">
                        <strong>Free Completely</strong>
                        <span>Make this tile available for anyone to claim.</span>
                    </button>
                </div>
            `,buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:o=>o.close()}]});t.open();let n=t.element.querySelector("#option-transfer"),s=t.element.querySelector("#option-free");n.addEventListener("click",async()=>{n.disabled=!0,s.disabled=!0,n.innerHTML="<strong>Loading...</strong>";try{let r=await(await i.api.makeRequest("/api/getcode",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y})})).json();if(r.success){t.setContent(`
                        <p>Share this code with another person to let them take your tile at (${e.x}, ${e.y}):</p>
                        <div class="code-display">
                            <code id="tile-code">${i.ui.escapeHTML(r.code)}</code>
                            <button class="btn" id="copy-code-btn">Copy</button>
                        </div>
                        <p class="modal-hint">The other person needs to select the tile and click "Take", then enter this code.</p>
                    `);let c=t.element.querySelector("#copy-code-btn");c.addEventListener("click",()=>{navigator.clipboard.writeText(r.code),c.textContent="Copied!",setTimeout(()=>{c.textContent="Copy"},1500)})}else alert(r.error||"Failed to get tile code"),n.disabled=!1,s.disabled=!1,n.innerHTML="<strong>\u{1F511} Transfer to Someone</strong><span>Get a code to share with another person. They can use this code to take the tile.</span>"}catch(o){console.error(o),alert("Failed to get tile code: "+o.message),n.disabled=!1,s.disabled=!1,n.innerHTML="<strong>\u{1F511} Transfer to Someone</strong><span>Get a code to share with another person. They can use this code to take the tile.</span>"}}),s.addEventListener("click",()=>{t.setContent(`<p>Are you sure you want to free the tile at (${e.x}, ${e.y})?</p><p>The tile for <strong>${i.ui.escapeHTML(e.domain)}</strong> will become available for <strong>anyone</strong> to claim.</p>`),t.buttons=[{text:"Back",type:"cancel",id:"back",onClick:r=>{r.close(),i.ui.showFreeModal(e)}},{text:"Free Tile",type:"confirm",id:"confirm",onClick:async r=>{r.setButtonLoading("confirm",!0,"Freeing...");try{let p=await(await i.api.makeRequest("/api/free",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y})})).json();if(p.success){let g=i.user.sites.find(v=>v.domain===e.domain);g&&(g.tile=null),e.setFree(),e.setActive(!1),r.close(),Q()}else alert(p.error||"Failed to free tile"),r.setButtonLoading("confirm",!1)}catch(c){console.error(c),alert("Failed to free tile: "+c.message),r.setButtonLoading("confirm",!1)}}}];let o=t.element.querySelector(".modal-actions");o.innerHTML="",t._buttonElements.clear();for(let r of t.buttons)o.appendChild(t._createButton(r))})},showTakeModal:e=>{if(!i.user){location.href="https://kicya.net/auth/login?redirect="+encodeURIComponent("https://webtiles.kicya.net/");return}let t=i.user.selectedSite;if(!t){alert("Please select a site first");return}let n=t.domain,s=t.tile?`<strong>Warning</strong>Your current tile at (${t.tile.x}, ${t.tile.y}) will be freed and your site will be moved to this new tile.`:null,o=new R({title:"Take Tile",content:`
                <p>Enter the code to take the tile at (${e.x}, ${e.y}) for <strong>${i.ui.escapeHTML(n)}</strong>:</p>
                <div class="code-input-container">
                    <input type="text" id="take-code-input" class="modal-input" placeholder="Enter tile code..." autocomplete="off" />
                </div>
            `,warning:s,buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:r=>r.close()},{text:"Take Tile",type:"confirm",id:"confirm",onClick:async r=>{let p=o.element.querySelector("#take-code-input").value.trim();if(!p){alert("Please enter a code");return}r.setButtonLoading("confirm",!0,"Taking...");try{let v=await(await i.api.makeRequest("/api/take",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y,code:p})})).json();if(v.success){if(i.user.selectedSite&&i.user.selectedSite.tile){let d=i.plot.getTile(i.user.selectedSite.tile.x,i.user.selectedSite.tile.y);d&&d.setFree()}i.user.selectedSite&&(i.user.selectedSite.tile={x:e.x,y:e.y,domain:i.user.selectedSite.domain,created_at:Date.now()}),e.setDomain(n),e.setActive(!1),r.close(),Q()}else alert(v.error||"Failed to take tile"),r.setButtonLoading("confirm",!1)}catch(g){console.error(g),alert("Failed to take tile: "+g.message),r.setButtonLoading("confirm",!1)}}}]});o.open(),setTimeout(()=>{let r=o.element.querySelector("#take-code-input");r&&r.focus()},100)},showAdminFreeModal:e=>{new R({title:"Admin: Free Tile",content:`
                <p>Are you sure you want to <strong>free</strong> the tile at (${e.x}, ${e.y})?</p>
                <p>This will remove <strong>${i.ui.escapeHTML(e.domain)}</strong> from this tile.</p>
            `,buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:n=>n.close()},{text:"Free Tile",type:"confirm",id:"confirm",onClick:async n=>{n.setButtonLoading("confirm",!0,"Freeing...");try{let o=await(await i.api.makeRequest("/api/admin/free",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y})})).json();o.success?(e.setFree(),e.setActive(!1),n.close()):(alert(o.error||"Failed to free tile"),n.setButtonLoading("confirm",!1))}catch(s){console.error(s),alert("Failed to free tile: "+s.message),n.setButtonLoading("confirm",!1)}}}]}).open()},showAdminBanModal:e=>{new R({title:"Admin: Ban User",content:`
                <p>Are you sure you want to <strong>ban</strong> the owner of <strong>${i.ui.escapeHTML(e.domain)}</strong>?</p>
                <p>This will:</p>
                <ul style="margin: 10px 0; padding-left: 20px; color: #555;">
                    <li>Ban the user from creating new tiles</li>
                    <li>Remove <strong>all</strong> of their tiles</li>
                </ul>
            `,warning:"<strong>Destructive Action</strong>This action cannot be undone easily!",buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:n=>n.close()},{text:"Ban User",type:"confirm",id:"confirm",onClick:async n=>{n.setButtonLoading("confirm",!0,"Banning...");try{let o=await(await i.api.makeRequest("/api/admin/ban",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y})})).json();o.success?(e.setFree(),e.setActive(!1),n.close(),alert("User banned.")):(alert(o.error||"Failed to ban user"),n.setButtonLoading("confirm",!1))}catch(s){console.error(s),alert("Failed to ban user: "+s.message),n.setButtonLoading("confirm",!1)}}}]}).open()},showAdminLockModal:(e,t)=>{let n=t?"unlock":"lock",s=t?"unlocked":"locked";new R({title:`Admin: ${t?"Unlock":"Lock"} Tile`,content:`
                <p>Are you sure you want to <strong>${n}</strong> the tile at (${e.x}, ${e.y})?</p>
                ${t?"<p>This tile will become available for claiming again.</p>":"<p>This tile will be reserved and cannot be claimed by regular users.</p>"}
            `,buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:r=>r.close()},{text:t?"Unlock Tile":"Lock Tile",type:"confirm",id:"confirm",onClick:async r=>{r.setButtonLoading("confirm",!0,t?"Unlocking...":"Locking...");try{let p=await(await i.api.makeRequest("/api/admin/lock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y,lock:!t})})).json();p.success?(t?delete i.plot.lockCache[e.x+","+e.y]:i.plot.lockCache[e.x+","+e.y]=!0,r.close(),e.setActive(!1),e.setActive(!0)):(alert(p.error||`Failed to ${n} tile`),r.setButtonLoading("confirm",!1))}catch(c){console.error(c),alert(`Failed to ${n} tile: `+c.message),r.setButtonLoading("confirm",!1)}}}]}).open()},showAdminLockCodeModal:async e=>{try{let n=await(await i.api.makeRequest(`/api/admin/lockcode?x=${e.x}&y=${e.y}`)).json();if(n.success){let s=new R({title:"Lock Code",content:`
                        <p>Lock code for tile at (${e.x}, ${e.y}):</p>
                        <div class="code-display">
                            <code id="lock-code">${i.ui.escapeHTML(n.code)}</code>
                            <button class="btn" id="copy-lock-code-btn">Copy</button>
                        </div>
                        <p class="modal-hint">Share this code to allow someone to claim this locked tile.</p>
                    `,buttons:[{text:"Close",type:"cancel",id:"close",onClick:r=>r.close()}]});s.open();let o=s.element.querySelector("#copy-lock-code-btn");o.addEventListener("click",()=>{navigator.clipboard.writeText(n.code),o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy"},1500)})}else alert(n.error||"Failed to get lock code")}catch(t){console.error(t),alert("Failed to get lock code: "+t.message)}},showAdminTileCodeModal:async e=>{try{let n=await(await i.api.makeRequest(`/api/admin/tilecode?x=${e.x}&y=${e.y}`)).json();if(n.success){let s=new R({title:"Tile Secret Code",content:`
                        <p>Secret code for tile at (${e.x}, ${e.y}):</p>
                        <div class="code-display">
                            <code id="tile-code">${i.ui.escapeHTML(n.code)}</code>
                            <button class="btn" id="copy-tile-code-btn">Copy</button>
                        </div>
                        <p class="modal-hint">This is the secret code for this tile. Share it to allow someone to take this tile.</p>
                    `,buttons:[{text:"Close",type:"cancel",id:"close",onClick:r=>r.close()}]});s.open();let o=s.element.querySelector("#copy-tile-code-btn");o.addEventListener("click",()=>{navigator.clipboard.writeText(n.code),o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy"},1500)})}else alert(n.error||"Failed to get tile code")}catch(t){console.error(t),alert("Failed to get tile code: "+t.message)}},showAdminSwapModal:e=>{let t=new R({title:"Admin: Swap Tiles",content:`
                <p>Enter the coordinates of the tile to swap with tile at (${e.x}, ${e.y}):</p>
                <div class="code-input-container">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #555;">X coordinate:</label>
                    <input type="number" id="swap-x-input" class="modal-input" placeholder="Enter X..." autocomplete="off" />
                </div>
                <div class="code-input-container">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #555;">Y coordinate:</label>
                    <input type="number" id="swap-y-input" class="modal-input" placeholder="Enter Y..." autocomplete="off" />
                </div>
            `,buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:n=>n.close()},{text:"Swap",type:"confirm",id:"confirm",onClick:async n=>{let s=t.element.querySelector("#swap-x-input"),o=t.element.querySelector("#swap-y-input"),r=parseInt(s.value.trim()),c=parseInt(o.value.trim());if(isNaN(r)||isNaN(c)){alert("Please enter valid X and Y coordinates");return}if(e.x===r&&e.y===c){alert("Cannot swap a tile with itself");return}n.setButtonLoading("confirm",!0,"Swapping...");try{let g=await(await i.api.makeRequest("/api/admin/swap",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x1:e.x,y1:e.y,x2:r,y2:c})})).json();g.success?(n.close(),e.setActive(!1),setTimeout(()=>{let v=i.plot.getTile(e.x,e.y),d=i.plot.getTile(r,c);v&&(v.setActive(!1),v.fetchContent("/index.html",!0)),d&&(d.setActive(!1),d.fetchContent("/index.html",!0))},100)):(alert(g.error||"Failed to swap tiles"),n.setButtonLoading("confirm",!1))}catch(p){console.error(p),alert("Failed to swap tiles: "+p.message),n.setButtonLoading("confirm",!1)}}}]});t.open(),setTimeout(()=>{let n=t.element.querySelector("#swap-x-input");n&&n.focus()},100)},createAdminControl:e=>{let t=i.ui.createElement("div",{class:"tile-admin-panel"});e.free||(t.appendChild(i.ui.createElement("button",{innerText:"Edit",onclick:()=>{i.ui.showDashboard(e.domain)}})),t.appendChild(i.ui.createElement("span",{class:"separator"})),t.appendChild(i.ui.createElement("button",{innerText:"Free",onclick:()=>{i.ui.showAdminFreeModal(e)}})),t.appendChild(i.ui.createElement("button",{class:"danger",innerText:"Ban",onclick:()=>{i.ui.showAdminBanModal(e)}})),t.appendChild(i.ui.createElement("button",{innerText:"Swap",onclick:()=>{i.ui.showAdminSwapModal(e)}})));let n=i.plot.lockCache[e.x+","+e.y],s=i.ui.createElement("button",{innerText:n?"Unlock":"Lock",onclick:async()=>{try{let r=await(await i.api.makeRequest(`/api/admin/lockstatus?x=${e.x}&y=${e.y}`)).json();r.success?i.ui.showAdminLockModal(e,r.locked):alert(r.error||"Failed to check lock status")}catch(o){console.error(o),alert("Failed to check lock status: "+o.message)}}});if(e.free||t.appendChild(i.ui.createElement("span",{class:"separator"})),t.appendChild(s),n){let o=i.ui.createElement("button",{innerText:"Show",onclick:()=>{i.ui.showAdminLockCodeModal(e)}});t.appendChild(o)}if(!e.free){let o=i.ui.createElement("button",{innerText:"Show",onclick:()=>{i.ui.showAdminTileCodeModal(e)}});t.appendChild(o)}return t},createTileControl:e=>{let t=i.ui.createElement("div",{class:"tile-info",innerHTML:`
                <div class="tile-domain">
                    ${e.domain?`<a href="https://${i.ui.escapeHTML(e.domain)}" target="_blank">${i.ui.escapeHTML(e.domain)}</a>`:`${e.locked?"Locked tile":"Free tile"} ${e.x}, ${e.y}`}
                </div>
                <div class="tile-controls">
            `}),n=t.querySelector(".tile-controls");if(e.free)i.plot.lockCache[e.x+","+e.y]?n.appendChild(i.ui.createElement("button",{class:"btn",innerText:"Unlock",onclick:()=>{i.ui.showUnlockModal(e)}})):n.appendChild(i.ui.createElement("button",{class:"btn",innerText:"Claim",onclick:()=>{i.ui.showClaimModal(e)}}));else{let s=i?.user?.sites?.find(o=>o.domain===e.domain);if(s&&(n.appendChild(i.ui.createElement("button",{class:"btn",innerText:"Edit",onclick:()=>{i.ui.showDashboard(e.domain)}})),n.appendChild(i.ui.createElement("button",{class:"btn",innerText:"Give",onclick:()=>{i.ui.showFreeModal(e)}}))),(!s||i?.user?.selectedSite?.domain!==e.domain&&i?.user?.sites?.length>=2)&&n.appendChild(i.ui.createElement("button",{class:"btn",innerText:"Take",onclick:()=>{i.ui.showTakeModal(e)}})),!s&&i?.user?.selectedSite?.tile){let o=i.user.selectedSite.tile;Math.abs(o.x-e.x)<=1&&Math.abs(o.y-e.y)<=1&&i.ui.checkAndShowAttackButton(e,n)}}return n.appendChild(i.ui.createElement("button",{class:"btn",innerHTML:"Link",onclick:s=>{s.target.innerText="Copied!",setTimeout(()=>{s.target.innerText="Link"},500),navigator.clipboard.writeText(`https://webtiles.kicya.net/#${e.domain}`)}})),n.appendChild(i.ui.createElement("button",{class:"btn",innerHTML:"\u27F3",onclick:()=>{e.fetchContent(e.path,!0),e.setActive(!1)}})),n.appendChild(i.ui.createElement("button",{class:"btn",innerHTML:"&times;",onclick:()=>{e.setActive(!1)}})),t.appendChild(n),t},createVoteMenu:e=>{if(e.free||!e.domain)return null;let t=i.ui.createElement("div",{class:"tile-vote-menu"}),n=i.ui.createElement("button",{class:"vote-btn vote-up",innerHTML:"\u25B2",onclick:()=>i.ui.handleVote(e,1,n,o,s)}),s=i.ui.createElement("div",{class:"vote-score",innerText:"..."}),o=i.ui.createElement("button",{class:"vote-btn vote-down",innerHTML:"\u25BC",onclick:()=>i.ui.handleVote(e,-1,n,o,s)});return t.appendChild(n),t.appendChild(s),t.appendChild(o),i.ui.fetchVoteData(e,n,o,s),t},fetchVoteData:async(e,t,n,s)=>{try{let r=await(await i.api.makeRequest(`/api/votes/score?domain=${encodeURIComponent(e.domain)}`)).json();if(r.success){let c=r.score||0;s.textContent=c;let p=r.myVote||0;t.classList.remove("active"),n.classList.remove("active"),p===1?t.classList.add("active"):p===-1&&n.classList.add("active")}else s.textContent="0"}catch(o){console.error("Failed to fetch vote score:",o),s.textContent="0"}},handleVote:async(e,t,n,s,o)=>{if(!i.user){location.href="https://kicya.net/auth/login?redirect="+encodeURIComponent("https://webtiles.kicya.net/");return}let r=n.classList.contains("active"),c=s.classList.contains("active"),p=t;(t===1&&r||t===-1&&c)&&(p=0),n.disabled=!0,s.disabled=!0;try{let v=await(await i.api.makeRequest("/api/votes/vote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:e.domain,vote:p})})).json();if(v.success){let d=v.score||0;o.textContent=d,n.classList.remove("active"),s.classList.remove("active"),p===1?n.classList.add("active"):p===-1&&s.classList.add("active")}else alert(v.error||"Failed to vote")}catch(g){console.error("Failed to vote:",g),alert("Failed to vote: "+g.message)}finally{n.disabled=!1,s.disabled=!1}},checkAndShowAttackButton:async(e,t)=>{try{let s=await(await i.api.makeRequest(`/api/clans/tile-clan?domain=${encodeURIComponent(e.domain)}`)).json();if(s.success&&s.clan&&s.clan.members&&s.clan.members.length>=3)return;t.prepend(i.ui.createElement("button",{class:"btn",innerText:"Attack",onclick:()=>{i.ui.showAttackModal(e)}}))}catch(n){console.error("Failed to check clan for attack button:",n),t.prepend(i.ui.createElement("button",{class:"btn",innerText:"Attack",onclick:()=>{i.ui.showAttackModal(e)}}))}},showAttackModal:async e=>{if(!i.user){location.href="https://kicya.net/auth/login?redirect="+encodeURIComponent("https://webtiles.kicya.net/");return}if(!i.user.selectedSite){alert("Please select a site first");return}if(!i.user.selectedSite.tile){alert("You must have a tile to attack from");return}let n=i.user.selectedSite.domain,s=e.domain,o=0,r=null,c=null;try{let d=await(await i.api.makeRequest(`/api/attack/success-chance?attacked_domain=${encodeURIComponent(s)}`)).json();d.success?(o=d.successChance,r=d.cooldown):c=d.error||"Failed to get attack success chance"}catch(v){console.error(v),c="Failed to get attack success chance: "+v.message}if(c){alert(c);return}if(o<1){alert("Attack chance is too low to attempt an attack. If you just attacked, wait a few hours before attacking again.");return}let p="";if(r&&r.isOnCooldown){let v=r.hoursRemaining;p=`
                <p style="margin: 15px 0; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; color: #856404;">
                    <strong>Warning:</strong> Your attack chance is penalized because less than 12 hours have passed since your last attack. 
                    ${v>1?`Approximately ${v} hours remaining until full chance.`:"Less than 1 hour remaining until full chance."}
                </p>
            `}new R({title:"Attack Tile",content:`
                <p>
                    Attack the tile at (${e.x}, ${e.y}) owned by <strong>${i.ui.escapeHTML(s)}</strong>?<br>
                    Attack success chance: ${o.toFixed(1)}%
                </p>
                ${p}
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    If successful, your tile and the attacked tile will swap positions.
                </p>
            `,buttons:[{text:"Cancel",type:"cancel",id:"cancel",onClick:v=>v.close()},{text:"Attack",type:"confirm",id:"confirm",onClick:async v=>{v.setButtonLoading("confirm",!0,"Attacking...");try{let u=await(await i.api.makeRequest("/api/attack/perform",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e.x,y:e.y})})).json();if(u.success){v.setContent(`
                                    <p style="color: #4caf50; font-weight: bold; text-align: center; padding: 0px;">
                                        \u2713 Attack Successful!
                                    </p>
                                    <p style="text-align: center;">
                                        Your tile and the attacked tile have been swapped.
                                    </p>
                                `),setTimeout(()=>{let T=i.plot.getTile(i.user.selectedSite.tile.x,i.user.selectedSite.tile.y);T&&(T.fetchContent("/index.html",!0),T.setActive(!1)),e.fetchContent("/index.html",!0),e.setActive(!1),i.user.selectedSite&&(i.user.selectedSite.tile={x:e.x,y:e.y,domain:n,created_at:Date.now()})},500),v.buttons=[{text:"Close",type:"cancel",id:"close",onClick:T=>T.close()}];let b=v.element.querySelector(".modal-actions");b.innerHTML="",v._buttonElements.clear();for(let T of v.buttons)b.appendChild(v._createButton(T))}else{v.setContent(`
                                    <p style="color: #f44336; font-weight: bold; text-align: center; padding: 0px;">
                                        \u2717 Attack Failed
                                    </p>
                                    <p style="text-align: center;">
                                        ${i.ui.escapeHTML(u.error||"The attack was unsuccessful.")}
                                    </p>
                                `),v.buttons=[{text:"Close",type:"cancel",id:"close",onClick:T=>T.close()}];let b=v.element.querySelector(".modal-actions");b.innerHTML="",v._buttonElements.clear();for(let T of v.buttons)b.appendChild(v._createButton(T))}}catch(d){console.error(d),alert("Failed to attack tile: "+d.message),v.setButtonLoading("confirm",!1)}}}]}).open()},showEmbedModal:()=>{if(!i.user){location.href="https://kicya.net/auth/login?redirect="+encodeURIComponent("https://webtiles.kicya.net/");return}if(!i.user.selectedSite){alert("Please select a site first");return}if(!i.user.selectedSite.tile){alert("Your site must have a tile to embed it");return}let e=i.user.selectedSite.domain,t=!1,n=k=>{let I=`/e/${e}`;return k?`${I}?dark=true`:I},s=k=>`<iframe src="https://webtiles.kicya.net${n(k)}" width="250" height="270" frameborder="0"></iframe>`,o=document.createElement("div");o.style.cssText="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;";let r=document.createElement("div");r.style.cssText="min-width: 250px; max-width: 100%;";let c=document.createElement("h4");c.textContent="Preview",c.style.cssText="margin: 0 0 10px 0; font-size: 14px;",r.appendChild(c);let p=document.createElement("iframe");p.src=n(t),p.width="250",p.height="270",p.style.cssText="border: 1px solid #ddd; border-radius: 4px;",p.setAttribute("frameborder","0"),r.appendChild(p);let g=document.createElement("div");g.style.cssText="flex: 1; min-width: 300px; max-width: 100%;";let v=document.createElement("h4");v.textContent="Embed Code",v.style.cssText="margin: 0 0 10px 0; font-size: 14px;",g.appendChild(v);let d=document.createElement("div");d.style.cssText="margin-bottom: 10px; display: flex; align-items: center; gap: 3px;";let u=document.createElement("input");u.type="checkbox",u.id="embed-dark-mode",u.style.cssText="cursor: pointer;";let b=document.createElement("label");b.setAttribute("for","embed-dark-mode"),b.textContent="Dark mode",b.style.cssText="cursor: pointer; font-size: 13px; user-select: none;",d.appendChild(u),d.appendChild(b),r.appendChild(d);let T=document.createElement("textarea");T.value=s(t),T.style.cssText="width: 100%; height: 80px; padding: 8px; font-family: monospace; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; box-sizing: border-box;",T.readOnly=!0,g.appendChild(T);let C=document.createElement("button");C.textContent="Copy Code",C.style.cssText="margin-top: 10px; padding: 6px 12px; background-color: var(--main-color, #d85252); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;",C.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(T.value),C.textContent="Copied!",setTimeout(()=>{C.textContent="Copy Code"},2e3)}catch{T.select(),document.execCommand("copy"),C.textContent="Copied!",setTimeout(()=>{C.textContent="Copy Code"},2e3)}}),g.appendChild(C);let f=document.createElement("div");f.style.cssText="font-size: 12px; color: #666; margin-top: 10px;",f.innerHTML="You can detect if your tile is embedded in JS by checking the <b>embedded</b> variable. For CSS, body has an <b>embedded</b> class.",g.appendChild(f),u.addEventListener("change",k=>{t=k.target.checked,p.src=n(t),T.value=s(t)}),o.appendChild(r),o.appendChild(g);let w=new R({title:"Embed Tile",content:o,buttons:[{text:"Close",type:"cancel",id:"close",onClick:k=>k.close()}]});w.open(),w.element&&(w.element.style.maxWidth="700px")}};function Q(){if(!i.user)return;let e=i.ui.siteSelector.value,t=i.user.sites.find(s=>s.domain===e);e==="select"||e==="add"||!t?(i.ui.siteJumpButton.hidden=!0,i.ui.siteEditButton.hidden=!0,i.ui.siteEmbedButton.hidden=!0,i.ui.siteClanButton.hidden=!0):(i.ui.siteEditButton.hidden=!1,i.ui.siteJumpButton.hidden=!t.tile,i.ui.siteClanButton.hidden=!t.tile,i.ui.siteEmbedButton.hidden=!t.tile),i.user.selectedSite=t;let n=i?.plot?.activeTile;n&&(n.setActive(!1),n.setActive(!0))}i.ui.siteSelector&&i.ui.siteSelector.addEventListener("change",()=>{if(!i.user)return;let e=i.ui.siteSelector.value;e==="add"&&(location.href=i.user?"https://kicya.net/account/sites":"https://kicya.net/auth/register");let t=i.user.sites.find(n=>n.domain===e);if(t){document.cookie=`site=${t.domain}; path=/`;let n=document.querySelector("#kicya-site-select-option");n&&n.remove(),i.ui.fetchClanInvites()}Q()});Q();var Ve=document.getElementById("dashboard-modal"),Ye=document.getElementById("dashboard-iframe"),Ue=document.getElementById("dashboard-modal-close"),We=document.getElementById("dashboard-modal-title"),fe=document.getElementById("app");i.ui.siteEditButton&&i.ui.siteEditButton.addEventListener("click",()=>{!i.user||!i.user.selectedSite||i.ui.showDashboard(i.user.selectedSite.domain)});i.ui.siteJumpButton&&i.ui.siteJumpButton.addEventListener("click",()=>{if(!i.user||!i.user.selectedSite||!i.user.selectedSite.tile)return;let e=i.user.selectedSite.tile,t=e.x*250+250/2,n=e.y*250+250/2;i.camera.centerOn(t,n)});i.ui.siteCenterButton&&i.ui.siteCenterButton.addEventListener("click",()=>{i.camera&&i.camera.centerOn(100,100)});i.ui.siteClanButton&&i.ui.siteClanButton.addEventListener("click",()=>{i.ui.showClanModal()});i.ui.siteEmbedButton&&i.ui.siteEmbedButton.addEventListener("click",()=>{i.ui.showEmbedModal()});function mt(){Ve.classList.remove("active"),Ye.src="",fe&&(fe.style.display=""),i.camera&&i.camera.setZoomEnabled(!0)}Ue&&Ue.addEventListener("click",mt);i.ui.zoomSlider.addEventListener("input",e=>{i.camera.zoomTo(i.camera.width/2,i.camera.height/2,+e.target.value)});var we=document.getElementById("kicya-menu-toggle"),K=document.getElementById("kicya-links");we&&K&&(we.addEventListener("click",function(e){e.stopPropagation(),K.classList.toggle("active")}),document.addEventListener("click",function(e){!K.contains(e.target)&&!we.contains(e.target)&&K.classList.remove("active")}),K.querySelectorAll("a").forEach(function(e){e.addEventListener("click",function(){K.classList.remove("active")})}));function pt(){if(!i.user||localStorage.getItem("rules_accepted"))return;new R({title:"Rules",content:`
            <p>Please read and accept the following rules:</p>
            <ul style="margin: 10px 0; padding-left: 20px; color: #555;">
                <li><b>Absolutely no NSFW content allowed on tiles.</b></li>
                <li>No illegal content or copyright infringement.</li>
                <li>No harrassment, bullying, or trolling.</li>
                <li>Do not try to hack, DDOS, or otherwise attack the website or any other users.</li>
                <li>Do not create extremely eye-bleeding tiles that contain flashing lights, rapidly changing colors, or patterns that may trigger seizures in individuals with epilepsy.</li>
                <li>Do not create multiple tiles unless you legitimately have multiple real sites.</li>
            </ul>
        `,buttons:[{text:"OK",type:"confirm",id:"ok",onClick:t=>{localStorage.setItem("rules_accepted","1"),t.close()}}]}).open()}pt();i.user&&i.user.selectedSite&&i.ui.fetchClanInvites();var mn=i.ui;var be=class{constructor(){this.ws=null,this.reconnectTimeout=null,this.handlers=new Map,this.binaryHandlers=[],this.connected=!1,this.messageQueue=[],this.connectionAttempted=!1,this.consecutiveFailures=0,this.lastConnectionTime=0,this.waitForCaptchaAndConnect()}async waitForCaptchaAndConnect(){let t=i.api.getToken(),n=i.api.getTokenExpiry();if(!i.api.getTurnstileSiteKey()){this.connect();return}(!t||n<Date.now())&&await i.api.showCaptchaModal();let s=6e4,o=Date.now();for(;!i.api.getToken()||i.api.getTokenExpiry()<Date.now();){if(Date.now()-o>s){console.error("[WS] Captcha timeout");let r=document.getElementById("loading-text");r&&(r.textContent="Verification timeout. Please refresh.");return}await new Promise(r=>setTimeout(r,100))}this.connect()}connect(){let t=location.protocol==="https:"?"wss:":"ws:",n=i.api.getToken()||"";this.connectionAttempted=!0,this.lastConnectionTime=Date.now(),this.ws=new WebSocket(`${t}//${location.host}/ws?t=${encodeURIComponent(n)}`),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("[WS] Connected"),this.connected=!0,this.consecutiveFailures=0,this.emit("open");for(let s of this.messageQueue)this.ws.send(s);this.messageQueue=[]},this.ws.onmessage=s=>{if(s.data instanceof ArrayBuffer)for(let o of this.binaryHandlers)o(s.data);else try{let o=JSON.parse(s.data);this.emit(o.type,o)}catch(o){console.error("[WS] Failed to parse message:",o)}},this.ws.onclose=s=>{console.log("[WS] Disconnected, reconnecting...",s.code,s.reason);let o=this.connected;this.connected=!1,this.emit("close");let r=Date.now()-this.lastConnectionTime;!o&&r<1e3?this.consecutiveFailures++:this.consecutiveFailures=0,this.scheduleReconnect()},this.ws.onerror=s=>{console.error("[WS] Error:",s)}}scheduleReconnect(){if(this.reconnectTimeout)return;let t=Math.min(3e3*Math.pow(2,this.consecutiveFailures),3e4);this.reconnectTimeout=setTimeout(async()=>{this.reconnectTimeout=null;let n=i.api.getToken(),s=i.api.getTokenExpiry();(!n||s<Date.now())&&await i.api.showCaptchaModal();let o=3e4,r=Date.now();for(;!i.api.getToken()||i.api.getTokenExpiry()<Date.now();){if(Date.now()-r>o){console.error("[WS] Reconnect captcha timeout");return}await new Promise(c=>setTimeout(c,100))}this.connect()},t)}on(t,n){this.handlers.has(t)||this.handlers.set(t,[]),this.handlers.get(t).push(n)}off(t,n){if(!this.handlers.has(t))return;let s=this.handlers.get(t),o=s.indexOf(n);o!==-1&&s.splice(o,1)}onBinary(t){this.binaryHandlers.push(t)}emit(t,n){if(this.handlers.has(t))for(let s of this.handlers.get(t))s(n)}send(t){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(t):typeof t=="string"&&this.messageQueue.push(t)}sendJSON(t){this.send(JSON.stringify(t))}get isConnected(){return this.ws&&this.ws.readyState===WebSocket.OPEN}};i.ws=new be;var vn=i.ws;var gt=new Set(["aaa","aarp","abb","abbott","abbvie","abc","able","abogado","abudhabi","ac","academy","accenture","accountant","accountants","aco","actor","ad","ads","adult","ae","aeg","aero","aetna","af","afl","africa","ag","agakhan","agency","ai","aig","airbus","airforce","airtel","akdn","al","alibaba","alipay","allfinanz","allstate","ally","alsace","alstom","am","amazon","americanexpress","americanfamily","amex","amfam","amica","amsterdam","analytics","android","anquan","anz","ao","aol","apartments","app","apple","aq","aquarelle","ar","arab","aramco","archi","army","arpa","art","arte","as","asda","asia","associates","at","athleta","attorney","au","auction","audi","audible","audio","auspost","author","auto","autos","aw","aws","ax","axa","az","azure","ba","baby","baidu","banamex","band","bank","bar","barcelona","barclaycard","barclays","barefoot","bargains","baseball","basketball","bauhaus","bayern","bb","bbc","bbt","bbva","bcg","bcn","bd","be","beats","beauty","beer","berlin","best","bestbuy","bet","bf","bg","bh","bharti","bi","bible","bid","bike","bing","bingo","bio","biz","bj","black","blackfriday","blockbuster","blog","bloomberg","blue","bm","bms","bmw","bn","bnpparibas","bo","boats","boehringer","bofa","bom","bond","boo","book","booking","bosch","bostik","boston","bot","boutique","box","br","bradesco","bridgestone","broadway","broker","brother","brussels","bs","bt","build","builders","business","buy","buzz","bv","bw","by","bz","bzh","ca","cab","cafe","cal","call","calvinklein","cam","camera","camp","canon","capetown","capital","capitalone","car","caravan","cards","care","career","careers","cars","casa","case","cash","casino","cat","catering","catholic","cba","cbn","cbre","cc","cd","center","ceo","cern","cf","cfa","cfd","cg","ch","chanel","channel","charity","chase","chat","cheap","chintai","christmas","chrome","church","ci","cipriani","circle","cisco","citadel","citi","citic","city","ck","cl","claims","cleaning","click","clinic","clinique","clothing","cloud","club","clubmed","cm","cn","co","coach","codes","coffee","college","cologne","com","commbank","community","company","compare","computer","comsec","condos","construction","consulting","contact","contractors","cooking","cool","coop","corsica","country","coupon","coupons","courses","cpa","cr","credit","creditcard","creditunion","cricket","crown","crs","cruise","cruises","cu","cuisinella","cv","cw","cx","cy","cymru","cyou","cz","dad","dance","data","date","dating","datsun","day","dclk","dds","de","deal","dealer","deals","degree","delivery","dell","deloitte","delta","democrat","dental","dentist","desi","design","dev","dhl","diamonds","diet","digital","direct","directory","discount","discover","dish","diy","dj","dk","dm","dnp","do","docs","doctor","dog","domains","dot","download","drive","dtv","dubai","dupont","durban","dvag","dvr","dz","earth","eat","ec","eco","edeka","edu","education","ee","eg","email","emerck","energy","engineer","engineering","enterprises","epson","equipment","er","ericsson","erni","es","esq","estate","et","eu","eurovision","eus","events","exchange","expert","exposed","express","extraspace","fage","fail","fairwinds","faith","family","fan","fans","farm","farmers","fashion","fast","fedex","feedback","ferrari","ferrero","fi","fidelity","fido","film","final","finance","financial","fire","firestone","firmdale","fish","fishing","fit","fitness","fj","fk","flickr","flights","flir","florist","flowers","fly","fm","fo","foo","food","football","ford","forex","forsale","forum","foundation","fox","fr","free","fresenius","frl","frogans","frontier","ftr","fujitsu","fun","fund","furniture","futbol","fyi","ga","gal","gallery","gallo","gallup","game","games","gap","garden","gay","gb","gbiz","gd","gdn","ge","gea","gent","genting","george","gf","gg","ggee","gh","gi","gift","gifts","gives","giving","gl","glass","gle","global","globo","gm","gmail","gmbh","gmo","gmx","gn","godaddy","gold","goldpoint","golf","goo","goodyear","goog","google","gop","got","gov","gp","gq","gr","grainger","graphics","gratis","green","gripe","grocery","group","gs","gt","gu","gucci","guge","guide","guitars","guru","gw","gy","hair","hamburg","hangout","haus","hbo","hdfc","hdfcbank","health","healthcare","help","helsinki","here","hermes","hiphop","hisamitsu","hitachi","hiv","hk","hkt","hm","hn","hockey","holdings","holiday","homedepot","homegoods","homes","homesense","honda","horse","hospital","host","hosting","hot","hotels","hotmail","house","how","hr","hsbc","ht","hu","hughes","hyatt","hyundai","ibm","icbc","ice","icu","id","ie","ieee","ifm","ikano","il","im","imamat","imdb","immo","immobilien","in","inc","industries","infiniti","info","ing","ink","institute","insurance","insure","int","international","intuit","investments","io","ipiranga","iq","ir","irish","is","ismaili","ist","istanbul","it","itau","itv","jaguar","java","jcb","je","jeep","jetzt","jewelry","jio","jll","jm","jmp","jnj","jo","jobs","joburg","jot","joy","jp","jpmorgan","jprs","juegos","juniper","kaufen","kddi","ke","kerryhotels","kerryproperties","kfh","kg","kh","ki","kia","kids","kim","kindle","kitchen","kiwi","km","kn","koeln","komatsu","kosher","kp","kpmg","kpn","kr","krd","kred","kuokgroup","kw","ky","kyoto","kz","la","lacaixa","lamborghini","lamer","land","landrover","lanxess","lasalle","lat","latino","latrobe","law","lawyer","lb","lc","lds","lease","leclerc","lefrak","legal","lego","lexus","lgbt","li","lidl","life","lifeinsurance","lifestyle","lighting","like","lilly","limited","limo","lincoln","link","live","living","lk","llc","llp","loan","loans","locker","locus","lol","london","lotte","lotto","love","lpl","lplfinancial","lr","ls","lt","ltd","ltda","lu","lundbeck","luxe","luxury","lv","ly","ma","madrid","maif","maison","makeup","man","management","mango","map","market","marketing","markets","marriott","marshalls","mattel","mba","mc","mckinsey","md","me","med","media","meet","melbourne","meme","memorial","men","menu","merckmsd","mg","mh","miami","microsoft","mil","mini","mint","mit","mitsubishi","mk","ml","mlb","mls","mm","mma","mn","mo","mobi","mobile","moda","moe","moi","mom","monash","money","monster","mormon","mortgage","moscow","moto","motorcycles","mov","movie","mp","mq","mr","ms","msd","mt","mtn","mtr","mu","museum","music","mv","mw","mx","my","mz","na","nab","nagoya","name","navy","nba","nc","ne","nec","net","netbank","netflix","network","neustar","new","news","next","nextdirect","nexus","nf","nfl","ng","ngo","nhk","ni","nico","nike","nikon","ninja","nissan","nissay","nl","no","nokia","norton","now","nowruz","nowtv","np","nr","nra","nrw","ntt","nu","nyc","nz","obi","observer","office","okinawa","olayan","olayangroup","ollo","om","omega","one","ong","onl","online","ooo","open","oracle","orange","org","organic","origins","osaka","otsuka","ott","ovh","pa","page","panasonic","paris","pars","partners","parts","party","pay","pccw","pe","pet","pf","pfizer","pg","ph","pharmacy","phd","philips","phone","photo","photography","photos","physio","pics","pictet","pictures","pid","pin","ping","pink","pioneer","pizza","pk","pl","place","play","playstation","plumbing","plus","pm","pn","pnc","pohl","poker","politie","porn","post","pr","praxi","press","prime","pro","prod","productions","prof","progressive","promo","properties","property","protection","pru","prudential","ps","pt","pub","pw","pwc","py","qa","qpon","quebec","quest","racing","radio","re","read","realestate","realtor","realty","recipes","red","redumbrella","rehab","reise","reisen","reit","reliance","ren","rent","rentals","repair","report","republican","rest","restaurant","review","reviews","rexroth","rich","richardli","ricoh","ril","rio","rip","ro","rocks","rodeo","rogers","room","rs","rsvp","ru","rugby","ruhr","run","rw","rwe","ryukyu","sa","saarland","safe","safety","sakura","sale","salon","samsclub","samsung","sandvik","sandvikcoromant","sanofi","sap","sarl","sas","save","saxo","sb","sbi","sbs","sc","scb","schaeffler","schmidt","scholarships","school","schule","schwarz","science","scot","sd","se","search","seat","secure","security","seek","select","sener","services","seven","sew","sex","sexy","sfr","sg","sh","shangrila","sharp","shell","shia","shiksha","shoes","shop","shopping","shouji","show","si","silk","sina","singles","site","sj","sk","ski","skin","sky","skype","sl","sling","sm","smart","smile","sn","sncf","so","soccer","social","softbank","software","sohu","solar","solutions","song","sony","soy","spa","space","sport","spot","sr","srl","ss","st","stada","staples","star","statebank","statefarm","stc","stcgroup","stockholm","storage","store","stream","studio","study","style","su","sucks","supplies","supply","support","surf","surgery","suzuki","sv","swatch","swiss","sx","sy","sydney","systems","sz","tab","taipei","talk","taobao","target","tatamotors","tatar","tattoo","tax","taxi","tc","tci","td","tdk","team","tech","technology","tel","temasek","tennis","teva","tf","tg","th","thd","theater","theatre","tiaa","tickets","tienda","tips","tires","tirol","tj","tjmaxx","tjx","tk","tkmaxx","tl","tm","tmall","tn","to","today","tokyo","tools","top","toray","toshiba","total","tours","town","toyota","toys","tr","trade","trading","training","travel","travelers","travelersinsurance","trust","trv","tt","tube","tui","tunes","tushu","tv","tvs","tw","tz","ua","ubank","ubs","ug","uk","unicom","university","uno","uol","ups","us","uy","uz","va","vacations","vana","vanguard","vc","ve","vegas","ventures","verisign","versicherung","vet","vg","vi","viajes","video","vig","viking","villas","vin","vip","virgin","visa","vision","viva","vivo","vlaanderen","vn","vodka","volvo","vote","voting","voto","voyage","vu","wales","walmart","walter","wang","wanggou","watch","watches","weather","weatherchannel","webcam","weber","website","wed","wedding","weibo","weir","wf","whoswho","wien","wiki","williamhill","win","windows","wine","winners","wme","wolterskluwer","woodside","work","works","world","wow","ws","wtc","wtf","xbox","xerox","xihuan","xin","xxx","xyz","yachts","yahoo","yamaxun","yandex","ye","yodobashi","yoga","yokohama","you","youtube","yt","yun","za","zappos","zara","zero","zip","zm","zone","zuerich","zw"]),Xe=100,vt=3,yt=5e3,Ce=class{constructor(){this.messages=[],this.isOpen=!0,this.unreadCount=0,this.container=document.getElementById("chat-container"),this.messageTimestamps=[],this.showedRules=!1,this.container&&(this.createUI(),this.setupWsHandlers(),this.setupInputHandlers(),this.createUserMenu(),this.createModMenu())}createUI(){this.header=this.container.querySelector("#chat-header"),this.body=this.container.querySelector("#chat-body"),this.messagesEl=this.container.querySelector("#chat-messages"),this.input=this.container.querySelector("#chat-input"),this.sendBtn=this.container.querySelector("#chat-send"),this.toggleBtn=this.container.querySelector("#chat-toggle"),this.unreadEl=this.container.querySelector("#chat-unread"),this.header.addEventListener("click",()=>this.toggle()),this.container.addEventListener("wheel",t=>{t.stopPropagation()}),this.messagesEl.addEventListener("click",t=>{let n=t.target.closest(".chat-coord-link");if(n){t.preventDefault();let s=parseInt(n.dataset.x),o=parseInt(n.dataset.y),c=50/2;!isNaN(s)&&!isNaN(o)&&i.camera&&s>=-c&&s<=c&&o>=-c&&o<=c&&i.camera.centerOn(s*250+250/2,o*250+250/2)}}),this.setupResize(),this.restoreSize()}setupResize(){let t=document.createElement("div");t.id="chat-resize-left",t.className="chat-resize-handle",this.container.appendChild(t);let n=document.createElement("div");n.id="chat-resize-top",n.className="chat-resize-handle",this.container.appendChild(n);let s=document.createElement("div");s.id="chat-resize-corner",s.className="chat-resize-handle",this.container.appendChild(s);let o=null,r=0,c=0,p=0,g=0,v=(d,u)=>{this.isOpen&&(o=u,r=d.clientX,c=d.clientY,p=this.container.offsetWidth,g=this.container.offsetHeight,document.body.style.userSelect="none",u==="left"?document.body.style.cursor="ew-resize":u==="top"?document.body.style.cursor="ns-resize":document.body.style.cursor="nwse-resize",d.preventDefault())};t.addEventListener("mousedown",d=>v(d,"left")),n.addEventListener("mousedown",d=>v(d,"top")),s.addEventListener("mousedown",d=>v(d,"corner")),document.addEventListener("mousemove",d=>{if(o){if(o==="left"||o==="corner"){let u=r-d.clientX,b=Math.min(Math.max(p+u,250),800);this.container.style.width=b+"px"}if(o==="top"||o==="corner"){let u=c-d.clientY,b=Math.min(Math.max(g+u,100),700);this.container.style.height=b+"px"}}}),document.addEventListener("mouseup",()=>{o&&(o=null,document.body.style.cursor="",document.body.style.userSelect="",this.saveSize())})}saveSize(){localStorage.setItem("chat-width",this.container.offsetWidth),localStorage.setItem("chat-height",this.container.offsetHeight)}restoreSize(){let t=localStorage.getItem("chat-width")??525;if(t){let s=parseInt(t,10);s>=250&&s<=800&&(this.container.style.width=s+"px")}let n=localStorage.getItem("chat-height")??330;if(n){let s=parseInt(n,10);s>=100&&s<=700&&(this.container.style.height=s+"px")}}createModMenu(){this.modMenu=document.createElement("div"),this.modMenu.id="chat-mod-menu",this.modMenu.hidden=!0,this.modMenu.innerHTML=`
            <div class="mod-menu-info">
                <div class="mod-menu-info-row"><span>User ID:</span> <span id="mod-menu-user-id">-</span></div>
                <div class="mod-menu-info-row"><span>IP:</span> <span id="mod-menu-ip">-</span></div>
            </div>
            <button data-action="jump">Jump to tile</button>
            <button data-action="tell">Tell...</button>
            <button data-action="reply">Reply</button>
            <button data-action="clear">Clear messages</button>
            <button data-action="mute">Mute</button>
            <button data-action="ban">Ban</button>
        `,document.body.appendChild(this.modMenu),this.modMenu.addEventListener("click",t=>{let n=t.target.dataset.action;if(!(!n||!this.modMenuTarget)){if(n==="jump")this.jumpToUserTile(this.modMenuTarget.nick);else if(n==="tell"){let s=`/tell ${this.modMenuTarget.nick} `;this.input.value=s+this.input.value,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length)}else if(n==="reply"){let s=`@${this.modMenuTarget.nick} `;this.input.value=s+this.input.value,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length)}else if(n==="clear")i.ws.sendJSON({type:"mod_action",action:"clear_messages",target:this.modMenuTarget});else if(n==="mute"){let s=prompt("Mute duration (e.g. 10m, 1h, 1d):","1d");s&&i.ws.sendJSON({type:"mod_action",action:"mute",target:this.modMenuTarget,duration:s})}else n==="ban"&&confirm(`Ban ${this.modMenuTarget.nick}? This will also delete all their tiles.`)&&i.ws.sendJSON({type:"mod_action",action:"ban",target:this.modMenuTarget});this.hideModMenu()}}),document.addEventListener("click",t=>{!this.modMenu.contains(t.target)&&!this.userMenu.contains(t.target)&&!t.target.classList.contains("chat-nick")&&(this.hideModMenu(),this.hideUserMenu())})}createUserMenu(){this.userMenu=document.createElement("div"),this.userMenu.id="chat-user-menu",this.userMenu.hidden=!0,this.userMenu.innerHTML=`
            <button data-action="jump">Jump to tile</button>
            <button data-action="tell">Tell...</button>
            <button data-action="reply">Reply</button>
        `,document.body.appendChild(this.userMenu),this.userMenu.addEventListener("click",t=>{let n=t.target.dataset.action;if(!(!n||!this.userMenuTarget)){if(n==="jump")this.jumpToUserTile(this.userMenuTarget);else if(n==="tell"){let s=`/tell ${this.userMenuTarget} `;this.input.value=s+this.input.value,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length)}else if(n==="reply"){let s=`@${this.userMenuTarget} `;this.input.value=s+this.input.value,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length)}this.hideUserMenu()}})}showUserMenu(t,n,s){this.userMenuTarget=t,this.userMenu.hidden=!1;let o=this.userMenu.getBoundingClientRect(),r=window.innerHeight,c=window.innerWidth;s+o.height>r&&(s=r-o.height-5),n+o.width>c&&(n=c-o.width-5),this.userMenu.style.left=n+"px",this.userMenu.style.top=s+"px"}hideUserMenu(){this.userMenu.hidden=!0,this.userMenuTarget=null}findUserTile(t){if(!i.plot?.tileCache)return null;for(let n in i.plot.tileCache)for(let s in i.plot.tileCache[n]){let o=i.plot.tileCache[n][s];if((typeof o=="string"?o:o?.domain??null)===t)return{x:parseInt(n),y:parseInt(s)}}return null}findTileByDomain(t){if(!i.plot?.tileCache)return null;for(let n in i.plot.tileCache)for(let s in i.plot.tileCache[n]){let o=i.plot.tileCache[n][s];if((typeof o=="string"?o:o?.domain??null)===t)return{x:parseInt(n),y:parseInt(s)}}return null}jumpToUserTile(t){if(!i.camera)return;let n=this.findUserTile(t);n&&i.camera.centerOn(n.x*250+250/2,n.y*250+250/2)}jumpToDomain(t){if(!i.camera)return!1;let n=this.findTileByDomain(t);return n?(i.camera.centerOn(n.x*250+250/2,n.y*250+250/2),!0):!1}showModMenu(t,n,s){if(t.admin||t.discord)return;this.modMenuTarget=t,this.modMenu.querySelector("#mod-menu-user-id").textContent=t.id||"-",this.modMenu.querySelector("#mod-menu-ip").textContent=t.ip||"-",this.modMenu.hidden=!1;let o=this.modMenu.getBoundingClientRect(),r=window.innerHeight,c=window.innerWidth;s+o.height>r&&(s=r-o.height-5),n+o.width>c&&(n=c-o.width-5),this.modMenu.style.left=n+"px",this.modMenu.style.top=s+"px"}hideModMenu(){this.modMenu.hidden=!0,this.modMenuTarget=null}setupWsHandlers(){let t=i.ws;t.on("chat_history",n=>{this.messages=n.messages||[],this.renderMessages(),this.showedRules||(this.showSystemMessage("Welcome to the chat! The rules are as follows:"),this.showSystemMessage("1. There is zero tolerance for NSFW conversations. Do not discuss it in chat."),this.showSystemMessage("2. Do not spam the chat."),this.showSystemMessage("3. Do not troll, be edgy, annoying, or disruptive. Be kind to others."),this.showSystemMessage("4. Keep conversations in English."),this.showSystemMessage("Punishments vary between a temporary mute and in worst case a ban (your tiles will be deleted!). Type /help for commands."),this.showedRules=!0)}),t.on("message",n=>{this.addMessage(n)}),t.on("system_message",n=>{this.showSystemMessage(n.message)}),t.on("chat_cleared",()=>{this.messages=[],this.messagesEl.innerHTML="",this.showSystemMessage("Chat has been cleared")}),t.on("clear_user_messages",n=>{this.messages=this.messages.filter(s=>s.nick!==n.nick),this.renderMessages(),(i.user?.admin||i.user?.moderator)&&this.showSystemMessage(`Messages from ${n.nick} have been cleared`)}),t.on("user_muted",n=>{this.showSystemMessage(`${n.nick} has been muted`)})}setupInputHandlers(){this.input.addEventListener("keydown",t=>{t.stopPropagation(),t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.sendMessage())}),this.input.addEventListener("keyup",t=>{t.stopPropagation()}),this.input.addEventListener("keypress",t=>{t.stopPropagation()}),this.sendBtn.addEventListener("click",()=>this.sendMessage())}toggle(){this.isOpen=!this.isOpen,this.body.hidden=!this.isOpen,this.toggleBtn.textContent=this.isOpen?"\u2212":"+",this.isOpen?(this.restoreSize(),this.unreadCount=0,this.updateUnreadBadge(),this.scrollToBottom()):this.container.style.height="auto"}addMessage(t){t.time=Date.now();let n=i.cursors?.currentNick,s=i.user?.sites?.map(o=>o.domain);if(n&&t.message){let o=/@([a-zA-Z0-9][-a-zA-Z0-9]*(?:\.[a-zA-Z0-9][-a-zA-Z0-9]*)*\.[a-zA-Z]{2,})/g,r=t.message.matchAll(o);for(let c of r)if(s.includes(c[1])){t.isPinged=!0;try{let p=new Audio("/s/ping.mp3");p.volume=.5,p.play().catch(()=>{})}catch{}break}}this.messages.push(t),this.messages.length>Xe&&this.messages.shift(),this.appendMessageEl(t),this.isOpen?this.scrollToBottom():(this.unreadCount++,this.updateUnreadBadge())}escapeHTML(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}escapeURL(t){return t.replaceAll('"',"%22").replaceAll("'","%27").replaceAll("`","%60")}escapeURLDisplay(t){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}parseMessage(t){let n=/@([a-zA-Z0-9][-a-zA-Z0-9]*(?:\.[a-zA-Z0-9][-a-zA-Z0-9]*)*\.[a-zA-Z]{2,})/g,s=[];t=t.replace(n,(d,u)=>(s.push(u),`<span class="chat-ping">@${this.escapeHTML(u)}</span>`));let o=/(?!\.)(https?:\/\/[^\s<>"']+)|(?<![/])(\b(?:[a-zA-Z0-9][-a-zA-Z0-9]*\.)+([a-zA-Z]{2,})(?:\/[^\s<>"']*)?)/g,r=250,p=50/2;t=t.replace(o,(d,u,b,T)=>{if(u){let C=u.match(/^https?:\/\/(?:www\.)?webtiles\.kicya\.net\/?#(-?\d+),(-?\d+)$/);if(C){let f=parseInt(C[1]),w=parseInt(C[2]),k=Math.floor(f/r),I=Math.floor(w/r);if(k>=-p&&k<=p&&I>=-p&&I<=p)return`<a href="#" class="chat-coord-link" data-x="${k}" data-y="${I}">${k}, ${I}</a>`}return`<a href="${this.escapeURL(u)}" target="_blank" rel="noopener noreferrer">${this.escapeURLDisplay(this.escapeURL(u))}</a>`}if(b&&gt.has(T.toLowerCase())&&!s.includes(b)){let C="https://"+b;return`<a href="${this.escapeURL(C)}" target="_blank" rel="noopener noreferrer">${this.escapeURLDisplay(b)}</a>`}return d});let g=/(-?\d+),\s*(-?\d+)/g;t=t.replace(g,(d,u,b)=>{let T=parseInt(u),C=parseInt(b);return T>=-p&&T<=p&&C>=-p&&C<=p?`<a href="#" class="chat-coord-link" data-x="${u}" data-y="${b}">${d}</a>`:d});let v=(d,u,b,T)=>`<img class="emoji" src="https://cdn.discordapp.com/emojis/${T}.${u?"gif":"png"}?v=1" alt=":${this.escapeHTML(b)}:" title=":${this.escapeHTML(b)}:" width="20">`;return t=t.replace(/&lt;(a?):([a-zA-Z0-9_~]+):(\d{1,20})&gt;/g,v),t=t.replace(/<(a?):([a-zA-Z0-9_~]+):(\d{1,20})>/g,v),t=t.replace(/\*\*([^*]+)\*\*/g,(d,u)=>`<strong>${u}</strong>`),t=t.replace(/\*([^*]+)\*/g,(d,u)=>`<em>${u}</em>`),t=t.replace(/~~([^~]+)~~/g,(d,u)=>`<s>${u}</s>`),t=t.replace(/__([^_]+)__/g,(d,u)=>`<u>${u}</u>`),t=t.replace(/\|\|([^|]+)\|\|/g,(d,u)=>`<span class="chat-spoiler">${u}</span>`),t}appendMessageEl(t){let n=document.createElement("div");n.className="chat-message",t.admin&&n.classList.add("chat-admin"),t.mod&&n.classList.add("chat-mod"),t.discord&&n.classList.add("chat-discord"),t.isPinged&&n.classList.add("chat-pinged");let s=document.createElement("span");s.className="chat-nick",s.dataset.nick=t.nick;let o=i.user?.admin||i.user?.moderator;t.discord||(s.classList.add("chat-nick-clickable"),s.addEventListener("click",d=>{d.stopPropagation(),o&&!t.admin?this.showModMenu(t,d.clientX,d.clientY):this.findUserTile(t.nick)&&this.showUserMenu(t.nick,d.clientX,d.clientY)})),t.admin?s.innerHTML='<span class="chat-admin-icon">\u2605</span> '+this.escapeHTML(t.nick)+": ":t.mod?s.innerHTML='<span class="chat-mod-icon">\u25C6</span> '+this.escapeHTML(t.nick)+": ":t.discord?s.innerHTML='<span class="chat-discord-icon">[D]</span> '+this.escapeHTML(t.nick)+": ":s.textContent=t.nick+": ";let r=document.createElement("span");r.className="chat-text",t.admin||t.mod?r.innerHTML=this.parseMessage(t.message).replace(/\n/g,"<br>"):r.innerHTML=this.parseMessage(this.escapeHTML(t.message)).replace(/\n/g,"<br>");let c=r.querySelectorAll(".emoji");for(let d of c)d.addEventListener("error",u=>{u.target.remove()});let p=r.querySelectorAll(".chat-spoiler");for(let d of p)d.addEventListener("click",u=>{u.target.closest(".chat-spoiler").classList.toggle("chat-spoiler-revealed")});let g=document.createElement("span");g.className="chat-time";let v=new Date(t.time||Date.now());for(g.textContent=v.getHours().toString().padStart(2,"0")+":"+v.getMinutes().toString().padStart(2,"0"),n.appendChild(s),n.appendChild(r),n.appendChild(g),this.messagesEl.appendChild(n);this.messagesEl.children.length>Xe;)this.messagesEl.removeChild(this.messagesEl.firstChild)}renderMessages(){this.messagesEl.innerHTML="";for(let t of this.messages)this.appendMessageEl(t);setTimeout(()=>{this.scrollToBottom(!0)},100)}scrollToBottom(t=!1){let n=this.messagesEl;(n.scrollHeight-n.scrollTop-n.clientHeight<=120||t)&&(n.scrollTop=n.scrollHeight)}updateUnreadBadge(){this.unreadCount>0?(this.unreadEl.textContent=this.unreadCount>99?"99+":this.unreadCount,this.unreadEl.hidden=!1):this.unreadEl.hidden=!0}sendMessage(){if(!i.user){this.showSystemMessage("Please login to chat");return}let t=this.input.value.trim();if(!t||t.length>500)return;let n=t.split(`
`);if(n.length>5&&(t=n.slice(0,5).join(`
`)),t==="/help"){this.showSystemMessage("Available commands:"),this.showSystemMessage("/jump [domain] - Jump to a tile by domain"),this.showSystemMessage("/jump X Y - Jump to coordinates X, Y"),this.showSystemMessage("/tell [domain] [msg] - Send a message to a specific domain"),this.input.value="";return}if(t.startsWith("/jump ")||t.startsWith("/tp ")){let s=t.split(" ").slice(1).join(" ");if(s){let o=s.match(/^(-?\d+)\s+(-?\d+)$/);if(o){let r=parseInt(o[1]),c=parseInt(o[2]),g=50/2;!isNaN(r)&&!isNaN(c)&&i.camera&&r>=-g&&r<=g&&c>=-g&&c<=g?(i.camera.centerOn(r*250+250/2,c*250+250/2),this.showSystemMessage(`Jumped to ${r}, ${c}`)):this.showSystemMessage(`Invalid coordinates. Must be between -${g} and ${g}`)}else{let r=s;this.jumpToDomain(r)?this.showSystemMessage(`Jumped to ${r}`):this.showSystemMessage(`Tile with domain "${r}" not found`)}}else this.showSystemMessage("Usage: /jump [domain] or /jump X Y");this.input.value="";return}if(!i.cursors?.currentNick){this.showSystemMessage("Select a site to chat");return}if(!t.startsWith("/")){let s=Date.now();if(this.messageTimestamps=this.messageTimestamps.filter(o=>s-o<yt),this.messageTimestamps.length>=vt)return;this.messageTimestamps.push(s)}i.ws.sendJSON({type:"message",value:t}),this.input.value=""}showSystemMessage(t){let n=document.createElement("div");n.className="chat-message chat-system",n.innerHTML=this.parseMessage(this.escapeHTML(t)).replace(/\n/g,"<br>"),this.messagesEl.appendChild(n),this.scrollToBottom()}};i.chat=new Ce;var bn=i.chat;var wt=document.getElementById("loading-text"),bt=0,Ct=setInterval(()=>{wt.innerText=`Loading${".".repeat(bt++%4)}`},200),ee=class{constructor(){this.tiles={},this.container=document.getElementById("plot"),this.worldSize=Me,this.activeTile=null,this.tileCache={},this.lockCache={},this.loaded=!1,setInterval(()=>{for(let t in this.tiles){let n=this.tiles[t];!n.rendered&&Date.now()-n.lastRender>3e4&&delete this.tiles[t]}},1e4),this.fetchTiles(),this.fetchLocks(),setInterval(()=>this.fetchLocks(),1e3*60),setInterval(()=>this.fetchTiles(),1e3*60),this.editorChannel=new BroadcastChannel("editor"),this.editorChannel.onmessage=t=>{if(t.data.type==="saved"){let{path:n,site:s}=t.data;this.refreshTile(s,n)}},this.setupWsHandlers()}setupWsHandlers(){i.ws&&(i.ws.on("refresh",t=>{if("serviceWorker"in navigator&&navigator.serviceWorker.controller){let n=null;for(let s in this.tileCache){for(let o in this.tileCache[s]){let r=this.tileCache[s][o];if((typeof r=="string"?null:r?.domain??null)===t.domain){n=typeof r=="object"&&r.updated_at?r.updated_at:Math.floor(Date.now()/1e3);break}}if(n!==null)break}navigator.serviceWorker.controller.postMessage({type:"tile-refresh",domain:t.domain,lastUpdate:n||Math.floor(Date.now()/1e3)})}setTimeout(()=>{this.refreshTile(t.domain,t.path)},500)}),i.ws.on("claim",t=>{this.tileCache[t.x]=this.tileCache[t.x]||{},this.tileCache[t.x][t.y]=typeof t.domain=="string"?{domain:t.domain,updated_at:Math.floor(Date.now()/1e3)}:t.domain;let n=this.tiles[`${t.x},${t.y}`];if(n){let s=typeof this.tileCache[t.x][t.y]=="string"?this.tileCache[t.x][t.y]:this.tileCache[t.x][t.y].domain;n.setDomain(s)}}),i.ws.on("free",t=>{this.tileCache[t.x]&&delete this.tileCache[t.x][t.y];let n=this.tiles[`${t.x},${t.y}`];n&&n.setFree()}),i.ws.on("lock",t=>{t.locked?this.lockCache[t.x+","+t.y]=!0:delete this.lockCache[t.x+","+t.y];let n=this.tiles[`${t.x},${t.y}`];n&&n.setLocked(t.locked)}),i.ws.on("user_count",t=>{let n=document.getElementById("user-count");n&&(n.textContent=`${t.count} online`)}),i.ws.on("clan_invite",t=>{t.invite&&(i.ui.pendingClanInvites.find(s=>s.id===t.invite.id)||(i.ui.pendingClanInvites.push({id:t.invite.id,clan_id:t.invite.clan_id,clan_name:t.invite.clan_name}),i.ui.updateClanIndicator()))}))}refreshTile(t,n){if("serviceWorker"in navigator&&navigator.serviceWorker.controller){let s=null;for(let o in this.tileCache){for(let r in this.tileCache[o]){let c=this.tileCache[o][r];if((typeof c=="string"?null:c?.domain??null)===t){s=typeof c=="object"&&c.updated_at?c.updated_at:Math.floor(Date.now()/1e3);break}}if(s!==null)break}navigator.serviceWorker.controller.postMessage({type:"tile-refresh",domain:t,lastUpdate:s||Math.floor(Date.now()/1e3)})}for(let s in this.tiles){let o=this.tiles[s];if(o.domain===t&&o.path===n){if(o.active)break;o.fetchContent(o.path,!0);break}}}addTile(t){this.tiles[`${t.x},${t.y}`]=t}getTile(t,n){if(t>this.worldSize/2||t<-this.worldSize/2||n>this.worldSize/2||n<-this.worldSize/2)return null;if(!this.tiles[`${t},${n}`]){let s=this.tileCache?.[t]?.[n],o=typeof s=="string"?s:s?.domain??null;this.tiles[`${t},${n}`]=new $({x:t,y:n,domain:o??null})}return this.tiles[`${t},${n}`]}removeTile(t){t.unrender(),delete this.tiles[`${t.x},${t.y}`]}clear(){Object.values(this.tiles).forEach(t=>t.unrender()),this.tiles={}}async fetchTiles(){if(this.tileCache=(await i.api.makeRequest("/api/tiles").then(t=>t.json())).tiles,"serviceWorker"in navigator&&navigator.serviceWorker.controller){let t={};for(let n in this.tileCache)for(let s in this.tileCache[n]){let o=this.tileCache[n][s];typeof o=="object"&&o.domain&&o.updated_at&&(t[o.domain]=o.updated_at.toString())}Object.keys(t).length>0&&navigator.serviceWorker.controller.postMessage({type:"tile-updates",updates:t})}for(let t in this.tileCache)for(let n in this.tileCache[t]){let s=this.tileCache[t][n],o=typeof s=="string"?s:s?.domain??null,r=this.tiles[`${t},${n}`];r&&r.domain!==o&&r.setDomain(o)}this.loaded||(setTimeout(()=>{if(location.hash.startsWith("#")&&location.hash.includes(".")){let t=location.hash.slice(1);for(let n in this.tileCache)for(let s in this.tileCache[n]){let o=this.tileCache[n][s];if((typeof o=="string"?o:o?.domain??null)===t){i.camera.centerOn(parseInt(n)*250+250/2,parseInt(s)*250+250/2);let c=window.location.href.split("#")[0];window.history.replaceState({},"",c);return}}}},100),setTimeout(()=>{this.loaded=!0;let t=document.getElementById("loading"),n=document.getElementById("app");t.hidden=!0,n.hidden=!1,clearInterval(Ct)},300))}async fetchLocks(){this.lockCache=(await i.api.makeRequest("/api/locks").then(t=>t.json())).locks;for(let t in this.lockCache){let n=this.tiles[t];n&&n.element&&n.setLocked(!0)}}};i.plot=new ee;var Et=document.getElementById("plot"),te=class{constructor(){if(this.x=0,this.y=0,this.zoom=1,this.width=window.innerWidth,this.height=window.innerHeight,this.renderedTiles=new Set,this.centerOn(100,100),location.hash.startsWith("#")&&location.hash.includes(","))try{let[u,b]=location.hash.slice(1).split(",");this.centerOn(parseInt(u),parseInt(b));let T=window.location.href.split("#")[0];window.history.replaceState({},"",T)}catch{}let t=0,n=0;setInterval(()=>{let u=this.x+this.width/2,b=this.y+this.height/2;(u!=t||b!=n)&&(t=u,n=b)},1e3),window.addEventListener("resize",()=>{this.width=window.innerWidth,this.height=window.innerHeight,this.renderTilesInView()});let s=0;this.zoomEnabled=!0,this.wheelHandler=u=>{if(!this.zoomEnabled||u.target.closest(".tile.active"))return;u.preventDefault();let b=u.deltaY;if(Math.abs(b)>1&&Date.now()-s>100){let C=W.indexOf(this.zoom)+(b>0?-1:1);if(C>=1&&C<W.length){let f=i.mouse?.x||this.width/2,w=i.mouse?.y||this.height/2;this.zoomTo(f,w,W[C]),s=Date.now()}}},window.addEventListener("wheel",this.wheelHandler,{passive:!1});let o=0,r={x:0,y:0},c=u=>{let b=u[0].clientX-u[1].clientX,T=u[0].clientY-u[1].clientY;return Math.sqrt(b*b+T*T)},p=u=>({x:(u[0].clientX+u[1].clientX)/2,y:(u[0].clientY+u[1].clientY)/2});document.addEventListener("touchstart",u=>{u.touches.length===2&&(o=c(u.touches),r=p(u.touches))},{passive:!0}),document.addEventListener("touchmove",u=>{if(this.zoomEnabled&&u.touches.length===2){if(u.target.closest(".tile.active"))return;let b=c(u.touches),T=p(u.touches);if(o>0){let C=b/o,f=W.indexOf(this.zoom);C>1.1&&f<W.length-1?(this.zoomTo(T.x,T.y,W[f+1]),o=b):C<.9&&f>1&&(this.zoomTo(T.x,T.y,W[f-1]),o=b)}r=T,u.preventDefault()}},{passive:!1}),document.addEventListener("touchend",u=>{u.touches.length<2&&(o=0)}),this.keysPressed={ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1},this.moveSpeed=5;let g=u=>{u.key in this.keysPressed&&(u.preventDefault(),this.keysPressed[u.key]=!0)},v=u=>{u.key in this.keysPressed&&(u.preventDefault(),this.keysPressed[u.key]=!1)};window.addEventListener("keydown",g),window.addEventListener("keyup",v);let d=()=>{if(!i.plot?.activeTile){let u=0,b=0;this.keysPressed.ArrowLeft&&(u-=this.moveSpeed),this.keysPressed.ArrowRight&&(u+=this.moveSpeed),this.keysPressed.ArrowUp&&(b-=this.moveSpeed),this.keysPressed.ArrowDown&&(b+=this.moveSpeed),(u!==0||b!==0)&&this.move(this.x+u,this.y+b)}requestAnimationFrame(d)};d()}move(t,n){this.x=Math.round(t),this.y=Math.round(n),this.updatePlotTransform(),this.renderTilesInView()}updatePlotTransform(){Et.style.transform=`translate3d(${-this.x}px, ${-this.y}px, 0) scale(${this.zoom})`}zoomTo(t,n,s){let o=(this.x+t)/this.zoom,r=(this.y+n)/this.zoom;this.zoom=s,this.x=o*this.zoom-t,this.y=r*this.zoom-n,i.ui.zoomSlider.value=this.zoom,this.move(this.x,this.y)}centerOn(t,n){let s=t*this.zoom-this.width/2,o=n*this.zoom-this.height/2;this.move(s,o)}*getTilesInView(){let t=$.toTilePosition((this.x-250*this.zoom)/this.zoom,(this.y-250*this.zoom)/this.zoom),n=$.toTilePosition((this.x+250*this.zoom+this.width)/this.zoom,(this.y+250*this.zoom+this.height)/this.zoom);for(let s=t.x;s<n.x;s++)for(let o=t.y;o<n.y;o++){let r=i.plot.getTile(s,o);r&&(yield r)}}*getTilesInViewWithBuffer(t=500){let n=$.toTilePosition((this.x-250*this.zoom-t)/this.zoom,(this.y-250*this.zoom-t)/this.zoom),s=$.toTilePosition((this.x+250*this.zoom+this.width+t)/this.zoom,(this.y+250*this.zoom+this.height+t)/this.zoom);for(let o=n.x;o<s.x;o++)for(let r=n.y;r<s.y;r++){let c=i.plot.getTile(o,r);c&&(yield c)}}isTileWithinBuffer(t,n=500){let s=t.x*250,o=t.y*250,r=250,c=this.x/this.zoom,p=(this.x+this.width)/this.zoom,g=this.y/this.zoom,v=(this.y+this.height)/this.zoom,d=s+r,u=o+r,b=n/this.zoom,T=0;d<c?T=c-d:s>p&&(T=s-p);let C=0;return u<g?C=g-u:o>v&&(C=o-v),Math.sqrt(T*T+C*C)<=b}renderTilesInView(){let t=new Set,n=260;for(let s of this.getTilesInViewWithBuffer(n))s.render(),t.add(s);if(this.renderedTiles)for(let s of this.renderedTiles)t.has(s)||(this.isTileWithinBuffer(s,n)?t.add(s):s.unrender());this.renderedTiles=t}setZoomEnabled(t){this.zoomEnabled=t}};i.camera=new te;var ne=class{constructor(){this.x=0,this.y=0,this.worldX=0,this.worldY=0,this.tileX=0,this.tileY=0,this.down=!1;let t=0,n=0,s=0,o=0,r=0,c=(v,d,u)=>{if(!u.closest("#plot")||u.closest(".tile-info, .tile-admin-panel, .tile-vote-menu"))return!1;let b=i.plot.getTile(this.tileX,this.tileY);return i.plot.activeTile&&i.plot.activeTile.id===b.id?!1:(this.down=!0,s=v,o=d,t=i.camera.x,n=i.camera.y,r=Date.now(),!0)},p=()=>{if(!this.down)return;this.down=!1;let v=Math.abs(this.x-s),d=Math.abs(this.y-o);Date.now()-r<400&&v<10&&d<10&&i.plot.getTile(this.tileX,this.tileY).setActive(!0)},g=(v,d)=>{this.x=v,this.y=d;let u=i.camera;this.worldX=(u.x+this.x)/u.zoom,this.worldY=(u.y+this.y)/u.zoom;let b=$.toTilePosition(this.worldX,this.worldY);if(this.tileX=b.x,this.tileY=b.y,i.ui.coords.textContent=`${this.tileX}, ${this.tileY}`,document.documentElement.style.setProperty("--coords-width",i.ui.coords.offsetWidth+"px"),this.down){let T=this.x-s,C=this.y-o;u.move(t-T,n-C)}};document.addEventListener("mousedown",v=>{c(v.clientX,v.clientY,v.target)&&v.preventDefault()}),document.addEventListener("mouseup",v=>{p()}),document.addEventListener("mousemove",v=>{g(v.clientX,v.clientY)}),document.addEventListener("touchstart",v=>{if(v.touches.length===1){let d=v.touches[0];c(d.clientX,d.clientY,d.target)}},{passive:!0}),document.addEventListener("touchend",v=>{p()}),document.addEventListener("touchcancel",v=>{this.down=!1}),document.addEventListener("touchmove",v=>{if(v.touches.length===1){let d=v.touches[0];g(d.clientX,d.clientY),this.down&&d.target.closest("#plot")&&!d.target.closest(".tile.active")&&v.preventDefault()}},{passive:!1})}};i.mouse=new ne;var Tt=document.getElementById("plot"),kt=document.getElementById("dashboard-modal"),xt="/s/img/cursor.png",St=150,Pt=50,It=100,Lt=100,Ee=150,Ze=500,Je=.6,Te=class{constructor(){this.cursors=new Map,this.lastPositionSent=0,this.currentNick=null,this.mouseWorldX=0,this.mouseWorldY=0,this.setupWsHandlers(),this.setupMouseTracking(),this.setupSiteChangeListener(),this.setupMiddleClick(),this.setupViewportChangeListener()}setupWsHandlers(){let t=i.ws;t.on("open",()=>{this.sendNickIfSelected()}),t.on("close",()=>{this.clearAllCursors()}),t.on("cursors",n=>{for(let s of n.cursors)this.addCursor(s.id,s.nick,s.x,s.y)}),t.on("join",n=>{this.addCursor(n.id,n.nick,0,0)}),t.on("leave",n=>{this.removeCursor(n.id)}),t.onBinary(n=>{let s=new Int32Array(n);if(s.length>=3){let o=s[0],r=s[1],c=s[2];this.updateCursorPosition(o,r,c)}})}addCursor(t,n,s,o){if(n===this.currentNick)return;if(this.cursors.has(t)){this.updateCursorPosition(t,s,o);return}this.cursors.set(t,{id:t,nick:n,x:s,y:o,element:null}),this.updateElementPosition(t,s,o);let r=this.cursors.get(t);r.element&&(r.element.style.opacity=this.getCursorOpacityFromCenter())}removeCursor(t){let n=this.cursors.get(t);n&&(n.element&&n.element.parentNode&&n.element.remove(),this.cursors.delete(t))}updateCursorPosition(t,n,s){let o=this.cursors.get(t);o&&(o.x=n,o.y=s,this.updateElementPosition(t,n,s))}isCursorOnScreen(t,n){let s=i.camera;if(!s)return!0;let o=s.x/s.zoom,r=(s.x+s.width)/s.zoom,c=s.y/s.zoom,p=(s.y+s.height)/s.zoom;return t>=o&&t<=r&&n>=c&&n<=p}updateElementPosition(t,n,s){let o=this.cursors.get(t);if(!o)return;let r=this.isCursorOnScreen(n,s);if(n===0&&s===0||!r)o.element&&o.element.parentNode&&(o.element.remove(),o.element=null);else{if(!o.element||!o.element.parentNode){let c=document.createElement("div");c.className="cursor-container",c.innerHTML=`
                    <img class="cursor-image" src="${xt}" alt="cursor" />
                    <div class="cursor-nick">${this.escapeHTML(o.nick)}</div>
                `,c.style.opacity=this.getCursorOpacityFromCenter(),o.element=c,Tt.appendChild(c)}o.element.style.transform=`translate(${n}px, ${s}px)`,this.updateNickOpacity(o.element,n,s)}}updateNickOpacity(t,n,s){let o=t.querySelector(".cursor-nick");if(!o)return;let r=this.mouseWorldX-n,c=this.mouseWorldY-s,p=Math.sqrt(r*r+c*c),g=Math.max(0,1-p/St);o.style.opacity=g}updateAllNickOpacities(){for(let t of this.cursors.values())t.element&&this.updateNickOpacity(t.element,t.x,t.y)}getCursorOpacityFromCenter(){let t=this.mouseWorldX-It,n=this.mouseWorldY-Lt,s=Math.sqrt(t*t+n*n);return s<=Ee?0:s>=Ze?Je:(s-Ee)/(Ze-Ee)*Je}updateAllCursorOpacities(){let t=this.getCursorOpacityFromCenter();for(let n of this.cursors.values())n.element&&(n.element.style.opacity=t)}clearAllCursors(){for(let t of this.cursors.values())t.element&&t.element.parentNode&&t.element.remove();this.cursors.clear()}updateAllCursorVisibility(){for(let t of this.cursors.values())this.updateElementPosition(t.id,t.x,t.y)}setupMouseTracking(){document.addEventListener("mousemove",t=>{let n=i.camera;if(!n||(this.mouseWorldX=Math.round((n.x+t.clientX)/n.zoom),this.mouseWorldY=Math.round((n.y+t.clientY)/n.zoom),this.updateAllNickOpacities(),this.updateAllCursorOpacities(),this.updateAllCursorVisibility(),!i.ws.isConnected)||!this.currentNick||R.activeModal||kt?.classList.contains("active")||Date.now()-this.lastPositionSent<25)return;let s=new Int16Array(3);s[0]=this.mouseWorldX,s[1]=this.mouseWorldY,s[2]=0,i.ws.send(s.buffer),this.lastPositionSent=Date.now()})}setupSiteChangeListener(){let t=i.ui?.siteSelector;t&&t.addEventListener("change",()=>{this.sendNickIfSelected()})}setupViewportChangeListener(){window.addEventListener("resize",()=>{this.updateAllCursorVisibility()})}setupMiddleClick(){document.addEventListener("mousedown",t=>{if(t.button!==1||this.getCursorOpacityFromCenter()<.05)return;let s=this.getClosestCursor();s&&s.distance<=Pt&&(t.preventDefault(),window.open(`https://${s.cursor.nick}`,"_blank"))})}getClosestCursor(){let t=null,n=1/0;for(let s of this.cursors.values()){let o=this.mouseWorldX-s.x,r=this.mouseWorldY-s.y,c=Math.sqrt(o*o+r*r);c<n&&(n=c,t=s)}return t?{cursor:t,distance:n}:null}sendNickIfSelected(){if(!i.ws.isConnected)return;let t=i.user?.selectedSite;if(!t||!t.domain){this.currentNick=null;return}let n=t.domain;this.currentNick=n;for(let[s,o]of this.cursors.entries())o.nick===n&&this.removeCursor(s);i.ws.sendJSON({type:"nick",value:n})}escapeHTML(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}},ke=Te;if("serviceWorker"in navigator){let t="sw_version",n=async()=>{try{let o=await navigator.serviceWorker.register("/sw.js");return console.log("[SW] Service Worker registered:",o.scope),o}catch(o){return console.error("[SW] Service Worker registration failed:",o),null}};(async()=>{let o=localStorage.getItem(t),r="12";if(o!==r){console.log(`[SW] Version mismatch: stored=${o}, current=${r}`);let c=await navigator.serviceWorker.getRegistrations();for(let g of c)await g.unregister(),console.log("[SW] Unregistered old service worker");let p=await caches.keys();await Promise.all(p.map(g=>{if(g.includes("webtiles"))return console.log(`[SW] Deleting cache: ${g}`),caches.delete(g)})),localStorage.setItem(t,r),await n()}else(await navigator.serviceWorker.getRegistrations()).length===0&&await n()})(),navigator.serviceWorker.ready.then(()=>{navigator.serviceWorker.controller.postMessage({type:"clear-cache"})})}i.cursors=new ke;i.user?.admin&&(window.WebTiles={...i,classes:{Tile:$,Camera:te,Plot:ee,Mouse:ne,Cursors:ke}});var xe=Date.now();async function Ge(){let t=await(await i.api.makeRequest("/s/dist/buildtime.txt")).text();return parseInt(t)}Ge().then(e=>{xe=e});var Nt=setInterval(async()=>{let e=await Ge();if(e!==xe){clearInterval(Nt),xe=e;let t=document.createElement("div");t.id="update-toast",t.innerHTML=`
            <span>A new WebTiles version is available!</span>
            <button id="refresh-btn">Refresh</button>
        `,document.body.appendChild(t),document.getElementById("refresh-btn").addEventListener("click",()=>{location.reload()})}},6e4);
